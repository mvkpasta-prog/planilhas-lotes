<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controle de Lotes ‚Äî Resumo de Retirada</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  :root{
    --primary:#2563eb; --accent:#0ea5e9; --bg:#f6fbff; --card:#fff; --text:#0f172a;
    --muted:#6b7280; --success:#10b981; --warning:#f59e0b;
    --status-carregado: #10b981; /* Verde */
    --status-embarque: #3b82f6; /* Azul */
    --status-transito: #ef4444; /* Vermelho */
    --status-contratar: #f97316; /* Laranja */
    --produto-soja: #10b981; /* Verde para Soja */
    --produto-milho: #fbbf24; /* Amarelo para Milho */
    --produto-sorgo: #6b7280; /* Cinza para Sorgo */
    --produto-total: #8b5cf6; /* Roxo para Total */
  }
  *{box-sizing:border-box}
  body{font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;margin:0;background:var(--bg);color:var(--text);padding:12px}
  /* NOVO: Estilo do Logo MVK como Background/Watermark */
  body::before {
    content: '';
    position: fixed; /* Fixar no viewport */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('https://raw.githubusercontent.com/mvkpasta-prog/planilhas-lotes/main/mvklogo.png');
    background-repeat: no-repeat;
    background-position: center center;
    background-size: 80vh; /* Ocupa 80% da altura do viewport */
    opacity: 0.05; /* N√≠vel de transpar√™ncia para efeito sutil de marca d'√°gua */
    z-index: -1; /* Garantir que fique atr√°s do conte√∫do */
    pointer-events: none; /* Permite interagir com o conte√∫do por baixo */
  }
  header{
    background:linear-gradient(90deg,var(--primary),var(--accent));
    color:white;
    padding:12px;
    border-radius:8px;
    margin-bottom:16px;
    text-align:center;
    font-weight:700;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    position: relative;
  }
  .header-title {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .last-update-top {
    font-size: 12px;
    color: rgba(255,255,255,0.9);
    display: flex;
    align-items:center;
    gap: 6px;
  }
  .wrap{max-width:1400px;margin:0 auto;width:100%}
  /* Se√ß√£o para o bot√£o de voltar */
  .actions{display:flex;justify-content:flex-start;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px}
  .btn{background:var(--primary);color:#fff;border:0;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:700;font-size:14px; text-decoration: none; display: flex; align-items: center; gap: 6px;}
  .btn:hover{opacity:.95}
  /* Cards de Status no topo - vers√£o compacta (ligeiramente menores) */
  .status-cards{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px}
  .status-card{background:var(--card);border-radius:8px;padding:10px;box-shadow:0 3px 8px rgba(0,0,0,0.06);flex:1;min-width:150px;text-align:center;transition:all 0.3s ease}
  .status-card:hover{transform:translateY(-2px);box-shadow:0 5px 12px rgba(0,0,0,0.08)}
  .status-card h3{margin:0 0 6px 0;font-size:14px;color:var(--text);font-weight:600}
  .status-card .count{font-size:22px;font-weight:700;margin:6px 0}
  .status-card-carregado{border-top:3px solid var(--status-carregado);}
  .status-card-embarque{border-top:3px solid var(--status-embarque);}
  .status-card-transito{border-top:3px solid var(--status-transito);}
  .status-card-contratar{border-top:3px solid var(--status-contratar);}
  /* Cards de Produtos - vers√£o compacta (ligeiramente menores) */
  .produto-cards{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px}
  .produto-card{background:var(--card);border-radius:8px;padding:8px;box-shadow:0 3px 8px rgba(0,0,0,0.06);flex:1;min-width:140px;text-align:center;transition:all 0.3s ease;border-top:3px solid transparent; cursor: pointer;} /* Adicionado cursor: pointer; */
  .produto-card:hover{transform:translateY(-2px);box-shadow:0 5px 12px rgba(0,0,0,0.08)}
  .produto-card h3{margin:0 0 4px 0;font-size:13px;color:var(--text);font-weight:600}
  .produto-card .count{font-size:18px;font-weight:700;margin:4px 0}
  .produto-soja{border-top-color: var(--produto-soja);}
  .produto-milho{border-top-color: var(--produto-milho);}
  .produto-sorgo{border-top-color: var(--produto-sorgo);}
  .produto-total{border-top-color: var(--produto-total);}
  /* Se√ß√£o de Clientes e Destinos */
  .clientes-section{margin-bottom:24px}
  .clientes-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-bottom:24px}
  .cliente-card{background:var(--card);border-radius:8px;padding:14px;box-shadow:0 3px 8px rgba(0,0,0,0.06);transition:all 0.3s ease; cursor: pointer;} /* Adicionado cursor: pointer */
  .cliente-card:hover{transform:translateY(-2px);box-shadow:0 5px 12px rgba(0,0,0,0.08)}
  .cliente-name{font-weight:700;font-size:16px;color:var(--text);margin:0 0 6px 0}
  .cliente-destino{font-weight:600;color:var(--accent);margin:0 0 10px 0;font-size:13px}
  .cliente-info{display:flex;justify-content:space-between;margin-bottom:6px;align-items:center}
  .info-label{font-weight:600;color:var(--muted);font-size:12px}
  .info-value{font-weight:700;font-size:13px}
  .cliente-produto{padding:3px 7px;border-radius:5px;font-size:11px;font-weight:600;display:inline-block;margin-top:4px}
  .status-carregado-tag{background-color: var(--status-carregado);color: white;padding: 2px 7px;border-radius: 10px;font-size: 11px;font-weight: 600;}
  .status-pendente-tag{background-color: var(--status-embarque);color: white;padding: 2px 7px;border-radius: 10px;font-size: 11px;font-weight: 600;}
  /* NOVO: Estilo para Modal/Popup */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: none; /* Inicia oculto */
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .modal-content {
    background: var(--card);
    padding: 20px;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    position: relative;
    max-height: 90vh;
    overflow-y: auto;
  }
  .modal-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--muted);
  }
  .modal-header h3 {
      margin-top: 0;
      font-size: 18px;
      color: var(--primary);
      border-bottom: 2px solid var(--accent);
      padding-bottom: 8px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
  }
  .modal-body p {
      margin: 5px 0;
      font-size: 14px;
  }
  .modal-body .info-label {
      font-weight: 600;
      color: var(--text);
      display: inline-block;
      min-width: 180px; /* Aumentado para melhor alinhamento */
  }
  .modal-body .info-value {
      font-weight: 400;
      color: var(--muted);
  }
  .modal-clientes-list {
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px dashed #ddd;
  }
  .modal-clientes-list h4 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--accent);
  }
  .modal-clientes-list span {
      display: block;
      padding: 3px 0;
      font-size: 13px;
      color: var(--text);
  }
  h2{color:var(--primary);margin:6px 0 12px 0;font-size:18px}
  @media (max-width:900px){
    .clientes-container{grid-template-columns:1fr}
    .cliente-card{min-width:260px}
  }
  @media (max-width:600px){
    body{padding:8px}
    .cliente-card{min-width:100%;padding:12px}
    .status-card{min-width:140px;padding:10px}
    .produto-card{min-width:130px;padding:8px}
  }
</style>
</head>
<body>
  <header>
    <div class="header-title">
      <img src="https://raw.githubusercontent.com/mvkpasta-prog/planilhas-lotes/main/mvklogo.png" alt="Logo MVK" style="height: 22px; vertical-align: middle; margin-right: 8px;">
      Controle de Lotes ‚Äî Resumo de Retirada
    </div>
    <div class="last-update-top" id="lastUpdateTop">
      <i class="fas fa-hourglass-half"></i> <span>Atualizando...</span>
    </div>
  </header>
  <div class="wrap">
    
    <div class="actions">
        <a href="index.html" class="btn"><i class="fas fa-arrow-left"></i> Voltar para Embarques</a>
    </div>

    <div class="status-cards">
      <div class="status-card status-card-carregado">
        <h3>RETIRADA ABERTA</h3>
        <div class="count" id="count-aberto">0</div>
      </div>
      <div class="status-card status-card-embarque">
        <h3>LOTE FINALIZADO</h3>
        <div class="count" id="count-finalizado">0</div>
      </div>
      <div class="status-card status-card-transito">
        <h3>CONTRATOS</h3>
        <div class="count" id="count-contratos">0</div>
      </div>
      <div class="status-card status-card-contratar">
        <h3>PRODUTOS</h3>
        <div class="count" id="count-produtos">0</div>
      </div>
    </div>
    <div class="produto-cards">
      <div class="produto-card produto-soja">
        <h3>SOJA A RETIRAR</h3>
        <div class="count" id="count-soja">0 KG</div>
      </div>
      <div class="produto-card produto-milho">
        <h3>MILHO A RETIRAR</h3>
        <div class="count" id="count-milho">0 KG</div>
      </div>
      <div class="produto-card produto-sorgo">
        <h3>SORGO A RETIRAR</H3>
        <div class="count" id="count-sorgo">0 KG</div>
      </div>
      <div class="produto-card produto-total" id="card-total-retirada">
        <h3>TOTAL A RETIRAR</h3>
        <div class="count" id="count-total">0 KG</div>
      </div>
    </div>
    
    <div class="clientes-section">
      <h2 style="margin-top: 0;">üìç Resumo por Local de Embarque</h2>
      <input type="text" id="filterInput" placeholder="Filtrar por Local de Embarque ou Cliente..." style="width: 100%; padding: 10px; margin-bottom: 16px; border: 1px solid #ccc; border-radius: 6px;">
      <div class="clientes-container" id="clientesContainer">
          </div>
    </div>
    
  </div>
  
  <div id="resumoModal" class="modal-overlay">
      <div class="modal-content">
          <button class="modal-close" onclick="closeModal()">&times;</button>
          <div id="modalContentBody">
              </div>
      </div>
  </div>

<script>
/* ====== CONFIG - coloque aqui seu SHEET_ID se mudar ====== */
const SHEET_ID = '1o0wF2ScSkyxqY8FHFI-rA6k_3uMI2wsZr2wQG8JD4B4';
const GIDS = {
  retirada: '1984691910'   // aba LOTES RETIRADA (o √∫nico foco)
};
// Configura√ß√£o do intervalo de atualiza√ß√£o autom√°tica (em milissegundos)
const AUTO_UPDATE_INTERVAL = 300000;
/* colunas removidas (normalizadas) de todas as tabelas (mantidas para groupBy) */
const REMOVED_COMMON = ['localizacao','idorigemymvk1', 'numero_contrato', 'safra', 'royalties']; 

/* Vari√°vel global para armazenar os totais de produto para o resumo */
let globalProdutosTotais = { soja: 0, milho: 0, sorgo: 0, total: 0 };

/* Vari√°vel global para armazenar o resumo por local para filtro e modal */
let globalResumoLocal = [];

/* --- FUN√á√ïES UTILIT√ÅRIAS MANTIDAS --- */

/* Normaliza cabe√ßalho: remove acento, espa√ßos e pontua√ß√£o */
function normalizeHeader(h){
  if(h === undefined || h === null) return '';
  return String(h).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,'');
}
/* Normaliza texto: remove acentos ‚Äî reutiliz√°vel para status e filtro */
function normalizeText(text) {
  if(text === undefined || text === null) return '';
  return String(text).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
}
/* Parse CSV tolerante (trata v√≠rgulas dentro de aspas) */
function parseCSV(text){
  if(!text) return {arrays:[], headersOrig:[], headersNorm:[], objects:[]};
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
  if(lines.length === 0) return {arrays:[], headersOrig:[], headersNorm:[], objects:[]};
  const parsed = lines.map(line => line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"|"$/g,'').trim()));
  const headersOrig = parsed.shift().map(h => h||'');
  const headersNorm = headersOrig.map(h => normalizeHeader(h));
  const objects = parsed.map(cells => {
    const obj = {};
    headersNorm.forEach((key, idx) => {
      obj[key] = cells[idx] !== undefined ? cells[idx] : '';
    });
    return obj;
  });
  return {arrays: parsed, headersOrig, headersNorm, objects};
}
/* fetch CSV via gviz - retorna parseCSV result */
async function fetchSheetByGid(gid){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('Erro ao buscar planilha: ' + r.status);
  const text = await r.text();
  return parseCSV(text);
}
/* util: parse number tolerant */
function parseNumber(val){
  if(val === undefined || val === null) return NaN;
  const s = String(val).replace(/\s/g,'').replace(/\./g,'').replace(/,/g,'.');
  const n = parseFloat(s.replace(/[^\d\.\-]/g,''));
  return isNaN(n) ? NaN : n;
}
/* Formata n√∫mero com separadores de milhar */
function formatNumber(value) {
  if(isNaN(value)) return '0';
  return new Intl.NumberFormat('pt-BR').format(Math.round(value));
}
function escapeHtml(s){
  if(s === undefined || s === null) return '';
  return String(s).replace(/[&<>"'\/]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#x2F;'}[c]));
}

/* Extrair produto do texto (√∫ltima parte ap√≥s o √∫ltimo tra√ßo) */
function extractProduto(text) {
  if(!text) return '';
  return normalizeText(text); // Agora apenas normalizamos para facilitar a compara√ß√£o
}

/* --- FUN√á√ÉO: Agrupar por Local de Embarque --- */
async function groupByLocalEmbarque(rowsArrRet, headersNormRet) {
  const grupos = {};
  
  // Mapeamento dos √≠ndices (baseado nas colunas B, C, D, E, J)
  const contratoIndex = 1; // Coluna B
  const localIndex = 2;    // Coluna C
  const clienteIndex = 3;  // Coluna D
  const produtoIndex = 4;  // Coluna E
  const aRetirarIndex = 9; // Coluna J (Quantidade a Retirar)
  const embarcadaIndex = 8; // Coluna I (Quantidade Embarcada)
  
  // Contadores gerais (para os status cards)
  const statusContratoKey = headersNormRet.find(h => h.includes('situacao') && h.includes('contrato')) || null;
  const statusContratoIndex = headersNormRet.indexOf(statusContratoKey);
  const contratos = new Set();
  const produtos = new Set();

  rowsArrRet.forEach(arr => {
    const local = arr[localIndex] ? arr[localIndex].trim() : 'Local Desconhecido';
    const produtoText = arr[produtoIndex] ? arr[produtoIndex].trim() : '';
    const cliente = arr[clienteIndex] ? arr[clienteIndex].trim() : 'Cliente Desconhecido';
    const aRetirar = parseNumber(arr[aRetirarIndex] || '0');
    const embarcada = parseNumber(arr[embarcadaIndex] || '0');
    const contrato = arr[contratoIndex] ? arr[contratoIndex].trim() : '';
    const statusContrato = statusContratoIndex !== -1 ? (arr[statusContratoIndex] || '') : '';
    const statusNorm = normalizeText(statusContrato);

    // Contadores de status
    if(contrato) contratos.add(contrato);
    if(produtoText) produtos.add(produtoText);
    
    if(!grupos[local]) {
      grupos[local] = {
        localEmbarque: local,
        totalARetirar: 0,
        totalEmbarcada: 0,
        clientes: new Set(),
        produtos: new Set(),
        contratos: new Set(),
        aberto: 0,
        finalizado: 0
      };
    }
    
    // Agrega√ß√£o
    grupos[local].totalARetirar += aRetirar;
    grupos[local].totalEmbarcada += embarcada;
    if(cliente) grupos[local].clientes.add(cliente);
    if(produtoText) grupos[local].produtos.add(produtoText);
    if(contrato) grupos[local].contratos.add(contrato);
    
    // Contar status
    if (statusNorm.includes('aberto') || statusNorm.includes('em aberto')) {
        grupos[local].aberto++;
    } else if (statusNorm.includes('finalizado') || statusNorm.includes('fechado')) {
        grupos[local].finalizado++;
    }
  });

  const resumo = Object.values(grupos).map(grupo => ({
    ...grupo,
    totalARetirar: Math.round(grupo.totalARetirar),
    totalEmbarcada: Math.round(grupo.totalEmbarcada),
    clientes: Array.from(grupo.clientes).sort().join(', '), // Clientes como string ordenada
    produtos: Array.from(grupo.produtos).sort().join(' / '),
    totalContratos: grupo.contratos.size,
    totalAbertos: grupo.aberto,
    totalFinalizados: grupo.finalizado
  })).sort((a, b) => b.totalARetirar - a.totalARetirar);

  return { resumo, totalContratos: contratos.size, totalProdutos: produtos.size };
}

/* --- FUN√á√ÉO: Calcular Totais por Produto (Retirada) --- */
function calculateProdutosTotaisRetirada(rowsArrRet, headersNormRet) {
    let soja = 0, milho = 0, sorgo = 0;
    
    // Mapeamento dos √≠ndices (baseado nas colunas E e J)
    const produtoIndex = 4;  // Coluna E
    const aRetirarIndex = 9; // Coluna J (Quantidade a Retirar)

    rowsArrRet.forEach(arr => {
        const produtoText = arr[produtoIndex] ? arr[produtoIndex].trim() : '';
        const produtoNorm = extractProduto(produtoText);
        const aRetirar = parseNumber(arr[aRetirarIndex] || '0');
        
        if(isNaN(aRetirar)) return;
        
        // Somar ao produto correspondente
        if(produtoNorm.includes('soja')) {
          soja += aRetirar;
        } else if(produtoNorm.includes('milho')) {
          milho += aRetirar;
        } else if(produtoNorm.includes('sorgo')) {
          sorgo += aRetirar;
        }
    });
    return {soja, milho, sorgo};
}

/* Gerar HTML para os cards de resumo por Local de Embarque */
function buildResumoLocalHTML(resumos) {
  if(resumos.length === 0) {
    return '<div class="empty">Nenhum lote de retirada encontrado para o filtro.</div>';
  }
  let html = '';
  resumos.forEach((resumo, index) => { 
    // Buscar o ID correto no globalResumoLocal, pois 'index' √© apenas o √≠ndice no array filtrado
    const globalIndex = globalResumoLocal.findIndex(r => r.localEmbarque === resumo.localEmbarque && r.produtos === resumo.produtos);

    // Definir cor do produto (simples, pega o primeiro)
    let corProduto = '#6b7280'; // Cinza padr√£o
    const produtoUp = (resumo.produtos || '').toUpperCase();
    if(produtoUp.includes('SOJA')) {
      corProduto = '#10b981'; // Verde para Soja
    } else if(produtoUp.includes('MILHO')) {
      corProduto = '#fbbf24'; // Amarelo para Milho
    } else if(produtoUp.includes('SORGO')) {
      corProduto = '#6b7280'; // Cinza para Sorgo
    }
    
    // O onclick usa o index no array global (globalIndex)
    html += `
      <div class="cliente-card" onclick="openResumoModal(${globalIndex})">
        <h3 class="cliente-name">${escapeHtml(resumo.localEmbarque)}</h3>
        <div class="cliente-contrato">
            <span class="cliente-produto" style="background-color: ${corProduto}; color: white; margin-left: 0;">${escapeHtml(resumo.produtos)}</span>
        </div>
        <div class="cliente-info" style="margin-top: 12px;">
          <span class="info-label">Contratos Abertos:</span>
          <span class="info-value status-pendente-tag">${resumo.totalAbertos}</span>
        </div>
        <div class="cliente-info" style="margin-top: 6px;">
          <span class="info-label">Contratos Finalizados:</span>
          <span class="info-value status-carregado-tag">${resumo.totalFinalizados}</span>
        </div>
        <div class="cliente-info" style="margin-top: 12px; border-top: 1px solid #eee; padding-top: 8px;">
          <span class="info-label">Total a Retirar:</span>
          <span class="info-value">${formatNumber(resumo.totalARetirar)} KG</span>
        </div>
        <div class="cliente-info" style="margin-top: 6px;">
          <span class="info-label">Total Embarcado:</span>
          <span class="info-value">${formatNumber(resumo.totalEmbarcada)} KG</span>
        </div>
      </div>
    `;
  });
  return html;
}

/* Fun√ß√£o para abrir o modal de detalhes do Local de Embarque */
function openResumoModal(index) {
    const resumo = globalResumoLocal[index];
    if (!resumo) return;

    const modal = document.getElementById('resumoModal');
    const modalContent = document.getElementById('modalContentBody');
    
    // Formatando a lista de clientes para o modal
    const clientesArray = resumo.clientes.split(', ').filter(c => c.trim() !== 'Cliente Desconhecido' && c.trim() !== '');
    const clientesList = clientesArray.map(c => `<span>${escapeHtml(c)}</span>`).join('');
    
    // Definir cor do produto (simples, pega o primeiro)
    let corProduto = '#6b7280'; // Cinza padr√£o
    const produtoUp = (resumo.produtos || '').toUpperCase();
    if(produtoUp.includes('SOJA')) {
      corProduto = '#10b981'; // Verde para Soja
    } else if(produtoUp.includes('MILHO')) {
      corProduto = '#fbbf24'; // Amarelo para Milho
    } else if(produtoUp.includes('SORGO')) {
      corProduto = '#6b7280'; // Cinza para Sorgo
    }

    modalContent.innerHTML = `
        <div class="modal-header">
            <h3>${escapeHtml(resumo.localEmbarque)} <span class="cliente-produto" style="background-color: ${corProduto}; color: white; margin-left: 8px; padding: 4px 8px; border-radius: 5px; font-size: 11px;">${escapeHtml(resumo.produtos)}</span></h3>
        </div>
        <div class="modal-body">
            <p><span class="info-label">Contratos (Total no local):</span> <span class="info-value">${resumo.totalContratos}</span></p>
            <p><span class="info-label">Contratos Abertos:</span> <span class="info-value status-pendente-tag">${resumo.totalAbertos}</span></p>
            <p><span class="info-label">Contratos Finalizados:</span> <span class="info-value status-carregado-tag">${resumo.totalFinalizados}</span></p>
            
            <p style="margin-top: 15px;"><span class="info-label">Total a Retirar:</span> <span class="info-value">${formatNumber(resumo.totalARetirar)} KG</span></p>
            <p><span class="info-label">Total Embarcado:</span> <span class="info-value">${formatNumber(resumo.totalEmbarcada)} KG</span></p>
            
            <div class="modal-clientes-list">
                <h4>Clientes Envolvidos (${clientesArray.length}):</h4>
                ${clientesList || '<span>Nenhum cliente espec√≠fico encontrado.</span>'}
            </div>
        </div>
    `;

    modal.style.display = 'flex';
}

function closeModal() {
    document.getElementById('resumoModal').style.display = 'none';
}

// Configurar fechamento ao clicar fora ou na tecla ESC
function setupModalCloseHandlers() {
    const modal = document.getElementById('resumoModal');
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
            closeModal();
        }
    });
}

/* Fun√ß√£o de filtro: Local de Embarque OU Cliente */
function filterCards() {
    const filterText = normalizeText(document.getElementById('filterInput').value).trim();
    const container = document.getElementById('clientesContainer');
    
    if (filterText.length < 2) {
        // Se o filtro for muito curto, mostra todos os cards
        container.innerHTML = buildResumoLocalHTML(globalResumoLocal);
        return;
    }
    
    const filteredResumos = globalResumoLocal.filter(resumo => {
        const localNorm = normalizeText(resumo.localEmbarque);
        const clientesNorm = normalizeText(resumo.clientes); // Clientes j√° est√° em string separada por v√≠rgula

        // Verifica se o texto do filtro est√° no Local de Embarque ou na lista de Clientes
        return localNorm.includes(filterText) || clientesNorm.includes(filterText);
    });
    
    container.innerHTML = buildResumoLocalHTML(filteredResumos);
}

/* Atualizar o texto da √∫ltima atualiza√ß√£o (no topo) */
function updateLastUpdateTime() {
  const now = new Date();
  const timeString = now.toLocaleTimeString('pt-BR');
  const dateString = now.toLocaleDateString('pt-BR');
  document.getElementById('lastUpdateTop').innerHTML = `
    <i class="fas fa-check-circle" style="color: rgba(255,255,255,0.9);"></i>
    <span>√öltima atualiza√ß√£o: ${timeString} - ${dateString}</span>
  `;
}

/* --- Main load function --- */
async function loadAll(isAutoUpdate = false){
  try{
    if(isAutoUpdate) {
      document.getElementById('lastUpdateTop').innerHTML = `
        <i class="fas fa-hourglass-half" style="color: rgba(255,255,255,0.9);"></i>
        <span>Atualizando...</span>
      `;
      document.body.classList.add('updating');
    }
    
    // ===== LOTES DE RETIRADA (FOCO √öNICO) =====
    const ret = await fetchSheetByGid(GIDS.retirada);
    const rowsArrRet = ret.arrays;
    const headersNormRet = ret.headersNorm;
    const objsRet = ret.objects;
    
    // Filtrar apenas linhas com saldo > 0 (Apenas para o c√°lculo de produto a retirar)
    const saldoKeyRet = headersNormRet.find(h => h.includes('quantidadearetirar')) || headersNormRet[9] || null; // Coluna J
    const rowsObjRetFiltered = [];
    const rowsArrRetFiltered = [];
    
    for(let i=0;i<rowsArrRet.length;i++){
      const arr = rowsArrRet[i];
      const obj = objsRet[i] || {};
      
      let saldoVal = '';
      const saldoIndex = headersNormRet.indexOf(saldoKeyRet);
      
      if(saldoKeyRet && obj[saldoKeyRet] !== undefined && obj[saldoKeyRet] !== '') saldoVal = obj[saldoKeyRet];
      else if(saldoIndex !== -1 && arr[saldoIndex] !== undefined) saldoVal = arr[saldoIndex];
      
      const n = parseNumber(saldoVal || '0');
      if(!isNaN(n) && n > 0){
        rowsObjRetFiltered.push(obj);
        rowsArrRetFiltered.push(arr);
      }
    }

    // ===== RESUMO POR LOCAL DE EMBARQUE =====
    // O groupBy usa TODAS as linhas para contar abertos/fechados e total de contratos.
    const { resumo: resumoLocal, totalContratos, totalProdutos } = await groupByLocalEmbarque(rowsArrRet, headersNormRet);
    
    // Armazenar globalmente para filtro (apenas os resumos com saldo a retirar > 0)
    globalResumoLocal = resumoLocal
        .filter(r => r.totalARetirar > 0)
        .sort((a, b) => b.totalARetirar - a.totalARetirar)
        .map((r, i) => ({ ...r, id: i })); 
    
    // Gerar HTML, aplicando o filtro caso haja texto no campo
    const filterText = normalizeText(document.getElementById('filterInput').value).trim();
    if(filterText.length >= 2) {
        filterCards(); // Re-aplica o filtro
    } else {
        document.getElementById('clientesContainer').innerHTML = buildResumoLocalHTML(globalResumoLocal);
    }
    
    // ===== CONTADORES E TOTAIS DE PRODUTO =====
    
    // Totais de Status (Aberto/Finalizado)
    const situacaoContratoKey = headersNormRet.find(h => h.includes('situacaocontrato')) || 'situacaocontrato';
    const totalAberto = rowsArrRet.filter(arr => {
        const situacaoContrato = arr[headersNormRet.indexOf(situacaoContratoKey)] || '';
        const situacaoNorm = normalizeText(situacaoContrato);
        return situacaoNorm.includes('aberto') || situacaoNorm.includes('em aberto');
    }).length;
    const totalFinalizado = rowsArrRet.filter(arr => {
        const situacaoContrato = arr[headersNormRet.indexOf(situacaoContratoKey)] || '';
        const situacaoNorm = normalizeText(situacaoContrato);
        return situacaoNorm.includes('finalizado') || situacaoNorm.includes('fechado');
    }).length;

    document.getElementById('count-aberto').textContent = totalAberto;
    document.getElementById('count-finalizado').textContent = totalFinalizado;
    document.getElementById('count-contratos').textContent = totalContratos;
    document.getElementById('count-produtos').textContent = totalProdutos;

    // Calcular totais por produto (usando o array FILTRADO por saldo > 0)
    const produtosTotais = calculateProdutosTotaisRetirada(rowsArrRetFiltered, headersNormRet);
    
    globalProdutosTotais.soja = produtosTotais.soja;
    globalProdutosTotais.milho = produtosTotais.milho;
    globalProdutosTotais.sorgo = produtosTotais.sorgo;
    
    const totalARetirar = produtosTotais.soja + produtosTotais.milho + produtosTotais.sorgo;
    globalProdutosTotais.total = totalARetirar;
    
    // Atualizar cards de produto com "KG" ao lado
    document.getElementById('count-soja').textContent = `${formatNumber(produtosTotais.soja)} KG`;
    document.getElementById('count-milho').textContent = `${formatNumber(produtosTotais.milho)} KG`;
    document.getElementById('count-sorgo').textContent = `${formatNumber(produtosTotais.sorgo)} KG`;
    document.getElementById('count-total').textContent = `${formatNumber(totalARetirar)} KG`;
    
    // Atualizar o texto da √∫ltima atualiza√ß√£o
    updateLastUpdateTime();
    document.body.classList.remove('updating');
  }
  catch(err){
    console.error('Erro loadAll (P√°gina Retirada):', err);
    document.getElementById('clientesContainer').innerHTML = '<div class="empty">Erro ao carregar dados dos locais de embarque (ver console).</div>';
    document.getElementById('lastUpdateTop').innerHTML = `
      <i class="fas fa-exclamation-triangle" style="color: rgba(255,255,255,0.9);"></i>
      <span>Erro na atualiza√ß√£o</span>
    `;
    document.body.classList.remove('updating');
  }
}

/* Configurar atualiza√ß√£o autom√°tica */
let autoUpdateInterval;
function startAutoUpdate() {
  loadAll(true);
  autoUpdateInterval = setInterval(() => {
    loadAll(true);
  }, AUTO_UPDATE_INTERVAL);
}

// Handler de clique para copiar resumo (mantido como placeholder)
function handleTotalCardClick() {
    alert(`Total a Retirar: ${formatNumber(globalProdutosTotais.total)} KG. Esta fun√ß√£o pode ser personalizada.`);
}

/* init */
document.addEventListener('DOMContentLoaded', function() {
  // Adicionar handler de filtro
  document.getElementById('filterInput').addEventListener('keyup', filterCards);
  
  // Adicionar handler de clique ao card "TOTAL A RETIRAR"
  document.getElementById('card-total-retirada').addEventListener('click', handleTotalCardClick);
  
  setupModalCloseHandlers(); // NOVO: Configura fechamento do modal
  startAutoUpdate();
  // Adicionar evento de visibilidade para pausar/recuperar atualiza√ß√µes
  document.addEventListener('visibilitychange', function() {
    if(!document.hidden) {
      loadAll(true);
    }
  });
});
</script>
</body>
</html>
