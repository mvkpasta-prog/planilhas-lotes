<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controle de Lotes ‚Äî Resumo de Retirada</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  :root{
    --primary:#2563eb; --accent:#0ea5e9; --bg:#f6fbff; --card:#fff; --text:#0f172a;
    --muted:#6b7280; --success:#10b981; --warning:#f59e0b;
    --status-carregado: #10b981; /* Verde (Finalizado) */
    --status-embarque: #3b82f6; /* Azul (Aberto) */
    --status-transito: #ef4444; /* Vermelho */
    --status-contratar: #f97316; /* Laranja */
    --produto-soja: #10b981; /* Verde para Soja */
    --produto-milho: #fbbf24; /* Amarelo para Milho */
    --produto-sorgo: #6b7280; /* Cinza para Sorgo */
    --produto-total: #8b5cf6; /* Roxo para Total */
  }
  *{box-sizing:border-box}
  body{font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;margin:0;background:var(--bg);color:var(--text);padding:12px}
  /* Estilo do Logo MVK como Background/Watermark */
  body::before {
    content: '';
    position: fixed; 
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('https://raw.githubusercontent.com/mvkpasta-prog/planilhas-lotes/main/mvklogo.png');
    background-repeat: no-repeat;
    background-position: center center;
    background-size: 80vh; 
    opacity: 0.05; 
    z-index: -1; 
    pointer-events: none; 
  }
  header{
    background:linear-gradient(90deg,var(--primary),var(--accent));
    color:white;
    padding:12px;
    border-radius:8px;
    margin-bottom:16px;
    text-align:center;
    font-weight:700;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    position: relative;
    flex-wrap: wrap; 
  }
  .header-title {
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 200px;
  }
  .last-update-top {
    font-size: 12px;
    color: rgba(255,255,255,0.9);
    display: flex;
    align-items:center;
    gap: 6px;
  }
  .wrap{max-width:1400px;margin:0 auto;width:100%}
  /* Estilo para o bot√£o no header */
  .header-btn {
    background: #fff;
    color: var(--primary); 
    border: none;
    padding: 6px 10px; 
    border-radius: 6px;
    cursor: pointer;
    font-weight: 700;
    font-size: 13px; 
    text-decoration: none; 
    transition: background 0.2s ease, opacity 0.2s ease;
    white-space: nowrap; 
    display: flex; 
    align-items: center; 
    gap: 6px;
  }
  .header-btn:hover {
    background: var(--bg); 
    opacity: 0.95;
  }
  /* Cards de Status no topo */
  .status-cards{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px}
  .status-card{background:var(--card);border-radius:8px;padding:10px;box-shadow:0 3px 8px rgba(0,0,0,0.06);flex:1;min-width:150px;text-align:center;transition:all 0.3s ease}
  .status-card:hover{transform:translateY(-2px);box-shadow:0 5px 12px rgba(0,0,0,0.08)}
  .status-card h3{margin:0 0 6px 0;font-size:14px;color:var(--text);font-weight:600}
  .status-card .count{font-size:22px;font-weight:700;margin:6px 0}
  .status-card-carregado{border-top:3px solid var(--status-carregado);}
  .status-card-embarque{border-top:3px solid var(--status-embarque);}
  .status-card-transito{border-top:3px solid var(--status-transito);}
  .status-card-contratar{border-top:3px solid var(--status-contratar);}
  /* Cards de Produtos */
  .produto-cards{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px}
  .produto-card{background:var(--card);border-radius:8px;padding:8px;box-shadow:0 3px 8px rgba(0,0,0,0.06);flex:1;min-width:140px;text-align:center;transition:all 0.3s ease;border-top:3px solid transparent; cursor: pointer;}
  .produto-card:hover{transform:translateY(-2px);box-shadow:0 5px 12px rgba(0,0,0,0.08)}
  .produto-card h3{margin:0 0 4px 0;font-size:13px;color:var(--text);font-weight:600}
  .produto-card .count{font-size:18px;font-weight:700;margin:4px 0}
  .produto-soja{border-top-color: var(--produto-soja);}
  .produto-milho{border-top-color: var(--produto-milho);}
  .produto-sorgo{border-top-color: var(--produto-sorgo);}
  .produto-total{border-top-color: var(--produto-total);}
  /* Se√ß√£o de Clientes e Destinos */
  .clientes-section{margin-bottom:24px}
  .clientes-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-bottom:24px}
  .cliente-card{background:var(--card);border-radius:8px;padding:14px;box-shadow:0 3px 8px rgba(0,0,0,0.06);transition:all 0.3s ease; cursor: pointer;} 
  .cliente-card:hover{transform:translateY(-2px);box-shadow:0 5px 12px rgba(0,0,0,0.08)}
  .cliente-name{font-weight:700;font-size:16px;color:var(--text);margin:0 0 6px 0}
  .cliente-destino{font-weight:600;color:var(--accent);margin:0 0 10px 0;font-size:13px}
  .cliente-info{display:flex;justify-content:space-between;margin-bottom:6px;align-items:center}
  .info-label{font-weight:600;color:var(--muted);font-size:12px}
  .info-value{font-weight:700;font-size:13px}
  .cliente-produto{padding:3px 7px;border-radius:5px;font-size:11px;font-weight:600;display:inline-block;margin-top:4px}
  .cliente-produto i { margin-right: 4px; }
  .status-carregado-tag{background-color: var(--status-carregado);color: white;padding: 2px 7px;border-radius: 10px;font-size: 11px;font-weight: 600;}
  .status-pendente-tag{background-color: var(--status-embarque);color: white;padding: 2px 7px;border-radius: 10px;font-size: 11px;font-weight: 600;}
  /* Modal/Popup */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: none; 
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .modal-content {
    background: var(--card);
    padding: 20px;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    position: relative;
    max-height: 90vh;
    overflow-y: auto;
  }
  .modal-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--muted);
  }
  .modal-header h3 {
      margin-top: 0;
      font-size: 18px;
      color: var(--primary);
      border-bottom: 2px solid var(--accent);
      padding-bottom: 8px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
  }
  .modal-body p {
      margin: 5px 0;
      font-size: 14px;
  }
  .modal-body .info-label {
      font-weight: 600;
      color: var(--text);
      display: inline-block;
      min-width: 180px; 
  }
  .modal-body .info-value {
      font-weight: 400;
      color: var(--muted);
  }
  .modal-clientes-list {
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px dashed #ddd;
  }
  .modal-clientes-list h4 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--accent);
  }
  .modal-clientes-list span {
      display: block;
      padding: 3px 0;
      font-size: 13px;
      color: var(--text);
  }
  h2{color:var(--primary);margin:6px 0 12px 0;font-size:18px}
  .toggle-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 700;
    font-size: 14px;
    transition: opacity 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
  }
  .toggle-btn:hover {
    opacity: 0.9;
  }
  .toggle-btn i {
      margin-right: 5px;
  }
  @media (max-width:600px){
    body{padding:8px}
    .cliente-card{min-width:100%;padding:12px}
    header {
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    .header-btn {
      width: 100%;
      justify-content: center;
      order: 2;
    }
    .header-title {
        width: 100%;
        justify-content: space-between;
    }
    .last-update-top {
        order: 3;
    }
  }
</style>
</head>
<body>
  <header>
    <div class="header-title">
      <img src="https://raw.githubusercontent.com/mvkpasta-prog/planilhas-lotes/main/mvklogo.png" alt="Logo MVK" style="height: 22px; vertical-align: middle; margin-right: 8px;">
      Controle de Lotes ‚Äî Resumo de Retirada
    </div>
    <a href="index.html" class="header-btn" title="Voltar para a p√°gina de Embarques">
        <i class="fas fa-arrow-left"></i> Voltar para Embarques
    </a>
    <div class="last-update-top" id="lastUpdateTop">
      <i class="fas fa-hourglass-half"></i> <span>Atualizando...</span>
    </div>
  </header>
  <div class="wrap">
    
    <div class="status-cards">
      <div class="status-card status-card-carregado">
        <h3>CONTRATOS ABERTOS</h3>
        <div class="count" id="count-aberto">0</div>
      </div>
      <div class="status-card status-card-embarque">
        <h3>CONTRATOS FINALIZADOS</h3>
        <div class="count" id="count-finalizado">0</div>
      </div>
      <div class="status-card status-card-transito">
        <h3>CONTRATOS TOTAIS</h3>
        <div class="count" id="count-contratos">0</div>
      </div>
      <div class="status-card status-card-contratar">
        <h3>PRODUTOS √öNICOS</h3>
        <div class="count" id="count-produtos">0</div>
      </div>
    </div>
    <div class="produto-cards">
      <div class="produto-card produto-soja">
        <h3>SOJA A RETIRAR</h3>
        <div class="count" id="count-soja">0 KG</div>
      </div>
      <div class="produto-card produto-milho">
        <h3>MILHO A RETIRAR</h3>
        <div class="count" id="count-milho">0 KG</div>
      </div>
      <div class="produto-card produto-sorgo">
        <h3>SORGO A RETIRAR</H3>
        <div class="count" id="count-sorgo">0 KG</div>
      </div>
      <div class="produto-card produto-total" id="card-total-retirada">
        <h3>TOTAL A RETIRAR</h3>
        <div class="count" id="count-total">0 KG</div>
      </div>
    </div>
    
    <div class="clientes-section">
      <h2 style="margin-top: 0;">
        <span id="resumoTitle">üìç Resumo por Local de Embarque</span>
      </h2>
      <div style="display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap;">
        <input type="text" id="filterInput" placeholder="Filtrar por Local ou Cliente..." style="flex-grow: 1; min-width: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
        <button class="toggle-btn" id="toggleViewBtn" onclick="toggleView()">
            <i class="fas fa-sync-alt"></i> Mudar para Clientes
        </button>
      </div>

      <div class="clientes-container" id="clientesContainer">
          </div>
    </div>
    
  </div>
  
  <div id="resumoModal" class="modal-overlay">
      <div class="modal-content">
          <button class="modal-close" onclick="closeModal()">&times;</button>
          <div id="modalContentBody">
              </div>
      </div>
  </div>

<script>
/* ====== CONFIG - Planilha Lotes Retirada ====== */
const SHEET_ID = '1o0wF2ScSkyxqY8FHFI-rA6k_3uMI2wsZr2wQG8JD4B4';
const GIDS = {
  retirada: '1984691910'   // GID da aba LOTES RETIRADA
};
// Configura√ß√£o do intervalo de atualiza√ß√£o autom√°tica (em milissegundos)
const AUTO_UPDATE_INTERVAL = 300000;

/* Vari√°veis globais para armazenar os dados e o estado da visualiza√ß√£o */
let globalProdutosTotais = { soja: 0, milho: 0, sorgo: 0, total: 0 };
let globalResumoData = { local: [], cliente: [] };
let currentView = 'local'; // 'local' ou 'cliente'

/* --- FUN√á√ïES UTILIT√ÅRIAS --- */

function normalizeHeader(h){
  if(h === undefined || h === null) return '';
  return String(h).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,'');
}
function normalizeText(text) {
  if(text === undefined || text === null) return '';
  return String(text).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
}
function parseCSV(text){
  if(!text) return {arrays:[], headersOrig:[], headersNorm:[], objects:[]};
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
  if(lines.length === 0) return {arrays:[], headersOrig:[], headersNorm:[], objects:[]};
  const parsed = lines.map(line => line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"|"$/g,'').trim()));
  const headersOrig = parsed.shift().map(h => h||'');
  const headersNorm = headersOrig.map(h => normalizeHeader(h));
  const objects = parsed.map(cells => {
    const obj = {};
    headersNorm.forEach((key, idx) => {
      obj[key] = cells[idx] !== undefined ? cells[idx] : '';
    });
    return obj;
  });
  return {arrays: parsed, headersOrig, headersNorm, objects};
}
async function fetchSheetByGid(gid){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('Erro ao buscar planilha: ' + r.status);
  const text = await r.text();
  return parseCSV(text);
}
function parseNumber(val){
  if(val === undefined || val === null) return NaN;
  const s = String(val).replace(/\s/g,'').replace(/\./g,'').replace(/,/g,'.');
  const n = parseFloat(s.replace(/[^\d\.\-]/g,''));
  return isNaN(n) ? NaN : n;
}
function formatNumber(value) {
  if(isNaN(value)) return '0';
  return new Intl.NumberFormat('pt-BR').format(Math.round(value));
}
function escapeHtml(s){
  if(s === undefined || s === null) return '';
  return String(s).replace(/[&<>"'\/]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#x2F;'}[c]));
}

/**
 * Gera o HTML para as tags de produto com √≠cones e cores.
 * @param {string} produtosString - String de produtos separada por ' / ' (e.g., "SOJA / MILHO").
 * @returns {string} HTML das tags formatadas.
 */
function generateProductTagsHtml(produtosString) {
    const produtosArray = produtosString.split(' / ').filter(p => p.trim() !== '');
    if (produtosArray.length === 0) {
        return '<span class="cliente-produto" style="background-color: var(--muted); color: white;"><i class="fas fa-question-circle"></i> N/A</span>';
    }

    let tagsHtml = '';
    produtosArray.forEach(p => {
        const pUp = p.toUpperCase();
        let tagIcon = 'fas fa-cubes';
        let tagColor = 'var(--produto-sorgo)'; // Sorgo/Default
        
        if(pUp.includes('SOJA')) {
            tagIcon = 'fas fa-seedling';
            tagColor = 'var(--produto-soja)';
        } else if(pUp.includes('MILHO')) {
            tagIcon = 'fas fa-sun'; // √çcone representando gr√£o dourado/milho
            tagColor = 'var(--produto-milho)';
        }

        tagsHtml += `<span class="cliente-produto" style="background-color: ${tagColor}; color: white; margin-right: 5px;">
            <i class="${tagIcon}"></i> ${escapeHtml(p)}
        </span>`;
    });
    return tagsHtml;
}

/* --- FUN√á√ÉO PRINCIPAL: Agrupar Lotes de Retirada --- */
function groupRetiradaData(rowsArrRet, headersNormRet, groupBy) {
    const grupos = {};
    const localIndex = 2;       // Coluna C
    const clienteIndex = 3;     // Coluna D
    const produtoIndex = 4;     // Coluna E
    const aRetirarIndex = 9;    // Coluna J (Saldo a Retirar - CR√çTICO para o status)
    const embarcadaIndex = 8;   // Coluna I
    const contratoIndex = 1;    // Coluna B (Contrato)

    const contratosGlobais = new Set();
    const produtosGlobais = new Set();

    rowsArrRet.forEach(arr => {
        const local = arr[localIndex] ? arr[localIndex].trim() : 'Local Desconhecido';
        const cliente = arr[clienteIndex] ? arr[clienteIndex].trim() : 'Cliente Desconhecido';
        const saldoARetirar = parseNumber(arr[aRetirarIndex] || '0');
        const embarcada = parseNumber(arr[embarcadaIndex] || '0');
        const contrato = arr[contratoIndex] ? arr[contratoIndex].trim() : '';
        const produtoText = arr[produtoIndex] ? arr[produtoIndex].trim() : '';

        if (!contrato) return; // Ignorar linhas sem contrato

        const key = groupBy === 'local' ? local : cliente;
        
        // Contadores globais
        contratosGlobais.add(contrato);
        if (produtoText) produtosGlobais.add(produtoText);

        if (!grupos[key]) {
            grupos[key] = {
                key: key,
                totalARetirar: 0,
                totalEmbarcada: 0,
                clientes: new Set(),
                locais: new Set(),
                produtos: new Set(),
                contratos: new Map() // Mapeia contrato para a soma de Saldo a Retirar (Coluna J)
            };
        }
        
        // Agrega√ß√£o
        grupos[key].totalARetirar += saldoARetirar;
        grupos[key].totalEmbarcada += embarcada;
        if (cliente) grupos[key].clientes.add(cliente);
        if (local) grupos[key].locais.add(local);
        if (produtoText) grupos[key].produtos.add(produtoText);
        
        // NOVO: Acumular Saldo a Retirar para este Contrato √∫nico dentro do grupo
        const currentSaldo = grupos[key].contratos.get(contrato) || 0;
        grupos[key].contratos.set(contrato, currentSaldo + saldoARetirar);
    });

    const resumo = Object.values(grupos).map(grupo => {
        let totalAbertos = 0;
        let totalFinalizados = 0;
        
        // NOVO C√ÅLCULO: Contar status baseado no Saldo a Retirar por Contrato
        grupo.contratos.forEach(saldoContrato => {
            if (saldoContrato <= 0) { // Saldo a Retirar <= 0 -> Finalizado
                totalFinalizados++;
            } else { // Saldo a Retirar > 0 -> Aberto
                totalAbertos++;
            }
        });

        // CORRE√á√ÉO DO BUG "UNDEFINED" e substitui√ß√£o por '/'
        const clientesValidos = Array.from(grupo.clientes)
            .filter(c => c.trim() !== '' && c.trim().toLowerCase() !== 'cliente desconhecido');
        const locaisValidos = Array.from(grupo.locais)
            .filter(l => l.trim() !== '' && l.trim().toLowerCase() !== 'local desconhecido');
        const produtosValidos = Array.from(grupo.produtos)
            .filter(p => p.trim() !== '');

        return {
            ...grupo,
            totalARetirar: Math.round(grupo.totalARetirar),
            totalEmbarcada: Math.round(grupo.totalEmbarcada),
            clientes: clientesValidos.sort().join(', ') || '/', 
            locais: locaisValidos.sort().join(' / ') || '/',
            produtos: produtosValidos.sort().join(' / ') || '/',
            totalContratos: grupo.contratos.size,
            totalAbertos: totalAbertos,
            totalFinalizados: totalFinalizados,
            groupBy: groupBy
        };
    }).filter(r => r.totalARetirar > 0 || r.totalFinalizados > 0) // Mostrar se tiver saldo ou se houver contratos finalizados
      .sort((a, b) => b.totalARetirar - a.totalARetirar);

    return { resumo, totalContratos: contratosGlobais.size, totalProdutos: produtosGlobais.size };
}

/* --- FUN√á√ÉO: Calcular Totais por Produto (Retirada) --- */
function calculateProdutosTotaisRetirada(rowsArrRet) {
    let soja = 0, milho = 0, sorgo = 0;
    const produtoIndex = 4;
    const aRetirarIndex = 9;

    rowsArrRet.forEach(arr => {
        const produtoText = arr[produtoIndex] ? arr[produtoIndex].trim() : '';
        const produtoNorm = normalizeText(produtoText);
        const aRetirar = parseNumber(arr[aRetirarIndex] || '0');
        
        if(isNaN(aRetirar)) return;
        
        if(produtoNorm.includes('soja')) {
          soja += aRetirar;
        } else if(produtoNorm.includes('milho')) {
          milho += aRetirar;
        } else if(produtoNorm.includes('sorgo')) {
          sorgo += aRetirar;
        }
    });
    return {soja, milho, sorgo};
}

/* Gerar HTML para os cards de resumo (Local ou Cliente) */
function buildResumoCardsHTML(resumos) {
  if(resumos.length === 0) {
    return '<div class="empty">Nenhum lote de retirada encontrado para o filtro.</div>';
  }
  let html = '';
  resumos.forEach((resumo, index) => { 
    const globalIndex = globalResumoData[resumo.groupBy].findIndex(r => r.key === resumo.key);

    const title = resumo.key;
    const subtitle = resumo.groupBy === 'local' ? resumo.produtos : resumo.locais;
    
    // Gerar tags de produto com √≠cones
    const productTagsHtml = generateProductTagsHtml(resumo.produtos);

    html += `
      <div class="cliente-card" onclick="openResumoModal(${globalIndex}, '${resumo.groupBy}')">
        <h3 class="cliente-name">${escapeHtml(title)}</h3>
        <div class="cliente-contrato" style="margin-bottom: 8px;">
            ${productTagsHtml}
        </div>
        <div class="cliente-info" style="margin-top: 12px;">
          <span class="info-label">Contratos Abertos:</span>
          <span class="info-value status-pendente-tag">${resumo.totalAbertos}</span>
        </div>
        <div class="cliente-info" style="margin-top: 6px;">
          <span class="info-label">Contratos Finalizados:</span>
          <span class="info-value status-carregado-tag">${resumo.totalFinalizados}</span>
        </div>
        <div class="cliente-info" style="margin-top: 12px; border-top: 1px solid #eee; padding-top: 8px;">
          <span class="info-label">Total a Retirar:</span>
          <span class="info-value">${formatNumber(resumo.totalARetirar)} KG</span>
        </div>
        <div class="cliente-info" style="margin-top: 6px;">
          <span class="info-label">Total Embarcado:</span>
          <span class="info-value">${formatNumber(resumo.totalEmbarcada)} KG</span>
        </div>
      </div>
    `;
  });
  return html;
}

/* Renderiza os cards e atualiza o t√≠tulo da se√ß√£o com base na view atual */
function renderCards() {
    const titleSpan = document.getElementById('resumoTitle');
    const toggleBtn = document.getElementById('toggleViewBtn');
    const filterInput = document.getElementById('filterInput');

    if (currentView === 'local') {
        titleSpan.textContent = 'üìç Resumo por Local de Embarque';
        toggleBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Mudar para Clientes';
        filterInput.placeholder = 'Filtrar por Local ou Cliente...';
    } else {
        titleSpan.textContent = 'üë§ Resumo por Cliente';
        toggleBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Mudar para Local';
        filterInput.placeholder = 'Filtrar por Cliente ou Local...';
    }
    
    filterCards(); // Renderiza aplicando o filtro
}

/* Fun√ß√£o de filtro: Local de Embarque OU Cliente */
function filterCards() {
    const data = globalResumoData[currentView];
    const filterText = normalizeText(document.getElementById('filterInput').value).trim();
    const container = document.getElementById('clientesContainer');
    
    if (filterText.length < 2 && filterText.length > 0) {
        container.innerHTML = buildResumoCardsHTML(data);
        return;
    } else if (filterText.length === 0) {
        container.innerHTML = buildResumoCardsHTML(data);
        return;
    }
    
    const filteredResumos = data.filter(resumo => {
        const keyNorm = normalizeText(resumo.key);
        const secondaryNorm = normalizeText(currentView === 'local' ? resumo.clientes : resumo.locais);

        return keyNorm.includes(filterText) || secondaryNorm.includes(filterText);
    });
    
    container.innerHTML = buildResumoCardsHTML(filteredResumos);
}

/* Alterna a visualiza√ß√£o entre local e cliente */
function toggleView() {
    currentView = currentView === 'local' ? 'cliente' : 'local';
    renderCards();
}

/* Fun√ß√£o para abrir o modal de detalhes do Resumo */
function openResumoModal(index, groupBy) {
    const resumo = globalResumoData[groupBy][index];
    if (!resumo) return;

    const modal = document.getElementById('resumoModal');
    const modalContent = document.getElementById('modalContentBody');
    
    // Formatando a lista de Clientes ou Locais para o modal
    const secondaryListKey = groupBy === 'local' ? 'clientes' : 'locais';
    const secondaryListTitle = groupBy === 'local' ? 'Clientes Envolvidos' : 'Locais de Embarque Envolvidos';
    const secondaryListArray = resumo[secondaryListKey].split(/, | \/ /).filter(c => c.trim() !== '');
    const secondaryList = secondaryListArray.map(c => `<span>${escapeHtml(c)}</span>`).join('');
    
    const mainTitle = resumo.key;
    
    // Lista de produtos no modal
    const produtosList = generateProductTagsHtml(resumo.produtos);

    modalContent.innerHTML = `
        <div class="modal-header">
            <h3>${escapeHtml(mainTitle)}</h3>
        </div>
        <div class="modal-body">
            <p><span class="info-label">Produtos Envolvidos:</span> ${produtosList}</p>
            <p><span class="info-label">Contratos (Total no local/cliente):</span> <span class="info-value">${resumo.totalContratos}</span></p>
            <p><span class="info-label">Contratos Abertos:</span> <span class="info-value status-pendente-tag">${resumo.totalAbertos}</span></p>
            <p><span class="info-label">Contratos Finalizados:</span> <span class="info-value status-carregado-tag">${resumo.totalFinalizados}</span></p>
            
            <p style="margin-top: 15px;"><span class="info-label">Total a Retirar:</span> <span class="info-value">${formatNumber(resumo.totalARetirar)} KG</span></p>
            <p><span class="info-label">Total Embarcado:</span> <span class="info-value">${formatNumber(resumo.totalEmbarcada)} KG</span></p>
            
            <div class="modal-clientes-list">
                <h4>${secondaryListTitle} (${secondaryListArray.length}):</h4>
                ${secondaryList || '<span>Nenhum encontrado.</span>'}
            </div>
        </div>
    `;

    modal.style.display = 'flex';
}

function closeModal() {
    document.getElementById('resumoModal').style.display = 'none';
}

function setupModalCloseHandlers() {
    const modal = document.getElementById('resumoModal');
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
            closeModal();
        }
    });
}

function updateLastUpdateTime() {
  const now = new Date();
  const timeString = now.toLocaleTimeString('pt-BR');
  const dateString = now.toLocaleDateString('pt-BR');
  document.getElementById('lastUpdateTop').innerHTML = `
    <i class="fas fa-check-circle" style="color: rgba(255,255,255,0.9);"></i>
    <span>√öltima atualiza√ß√£o: ${timeString} - ${dateString}</span>
  `;
}

/* --- Main load function --- */
async function loadAll(isAutoUpdate = false){
  try{
    if(isAutoUpdate) {
      document.getElementById('lastUpdateTop').innerHTML = `
        <i class="fas fa-hourglass-half" style="color: rgba(255,255,255,0.9);"></i>
        <span>Atualizando...</span>
      `;
      document.body.classList.add('updating');
    }
    
    // ===== LOTES DE RETIRADA (FOCO √öNICO) =====
    const ret = await fetchSheetByGid(GIDS.retirada);
    const rowsArrRet = ret.arrays;
    const headersNormRet = ret.headersNorm;

    // Agrupamento por Local e Cliente
    const { resumo: resumoLocal, totalContratos, totalProdutos } = groupRetiradaData(rowsArrRet, headersNormRet, 'local');
    const { resumo: resumoCliente } = groupRetiradaData(rowsArrRet, headersNormRet, 'cliente');
    
    // Armazenar globalmente os dois resumos
    globalResumoData.local = resumoLocal;
    globalResumoData.cliente = resumoCliente;
    
    // Renderiza a view atual
    renderCards();
    
    // ===== CONTADORES E TOTAIS DE PRODUTO =====
    
    const totalAbertoGlobal = resumoLocal.reduce((acc, curr) => acc + curr.totalAbertos, 0);
    const totalFinalizadoGlobal = resumoLocal.reduce((acc, curr) => acc + curr.totalFinalizados, 0);

    document.getElementById('count-aberto').textContent = totalAbertoGlobal;
    document.getElementById('count-finalizado').textContent = totalFinalizadoGlobal;
    document.getElementById('count-contratos').textContent = totalContratos;
    document.getElementById('count-produtos').textContent = totalProdutos;

    // Calcular totais por produto (usando o array de todos os lotes)
    const produtosTotais = calculateProdutosTotaisRetirada(rowsArrRet);
    
    globalProdutosTotais.soja = produtosTotais.soja;
    globalProdutosTotais.milho = produtosTotais.milho;
    globalProdutosTotais.sorgo = produtosTotais.sorgo;
    
    const totalARetirar = produtosTotais.soja + produtosTotais.milho + produtosTotais.sorgo;
    globalProdutosTotais.total = totalARetirar;
    
    // Atualizar cards de produto
    document.getElementById('count-soja').textContent = `${formatNumber(produtosTotais.soja)} KG`;
    document.getElementById('count-milho').textContent = `${formatNumber(produtosTotais.milho)} KG`;
    document.getElementById('count-sorgo').textContent = `${formatNumber(produtosTotais.sorgo)} KG`;
    document.getElementById('count-total').textContent = `${formatNumber(totalARetirar)} KG`;
    
    // Atualizar o texto da √∫ltima atualiza√ß√£o
    updateLastUpdateTime();
    document.body.classList.remove('updating');
  }
  catch(err){
    console.error('Erro loadAll (P√°gina Retirada):', err);
    document.getElementById('clientesContainer').innerHTML = '<div class="empty">Erro ao carregar dados. Verifique a conex√£o ou as configura√ß√µes da planilha (ver console).</div>';
    document.getElementById('lastUpdateTop').innerHTML = `
      <i class="fas fa-exclamation-triangle" style="color: rgba(255,255,255,0.9);"></i>
      <span>Erro na atualiza√ß√£o</span>
    `;
    document.body.classList.remove('updating');
  }
}

let autoUpdateInterval;
function startAutoUpdate() {
  loadAll(true);
  autoUpdateInterval = setInterval(() => {
    loadAll(true);
  }, AUTO_UPDATE_INTERVAL);
}

function handleTotalCardClick() {
    alert(`Total a Retirar: ${formatNumber(globalProdutosTotais.total)} KG. Esta fun√ß√£o pode ser personalizada.`);
}

/* init */
document.addEventListener('DOMContentLoaded', function() {
  // Adicionar handler de filtro
  document.getElementById('filterInput').addEventListener('keyup', filterCards);
  
  // Adicionar handler de clique ao card "TOTAL A RETIRAR"
  document.getElementById('card-total-retirada').addEventListener('click', handleTotalCardClick);
  
  setupModalCloseHandlers();
  startAutoUpdate();

  document.addEventListener('visibilitychange', function() {
    if(!document.hidden) {
      loadAll(true);
    }
  });
});
</script>
</body>
</html>
