<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controle de Lotes ‚Äî Entrega & Retirada</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  :root{
    --primary:#2563eb; --accent:#0ea5e9; --bg:#f6fbff; --card:#fff; --text:#0f172a;
    --muted:#6b7280; --success:#10b981; --warning:#f59e0b;
    --status-carregado: #10b981; /* Verde */
    --status-embarque: #3b82f6; /* Azul */
    --status-transito: #ef4444; /* Vermelho */
  }
  *{box-sizing:border-box}
  body{font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;margin:0;background:var(--bg);color:var(--text);padding:18px}
  header{background:linear-gradient(90deg,var(--primary),var(--accent));color:white;padding:14px;border-radius:8px;margin-bottom:18px;text-align:center;font-weight:700}
  .wrap{max-width:1280px;margin:0 auto}
  .actions{display:flex;justify-content:flex-end;margin-bottom:18px}
  .btn{background:var(--primary);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
  .btn:hover{opacity:.95}
  
  /* Cards de Status no topo */
  .status-cards{display:flex;flex-wrap:wrap;gap:16px;margin-bottom:24px}
  .status-card{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,0.08);flex:1;min-width:200px;text-align:center;transition:all 0.3s ease}
  .status-card:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,0.12)}
  .status-card h3{margin:0 0 8px 0;font-size:16px;color:var(--text);font-weight:600}
  .status-card .count{font-size:28px;font-weight:700;margin:8px 0}
  .status-card-carregado{border-top:4px solid var(--status-carregado);}
  .status-card-embarque{border-top:4px solid var(--status-embarque);}
  .status-card-transito{border-top:4px solid var(--status-transito);}
  
  /* T√≠tulos expans√≠veis */
  .section-header{background:linear-gradient(90deg,var(--primary),var(--accent));color:white;padding:14px;border-radius:8px;margin-bottom:12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-weight:700;transition:all 0.3s ease}
  .section-header:hover{opacity:0.95}
  .section-header .toggle-icon{transition:transform 0.3s ease}
  .section-header.collapsed .toggle-icon{transform:rotate(-90deg)}
  
  .section-content{display:block;transition:all 0.3s ease;overflow:hidden}
  .section-content.collapsed{display:none}
  
  h2{color:var(--primary);margin:6px 0 12px 0}
  .card{background:var(--card);border-radius:10px;padding:12px;margin-bottom:18px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
  .table-wrap{overflow-x:auto}
  table{width:100%;border-collapse:collapse;margin:0;font-size:13px;min-width:800px}
  th,td{border:1px solid #e6eefc;padding:10px;text-align:left;vertical-align:top}
  th{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;font-weight:700;white-space:nowrap}
  tr:nth-child(even){background:#fbfdff}
  .status{display:inline-block;padding:6px 10px;border-radius:16px;color:#fff;font-weight:700}
  .status-aberto{background:var(--warning)}
  .status-fechado{background:var(--success)}
  
  /* Estilos para os novos status da programa√ß√£o */
  .status-programacao{display:inline-block;padding:6px 12px;border-radius:16px;color:#fff;font-weight:700;font-size:12px;min-width:100px;text-align:center}
  .status-carregado{background-color: var(--status-carregado);}
  .status-embarque{background-color: var(--status-embarque);}
  .status-transito{background-color: var(--status-transito);}
  
  .empty{color:var(--muted);font-style:italic;padding:12px}
  @media (max-width:900px){
    table{min-width:700px}
    th, td{padding:8px;font-size:12px}
    .status-cards{flex-direction:column}
  }
</style>
</head>
<body>
  <header>üì¶ Controle de Lotes ‚Äî Entrega & Retirada</header>

  <div class="wrap">
    <div class="actions">
      <button id="btnRefresh" class="btn"><i class="fas fa-sync-alt"></i> Atualizar</button>
    </div>
    
    <!-- Cards de Status -->
    <div class="status-cards">
      <div class="status-card status-card-carregado">
        <h3>CARREGADO</h3>
        <div class="count" id="count-carregado">0</div>
        <div>Ve√≠culos</div>
      </div>
      <div class="status-card status-card-embarque">
        <h3>NO EMBARQUE</h3>
        <div class="count" id="count-embarque">0</div>
        <div>Ve√≠culos</div>
      </div>
      <div class="status-card status-card-transito">
        <h3>EM TR√ÇNSITO</h3>
        <div class="count" id="count-transito">0</div>
        <div>Ve√≠culos</div>
      </div>
    </div>

    <!-- Lotes de Entrega -->
    <div class="section-header" id="toggle-entrega">
      <span>üöö Lotes de Entrega</span>
      <i class="fas fa-chevron-down toggle-icon"></i>
    </div>
    <div class="section-content card" id="content-entrega">
      <div id="entregaContent" class="table-wrap"></div>
    </div>

    <!-- Lotes de Retirada -->
    <div class="section-header" id="toggle-retirada">
      <span>üì¶ Lotes de Retirada</span>
      <i class="fas fa-chevron-down toggle-icon"></i>
    </div>
    <div class="section-content card" id="content-retirada">
      <div id="retiradaContent" class="table-wrap"></div>
    </div>

    <!-- Programa√ß√£o (nome alterado) -->
    <div class="section-header" id="toggle-programacao">
      <span>üóì Programa√ß√£o</span>
      <i class="fas fa-chevron-down toggle-icon"></i>
    </div>
    <div class="section-content card" id="content-programacao">
      <div id="programacaoContent" class="table-wrap"></div>
    </div>
  </div>

<script>
/* ====== CONFIG - coloque aqui seu SHEET_ID se mudar ====== */
const SHEET_ID = '1CZZgYJiZic9pyFFTdyldm_gVwn2K-zSGY9uhFJ5Nz6Q';
const GIDS = {
  entrega: '271702555',    // aba LOTES DE ENTREGA
  retirada: '585404986',   // aba LOTES RETIRADA
  programacao: '1183141602'// aba PROGRAMA√á√ÉO
};

/* colunas que ficam ocultas em exibi√ß√£o (aparecem em detalhes) - normalizadas */
const HIDDEN_COLS = ['nfp','royalties','safra'];

/* colunas removidas (normalizadas) de todas as tabelas */
const REMOVED_COMMON = ['localizacao','idorigemymvk1'];

/* colunas removidas especificamente da Programa√ß√£o (normalizadas) */
const REMOVED_PROGRAMACAO = [
  'observacoes','ordem','notafiscal','dacte','mdfe','conftipocam','agendamento',
  'descarga','comprovantededescarga','horarioprev','classificacaodestino','chaveid',
  'frete', 'statusagendamento', 'datadedescarga', 'notafiscal' // Adicionadas conforme solicita√ß√£o
];

/* Normaliza cabe√ßalho: remove acento, espa√ßos e pontua√ß√£o */
function normalizeHeader(h){
  if(h === undefined || h === null) return '';
  return String(h).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,'');
}

/* Parse CSV tolerante (trata v√≠rgulas dentro de aspas)
   Retorna { arrays: [ [col1,col2,...], ... ], headersOrig: [], headersNorm: [], objects: [ {normKey: value}, ... ] }
*/
function parseCSV(text){
  if(!text) return {arrays:[], headersOrig:[], headersNorm:[], objects:[]};
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
  if(lines.length === 0) return {arrays:[], headersOrig:[], headersNorm:[], objects:[]};

  const parsed = lines.map(line => line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"|"$/g,'').trim()));
  const headersOrig = parsed.shift().map(h => h||'');
  const headersNorm = headersOrig.map(h => normalizeHeader(h));

  const objects = parsed.map(cells => {
    const obj = {};
    headersNorm.forEach((key, idx) => {
      obj[key] = cells[idx] !== undefined ? cells[idx] : '';
    });
    return obj;
  });

  return {arrays: parsed, headersOrig, headersNorm, objects};
}

/* fetch CSV via gviz - retorna parseCSV result */
async function fetchSheetByGid(gid){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('Erro ao buscar planilha: ' + r.status);
  const text = await r.text();
  return parseCSV(text);
}

/* util: parse number tolerant */
function parseNumber(val){
  if(val === undefined || val === null) return NaN;
  const s = String(val).replace(/\s/g,'').replace(/\./g,'').replace(/,/g,'.');
  const n = parseFloat(s.replace(/[^\d\.\-]/g,''));
  return isNaN(n) ? NaN : n;
}

/* util: parse date only (dd/mm/yyyy ou yyyy-mm-dd) -> Date (00:00:00) or null */
function parseDateOnly(s){
  if(!s) return null;
  const str = String(s).trim();
  // dd/mm/yyyy
  if(str.includes('/')){
    const parts = str.split('/');
    if(parts.length >= 3){
      const d = parseInt(parts[0],10), m = parseInt(parts[1],10), y = parseInt(parts[2],10);
      if(!isNaN(d) && !isNaN(m) && !isNaN(y)) return new Date(y, m-1, d);
    }
  }
  // yyyy-mm-dd or yyyy/mm/dd
  if(str.includes('-') || (str.includes('/') && str.indexOf('/') === 4)){
    const sep = str.includes('-')? '-' : '/';
    const parts = str.split(sep);
    if(parts.length >= 3){
      const y = parseInt(parts[0],10), m = parseInt(parts[1],10), d = parseInt(parts[2],10);
      if(!isNaN(d) && !isNaN(m) && !isNaN(y)) return new Date(y, m-1, d);
    }
  }
  const dt = new Date(str);
  if(!isNaN(dt.getTime())) return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
  return null;
}

/* encontra header normalizado que contenha um dos padr√µes */
function findHeaderKey(headersNorm, patterns){
  for(const p of patterns){
    const f = headersNorm.find(h => h.includes(p));
    if(f) return f;
  }
  // fallbacks inteligentes
  if(patterns.includes('saldoent')){
    const f = headersNorm.find(h => h.includes('saldo') && (h.includes('ent') || h.includes('entrega') || h.includes('entkg')));
    if(f) return f;
  }
  if(patterns.includes('saldoret')){
    const f = headersNorm.find(h => h.includes('saldo') && (h.includes('ret') || h.includes('retirada') || h.includes('retkg')));
    if(f) return f;
  }
  if(patterns.some(x => x.includes('contrato'))){
    const f = headersNorm.find(h => h.includes('contrato'));
    if(f) return f;
  }
  // any saldo
  const f = headersNorm.find(h => h.includes('saldo'));
  if(f) return f;
  return null;
}

/* Formata n√∫mero como moeda brasileira */
function formatCurrencyBRL(value) {
  if (isNaN(value)) return value;
  return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL'
  }).format(value);
}

/* Formata o status da programa√ß√£o com cores espec√≠ficas */
function formatStatusProgramacao(status) {
  let className = 'status-programacao';
  let text = status;
  
  // Normalizar o status para compara√ß√£o
  const statusLower = status.toLowerCase().trim();
  
  if (statusLower.includes('carregado')) {
    className += ' status-carregado';
  } else if (statusLower.includes('embarque') || statusLower.includes('no embarque')) {
    className += ' status-embarque';
  } else if (statusLower.includes('transito') || statusLower.includes('em transito')) {
    className += ' status-transito';
  } else {
    // Status padr√£o (cinza)
    className += ' status-aberto';
  }
  
  return `<span class="${className}">${escapeHtml(text)}</span>`;
}

/* build table HTML: rowsArrays = array of arrays; rowsObjects = array of objects keyed by normalized headers */
function buildTableHTML(rowsArrays, rowsObjects, headersOrig, headersNorm, opts){
  // opts: {hiddenNorm:[], removedNorm:[], numericKey: 'somenorm', forceColsNorm:[], currencyCols:[], statusCol: ''}
  const hiddenNorm = opts.hiddenNorm || [];
  const removedNorm = opts.removedNorm || [];
  const numericKey = opts.numericKey || '';
  const forceInclude = opts.forceInclude || [];
  const currencyCols = opts.currencyCols || [];
  const statusCol = opts.statusCol || '';

  // visible columns: headersNorm minus removed
  const visible = headersNorm.filter(h => !removedNorm.includes(h));
  // display columns exclude hidden
  let displayCols = visible.filter(h => !hiddenNorm.includes(h));

  // ensure forced columns appear first
  forceInclude.forEach(fc => {
    if(visible.includes(fc) && !displayCols.includes(fc)) displayCols.unshift(fc);
    else if(visible.includes(fc)) displayCols = [fc, ...displayCols.filter(x => x !== fc)];
  });

  if(displayCols.length === 0){
    return '<div class="empty">Sem colunas para exibir.</div>';
  }

  // construct header titles using originals
  let html = '<table><thead><tr>';
  displayCols.forEach(h => {
    const idx = headersNorm.indexOf(h);
    const title = (idx>=0 ? headersOrig[idx] : h) || h;
    html += `<th>${escapeHtml(title)}</th>`;
  });
  if(numericKey) html += '<th>Status</th>';
  html += '</tr></thead><tbody>';

  rowsObjects.forEach((obj, i) => {
    const arr = rowsArrays[i] || [];
    const n = numericKey ? parseNumber( obj[numericKey] || arr[numericKeyIndex(headersNorm, numericKey)] || '0' ) : NaN;
    html += '<tr>';
    displayCols.forEach(h => {
      // prefer object value, fallback to array by index if available
      const idx = headersNorm.indexOf(h);
      let value = (obj[h] !== undefined && obj[h] !== '') ? obj[h] : (arr[idx] !== undefined ? arr[idx] : '');
      
      // Formatar como moeda se for uma coluna de moeda
      if(currencyCols.includes(h)) {
        const numValue = parseNumber(value);
        if(!isNaN(numValue)) {
          value = formatCurrencyBRL(numValue);
        }
      }
      
      // Formatar status da programa√ß√£o
      if(h === statusCol) {
        value = formatStatusProgramacao(value);
        html += `<td>${value}</td>`;
      } else {
        html += `<td>${escapeHtml(value)}</td>`;
      }
    });
    if(numericKey) html += `<td>${n>0?'<span class="status status-aberto">ABERTO</span>':'<span class="status status-fechado">FECHADO</span>'}</td>`;
    html += '</tr>';
  });

  html += '</tbody></table>';
  return html;
}

// helper: get index of normalized key (or -1)
function numericKeyIndex(headersNorm, key){ return headersNorm.indexOf(key); }

function escapeHtml(s){
  if(s === undefined || s === null) return '';
  return String(s).replace(/[&<>"'\/]/g, c => ({'&':'&amp;','<':'<','>':'>','"':'&quot;',"'":'&#x27;','/':'&#x2F;'}[c]));
}

/* Contar status da programa√ß√£o */
function countStatusProgramacao(rowsObjects, statusCol) {
  let carregado = 0, embarque = 0, transito = 0;
  
  if(!statusCol) return {carregado, embarque, transito};
  
  rowsObjects.forEach(obj => {
    const status = obj[statusCol] || '';
    const statusLower = status.toLowerCase().trim();
    
    if (statusLower.includes('carregado')) {
      carregado++;
    } else if (statusLower.includes('embarque') || statusLower.includes('no embarque')) {
      embarque++;
    } else if (statusLower.includes('transito') || statusLower.includes('em transito')) {
      transito++;
    }
  });
  
  return {carregado, embarque, transito};
}

/* --- Main load function --- */
async function loadAll(){
  try{
    // ===== LOTES DE ENTREGA =====
    const ent = await fetchSheetByGid(GIDS.entrega);
    const rowsArrEnt = ent.arrays;      // array of arrays
    const headersOrigEnt = ent.headersOrig;
    const headersNormEnt = ent.headersNorm;
    const objsEnt = ent.objects;

    // Procurar pela coluna "INFORMA√á√ïES DESTINO"
    const infoDestinoKey = headersNormEnt.find(h => h.includes('informacoesdestino') || h.includes('informacaodestino') || h.includes('destino'));
    
    // Procurar pela coluna "ID DESTINO"
    const idDestinoKey = headersNormEnt.find(h => h.includes('iddestino') || h.includes('id_destino'));
    
    // Procurar pela coluna "SITUA√á√ÉO ENT"
    const situacaoEntKey = headersNormEnt.find(h => h.includes('situacaoent') || h.includes('situacao') || h.includes('situacaoentrega'));
    
    // Procurar por poss√≠veis colunas de contrato existentes
    const existingContratoKeys = headersNormEnt.filter(h => h.includes('contrato') || h.includes('ncontrato') || h.includes('numerocontrato'));
    
    // Saldo Entrega (coluna I index 8) - also try to find header
    const saldoKeyEnt = findHeaderKey(headersNormEnt, ['saldoent','saldoentrega','saldoentkg']) || null;
    const saldoIndexEnt = 8;

    // Criar uma nova chave para o n√∫mero do contrato
    const contratoKey = 'numero_contrato';
    
    // Define as colunas que ser√£o removidas do Lotes de Entrega
    const removedEnt = [...REMOVED_COMMON.map(normalizeHeader)];
    
    // Adicionar INFORMA√á√ïES DESTINO, ID DESTINO e SITUA√á√ÉO ENT √†s colunas removidas
    if(infoDestinoKey) removedEnt.push(infoDestinoKey);
    if(idDestinoKey) removedEnt.push(idDestinoKey);
    if(situacaoEntKey) removedEnt.push(situacaoEntKey);
    
    // Remover todas as colunas existentes de contrato para evitar duplica√ß√£o
    existingContratoKeys.forEach(key => {
      if(!removedEnt.includes(key)) {
        removedEnt.push(key);
      }
    });

    // build filtered rows: only saldo > 0
    const rowsObjEntFiltered = [];
    const rowsArrEntFiltered = [];
    for(let i=0;i<rowsArrEnt.length;i++){
      const arr = rowsArrEnt[i];
      let obj = {...objsEnt[i]} || {}; // Criar c√≥pia para n√£o modificar o original
      
      // Extrair n√∫mero do contrato de "INFORMA√á√ïES DESTINO"
      let contratoNumero = '';
      if(infoDestinoKey && obj[infoDestinoKey]) {
        // Extrair o n√∫mero antes do primeiro tra√ßo
        const valorDestino = obj[infoDestinoKey];
        if(valorDestino.includes('-')) {
          contratoNumero = valorDestino.split('-')[0].trim();
        } else {
          contratoNumero = valorDestino;
        }
      } else {
        // Fallback: tentar pegar da coluna B (√≠ndice 1)
        if(arr[1] !== undefined) {
          contratoNumero = arr[1];
        }
      }
      
      // Adicionar o n√∫mero do contrato ao objeto
      obj[contratoKey] = contratoNumero;

      // get saldo: prefer normalized header, else fallback to index 8
      let saldoVal = '';
      if(saldoKeyEnt && obj[saldoKeyEnt] !== undefined && obj[saldoKeyEnt] !== '') saldoVal = obj[saldoKeyEnt];
      else if(arr[saldoIndexEnt] !== undefined) saldoVal = arr[saldoIndexEnt];
      const n = parseNumber(saldoVal || '0');
      if(!isNaN(n) && n > 0){
        rowsObjEntFiltered.push(obj);
        rowsArrEntFiltered.push(arr);
      }
    }

    // Adicionar a nova coluna de contrato aos cabe√ßalhos
    if(!headersNormEnt.includes(contratoKey)) {
      headersNormEnt.push(contratoKey);
      headersOrigEnt.push('N¬∫ CONTRATO');
    }

    // define removed and hidden for entrega
    const hiddenEnt = HIDDEN_COLS.map(normalizeHeader);

    // For√ßar inclus√£o da coluna de contrato
    const forceIncludeEnt = [contratoKey];

    const tableEntHTML = buildTableHTML(rowsArrEntFiltered, rowsObjEntFiltered, headersOrigEnt, headersNormEnt, {
      hiddenNorm: hiddenEnt,
      removedNorm: removedEnt,
      numericKey: saldoKeyEnt || headersNormEnt[saldoIndexEnt] || '',
      forceInclude: forceIncludeEnt
    });

    document.getElementById('entregaContent').innerHTML = tableEntHTML || '<div class="empty">Nenhum lote de entrega em aberto.</div>';

    // ===== LOTES DE RETIRADA =====
    const ret = await fetchSheetByGid(GIDS.retirada);
    const rowsArrRet = ret.arrays;
    const headersOrigRet = ret.headersOrig;
    const headersNormRet = ret.headersNorm;
    const objsRet = ret.objects;

    // Remove INFORMA√á√ïES ORIGEM from display: normalized key might be like 'informacoesdaorigem' etc
    const removedRet = [...REMOVED_COMMON.map(normalizeHeader)];
    // Also remove 'informacoesdaorigem' by trying to detect headers containing 'origem' or exact phrase
    const possOrigem = headersNormRet.find(h => h.includes('origem') && (h.includes('informacao') || h.includes('informacoes')));
    if(possOrigem) removedRet.push(possOrigem);

    // Hidden columns: nfp, royalties, safra (normalized)
    const hiddenRet = HIDDEN_COLS.map(normalizeHeader);

    // saldo retirada key detection fallback index (J -> index 9)
    const saldoKeyRet = findHeaderKey(headersNormRet, ['saldoret','saldoretkg','saldoretirada']) || null;
    const saldoIndexRet = 9;

    const rowsObjRetFiltered = [];
    const rowsArrRetFiltered = [];
    for(let i=0;i<rowsArrRet.length;i++){
      const arr = rowsArrRet[i];
      const obj = objsRet[i] || {};
      // get saldo
      let saldoVal = '';
      if(saldoKeyRet && obj[saldoKeyRet] !== undefined && obj[saldoKeyRet] !== '') saldoVal = obj[saldoKeyRet];
      else if(arr[saldoIndexRet] !== undefined) saldoVal = arr[saldoIndexRet];
      const n = parseNumber(saldoVal || '0');
      if(!isNaN(n) && n > 0){
        rowsObjRetFiltered.push(obj);
        rowsArrRetFiltered.push(arr);
      }
    }

    const tableRetHTML = buildTableHTML(rowsArrRetFiltered, rowsObjRetFiltered, headersOrigRet, headersNormRet, {
      hiddenNorm: hiddenRet,
      removedNorm: removedRet,
      numericKey: saldoKeyRet || headersNormRet[saldoIndexRet] || ''
    });

    document.getElementById('retiradaContent').innerHTML = tableRetHTML || '<div class="empty">Nenhum lote de retirada em aberto.</div>';

    // ===== PROGRAMA√á√ÉO (somente hoje) =====
    const prog = await fetchSheetByGid(GIDS.programacao);
    const rowsArrProg = prog.arrays;
    const headersOrigProg = prog.headersOrig;
    const headersNormProg = prog.headersNorm;
    const objsProg = prog.objects;

    // Encontrar a coluna "STATUS"
    const statusKey = headersNormProg.find(h => h.includes('status') && !h.includes('agendamento')) || null;
    
    // Encontrar a coluna "FRETE EMPRESA"
    const freteEmpresaKey = headersNormProg.find(h => h.includes('freteempresa') || h.includes('frete') && h.includes('empresa')) || null;

    // find date key (fallback index 0)
    const dateKeyProg = findHeaderKey(headersNormProg, ['data','dataprogramacao','dataprog','dataentrega']) || headersNormProg[0] || null;
    const dateIndexProg = 0;

    const today = new Date(); const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();

    const rowsArrProgFiltered = [];
    const rowsObjProgFiltered = [];
    for(let i=0;i<rowsArrProg.length;i++){
      const arr = rowsArrProg[i];
      const obj = objsProg[i] || {};
      // get date
      let dtVal = '';
      if(dateKeyProg && obj[dateKeyProg]) dtVal = obj[dateKeyProg];
      else if(arr[dateIndexProg] !== undefined) dtVal = arr[dateIndexProg];
      const dt = parseDateOnly(dtVal);
      if(dt && dt.getTime() === todayStart){
        rowsArrProgFiltered.push(arr);
        rowsObjProgFiltered.push(obj);
      }
    }

    // Identificar a pen√∫ltima coluna para remo√ß√£o
    let removedProg = [...REMOVED_COMMON.map(normalizeHeader), ...REMOVED_PROGRAMACAO.map(normalizeHeader)];
    
    // Se tivermos colunas suficientes, remover a pen√∫ltima
    if(headersNormProg.length > 1) {
      // Encontrar a pen√∫ltima coluna vis√≠vel (n√£o removida)
      const visibleCols = headersNormProg.filter(h => !removedProg.includes(h));
      if(visibleCols.length > 1) {
        const penultimaCol = visibleCols[visibleCols.length - 2];
        removedProg.push(penultimaCol);
      }
    }

    // Contar status para os cards
    const statusCounts = countStatusProgramacao(rowsObjProgFiltered, statusKey);
    document.getElementById('count-carregado').textContent = statusCounts.carregado;
    document.getElementById('count-embarque').textContent = statusCounts.embarque;
    document.getElementById('count-transito').textContent = statusCounts.transito;

    // Build programacao table: remove removedProg columns, format status and currency
    const tableProgHTML = buildTableHTML(rowsArrProgFiltered, rowsObjProgFiltered, headersOrigProg, headersNormProg, {
      hiddenNorm: HIDDEN_COLS.map(normalizeHeader),
      removedNorm: removedProg,
      numericKey: '',
      currencyCols: freteEmpresaKey ? [freteEmpresaKey] : [],
      statusCol: statusKey
    });

    document.getElementById('programacaoContent').innerHTML = tableProgHTML || '<div class="empty">Nenhuma programa√ß√£o para hoje.</div>';
    
    // Inicialmente colapsar todas as se√ß√µes
    document.getElementById('content-entrega').classList.add('collapsed');
    document.getElementById('content-retirada').classList.add('collapsed');
    document.getElementById('content-programacao').classList.add('collapsed');
    
    document.getElementById('toggle-entrega').classList.add('collapsed');
    document.getElementById('toggle-retirada').classList.add('collapsed');
    document.getElementById('toggle-programacao').classList.add('collapsed');
  }
  catch(err){
    console.error('Erro loadAll:', err);
    document.getElementById('entregaContent').innerHTML = '<div class="empty">Erro ao carregar dados (ver console).</div>';
    document.getElementById('retiradaContent').innerHTML = '<div class="empty">Erro ao carregar dados (ver console).</div>';
    document.getElementById('programacaoContent').innerHTML = '<div class="empty">Erro ao carregar dados (ver console).</div>';
  }
}

/* Toggle sections */
function setupToggleHandlers() {
  document.getElementById('toggle-entrega').addEventListener('click', function() {
    toggleSection('entrega');
  });
  
  document.getElementById('toggle-retirada').addEventListener('click', function() {
    toggleSection('retirada');
  });
  
  document.getElementById('toggle-programacao').addEventListener('click', function() {
    toggleSection('programacao');
  });
}

function toggleSection(sectionId) {
  const content = document.getElementById(`content-${sectionId}`);
  const header = document.getElementById(`toggle-${sectionId}`);
  
  const isCollapsed = content.classList.contains('collapsed');
  
  if(isCollapsed) {
    content.classList.remove('collapsed');
    header.classList.remove('collapsed');
  } else {
    content.classList.add('collapsed');
    header.classList.add('collapsed');
  }
}

/* init */
document.getElementById('btnRefresh').addEventListener('click', () => {
  document.getElementById('entregaContent').innerHTML = '<div class="empty">Atualizando...</div>';
  document.getElementById('retiradaContent').innerHTML = '<div class="empty">Atualizando...</div>';
  document.getElementById('programacaoContent').innerHTML = '<div class="empty">Atualizando...</div>';
  loadAll();
});

// Setup toggle handlers after DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  setupToggleHandlers();
  loadAll();
});
</script>
</body>
</html>
