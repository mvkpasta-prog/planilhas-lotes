<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üìä Controle de Lotes e Programa√ß√£o</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root{
      --primary:#2563eb;
      --secondary:#0ea5e9;
      --success:#10b981;
      --warning:#f59e0b;
      --danger:#ef4444;
      --light:#f8fafc;
      --dark:#0f172a;
      --card-shadow:0 10px 30px rgba(16,24,40,0.08);
      --rounded:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif}
    body{background:linear-gradient(135deg,#eef7ff,#fefefe);color:var(--dark);padding:26px}
    .container{max-width:1260px;margin:0 auto}
    h1{font-size:2rem; color:var(--primary); text-align:center;margin-bottom:26px; font-weight:800}
    .btn-refresh{ background:linear-gradient(90deg,var(--primary),var(--secondary)); color:white;border:none;padding:12px 18px;border-radius:12px;cursor:pointer; font-weight:700; display:inline-flex; align-items:center; gap:10px; box-shadow: var(--card-shadow); transition:transform .15s; margin-bottom:24px;}
    .btn-refresh:hover{transform:translateY(-3px)}
    .section{ background:white; border-radius:16px; padding:20px; box-shadow: var(--card-shadow); margin-bottom:24px; transition:0.3s}
    .section:hover{transform:translateY(-2px)}
    .section h2{font-size:1.4rem; color:var(--secondary); margin-bottom:14px; display:flex; align-items:center; gap:8px;}
    .group-container{margin-bottom:16px;border-radius:12px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,0.06)}
    .group-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:#f3f4f6;cursor:pointer;font-weight:600;font-size:1rem;color:#1e293b}
    .group-header i:last-child{transition:0.3s}
    .group-header.expanded i:last-child{ transform: rotate(180deg) }
    .group-content{max-height:0; overflow:hidden; transition:max-height 0.4s ease, padding 0.3s ease;}
    .group-content.open{ padding:12px 16px; max-height:1000px }
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:0.9rem;border-radius:10px;overflow:hidden}
    th, td{border:1px solid #e5e7eb;padding:10px 12px;text-align:left}
    th{background:var(--primary);color:white}
    tr:nth-child(even){background:#f9fafb}
    tr:hover{background:#e0f2fe}
    .status{display:inline-block;padding:6px 10px;border-radius:20px;font-weight:700;font-size:0.82rem;color:white}
    .status-aberto{background:var(--success)}
    .status-pendente{background:var(--warning)}
    .status-concluido{background:var(--primary)}
    .no-data, .loading, .error{padding:18px;text-align:center;color:#475569;font-style:italic}
    .error{color:var(--danger);font-weight:800}
  </style>
</head>
<body>
  <div class="container">
    <h1><i class="fas fa-warehouse"></i> Controle de Lotes e Programa√ß√£o</h1>
    <button id="refreshBtn" class="btn-refresh"><i class="fas fa-sync-alt"></i> Atualizar Dados</button>

    <div class="section">
      <h2><i class="fas fa-calendar-check"></i> Programa√ß√£o</h2>
      <div id="programacao"></div>
    </div>

    <div class="section">
      <h2><i class="fas fa-truck-loading"></i> Lotes de Entrega</h2>
      <div id="lotesEntrega"></div>
    </div>

    <div class="section">
      <h2><i class="fas fa-box-open"></i> Lotes de Retirada</h2>
      <div id="lotesRetirada"></div>
    </div>
  </div>

  <script>
    const SHEET_ID = '1CZZgYJiZic9pyFFTdyldm_gVwn2K-zSGY9uhFJ5Nz6Q';
    const GIDS = {
      lotesRetirada: 585404986,
      lotesEntrega: 271702555,
      programacao: 1183141602
    };
    const containers = {
      lotesRetirada: document.getElementById('lotesRetirada'),
      lotesEntrega: document.getElementById('lotesEntrega'),
      programacao: document.getElementById('programacao')
    };

    function escapeHtml(s){return s ? String(s).replace(/[&<>"'\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#x27;','/':'&#x2F;'}[c])):''}
    function parseDate(s){
      if(!s) return new Date(0);
      s=s.trim();
      if(s.includes('/')){let[d,m,y]=s.split('/').map(Number);return new Date(y,(m||1)-1,d||1)}
      if(s.includes('-')){let[y,m,d]=s.split('-').map(Number);return new Date(y,(m||1)-1,d||1)}
      return new Date(0);
    }

    async function loadSheet(name,gid){
      const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;
      const container=containers[name];
      container.innerHTML='<div class="loading">Carregando dados...</div>';
      try{
        const resp=await fetch(url);
        if(!resp.ok) throw new Error(`Erro ${resp.status}`);
        const txt=await resp.text();
        const rows=txt.split(/\r?\n/).filter(r=>r.trim()!=='');
        if(rows.length<1){container.innerHTML='<div class="no-data">Planilha vazia.</div>';return;}
        const headers=rows[0].split(',').map(h=>h.replace(/^"|"$/g,'').trim());
        const data=[];
        for(let i=1;i<rows.length;i++){
          const cols=rows[i].split(',');
          const row={};
          headers.forEach((h,idx)=>row[h]=(cols[idx]||'').replace(/^"|"$/g,'').trim());
          if(Object.values(row).every(v=>v==='')) continue;
          data.push(row);
        }
        renderTable(name,data,headers);
      }catch(err){
        container.innerHTML=`<div class="error">‚ùå ${escapeHtml(err.message)}</div>`;
      }
    }

    function findColumn(headers,possible){return headers.find(h=>possible.some(p=>h.toLowerCase().includes(p.toLowerCase())))}

    function renderTable(name,data,headers){
      if(!data.length){containers[name].innerHTML='<div class="no-data">Nenhum dado encontrado.</div>';return;}

      if(name==='lotesRetirada'){
        const col=findColumn(headers,['saldo ret']);
        if(!col){containers[name].innerHTML='<div class="error">Coluna de "Saldo Retirada" n√£o encontrada.</div>';return;}
        const filtered=data.filter(r=>{
          const v=(r[col]||'').replace(/\s/g,'').replace(',','.');
          const n=parseFloat(v);
          return !isNaN(n)&&n>0;
        });
        if(!filtered.length){containers[name].innerHTML='<div class="no-data">Nenhum lote de retirada em aberto.</div>';return;}
        containers[name].innerHTML=groupBlock('retirada-aberto','ABERTO',filtered,col);
      }

      if(name==='lotesEntrega'){
        const col=findColumn(headers,['saldo entrega']);
        if(!col){containers[name].innerHTML='<div class="error">Coluna de "Saldo Entrega" n√£o encontrada.</div>';return;}
        const filtered=data.filter(r=>{
          const v=(r[col]||'').replace(/\s/g,'').replace(',','.');
          const n=parseFloat(v);
          return !isNaN(n)&&n>0;
        });
        if(!filtered.length){containers[name].innerHTML='<div class="no-data">Nenhum lote de entrega em aberto.</div>';return;}
        containers[name].innerHTML=groupBlock('entrega-aberto','ABERTO',filtered,col);
      }

      if(name==='programacao'){
        const col=findColumn(headers,['data']);
        if(!col){containers[name].innerHTML='<div class="error">Coluna de "Data" n√£o encontrada.</div>';return;}
        const today=new Date(); today.setHours(0,0,0,0);
        const filtered=data.filter(r=>parseDate(r[col])>=today);
        if(!filtered.length){containers[name].innerHTML='<div class="no-data">Nenhuma programa√ß√£o futura.</div>';return;}
        const groups={};
        filtered.forEach(r=>{
          const d=r[col];
          if(!groups[d]) groups[d]=[];
          groups[d].push(r);
        });
        let html='';
        Object.keys(groups).forEach((g,i)=>{
          html+=groupBlock('prog-'+i,g,groups[g],col);
        });
        containers[name].innerHTML=html;
      }

      document.querySelectorAll('.group-header').forEach(h=>{
        h.onclick=()=>{
          const content=document.getElementById(h.dataset.group);
          h.classList.toggle('expanded');
          content.classList.toggle('open');
        }
      });
    }

    function groupBlock(id,title,data,highlightCol){
      return `
        <div class="group-container">
          <div class="group-header" data-group="${id}">
            <i class="fas fa-folder-open"></i> ${escapeHtml(title)} (${data.length})
            <i class="fas fa-chevron-down"></i>
          </div>
          <div id="${id}" class="group-content">
            ${renderDataTable(data,highlightCol)}
          </div>
        </div>
      `;
    }

    function renderDataTable(data,highlightCol){
      const headers=Object.keys(data[0]);
      let html='<table><thead><tr>';
      headers.forEach(h=>html+=`<th>${escapeHtml(h)}</th>`);
      html+='</tr></thead><tbody>';
      data.forEach(r=>{
        html+='<tr>';
        headers.forEach(h=>{
          let v=r[h]||'';
          let disp=escapeHtml(v);
          if(h===highlightCol){
            const n=parseFloat(String(v).replace(/\s/g,'').replace(',','.'));
            if(!isNaN(n)&&n>0) disp=`<span class="status status-aberto">${escapeHtml(v)}</span>`;
          }
          html+=`<td>${disp}</td>`;
        });
        html+='</tr>';
      });
      html+='</tbody></table>';
      return html;
    }

    document.getElementById('refreshBtn').onclick=()=>{
      for(const k in GIDS) loadSheet(k,GIDS[k]);
    };
    window.onload=()=>{for(const k in GIDS) loadSheet(k,GIDS[k]);};
  </script>
</body>
</html>
