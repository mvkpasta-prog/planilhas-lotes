<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controle de Lotes ‚Äî Entrega & Retirada</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  :root{
    --primary:#2563eb; --accent:#0ea5e9; --bg:#f6fbff; --card:#fff; --text:#0f172a;
    --muted:#6b7280; --success:#10b981; --warning:#f59e0b;
    --status-carregado: #10b981; /* Verde */
    --status-embarque: #3b82f6; /* Azul */
    --status-transito: #ef4444; /* Vermelho */
    --status-contratar: #f97316; /* Laranja */
    --produto-soja: #10b981; /* Verde para Soja */
    --produto-milho: #fbbf24; /* Amarelo para Milho */
    --produto-sorgo: #6b7280; /* Cinza para Sorgo */
    --produto-total: #8b5cf6; /* Roxo para Total */
  }
  *{box-sizing:border-box}
  body{font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;margin:0;background:var(--bg);color:var(--text);padding:12px}
  /* Estilo do Logo MVK como Background/Watermark */
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('https://raw.githubusercontent.com/mvkpasta-prog/planilhas-lotes/main/mvklogo.png');
    background-repeat: no-repeat;
    background-position: center center;
    background-size: 80vh;
    opacity: 0.05;
    z-index: -1;
    pointer-events: none;
  }
  header{
    background:linear-gradient(90deg,var(--primary),var(--accent));
    color:white;
    padding:12px;
    border-radius:8px;
    margin-bottom:16px;
    text-align:center;
    font-weight:700;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    position: relative;
  }
  .header-title {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  /* NOVO: Estilo para o link de navega√ß√£o no cabe√ßalho */
  .header-nav {
      /* Flexbox para garantir que o link e o status fiquem alinhados */
      display: flex;
      align-items: center;
      gap: 16px; /* Espa√ßo entre o link de navega√ß√£o e o status */
  }
  .header-link {
    color: white; /* Cor branca para contraste */
    text-decoration: none; /* Sem sublinhado */
    font-size: 14px; /* Tamanho da fonte */
    font-weight: 700;
    padding: 6px 10px; /* Preenchimento para √°rea de clique */
    border-radius: 6px;
    background-color: rgba(255, 255, 255, 0.2); /* Fundo sutil */
    transition: background-color 0.2s ease;
  }
  .header-link:hover {
    background-color: rgba(255, 255, 255, 0.35); /* Escurece um pouco no hover */
  }
  .last-update-top {
    font-size: 12px;
    color: rgba(255,255,255,0.9);
    display: flex;
    align-items:center;
    gap: 6px;
  }
  .updating .last-update-top i{
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    to {transform: rotate(360deg);}
  }
  
  .wrap{max-width:1400px;margin:0 auto;width:100%}
  .actions{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px}
  .btn{background:var(--primary);color:#fff;border:0;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:700;font-size:14px}
  .btn:hover{opacity:.95}
  /* Cards de Status no topo - vers√£o compacta */
  .status-cards{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px}
  .status-card{background:var(--card);border-radius:8px;padding:10px;box-shadow:0 3px 8px rgba(0,0,0,0.06);flex:1;min-width:150px;text-align:center;transition:all 0.3s ease}
  .status-card:hover{transform:translateY(-2px);box-shadow:0 5px 12px rgba(0,0,0,0.08)}
  .status-card h3{margin:0 0 6px 0;font-size:14px;color:var(--text);font-weight:600}
  .status-card .count{font-size:22px;font-weight:700;margin:6px 0}
  .status-card-carregado{border-top:3px solid var(--status-carregado);}
  .status-card-embarque{border-top:3px solid var(--status-embarque);}
  .status-card-transito{border-top:3px solid var(--status-transito);}
  .status-card-contratar{border-top:3px solid var(--status-contratar);}
  /* Cards de Produtos - vers√£o compacta */
  .produto-cards{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px}
  .produto-card{background:var(--card);border-radius:8px;padding:8px;box-shadow:0 3px 8px rgba(0,0,0,0.06);flex:1;min-width:140px;text-align:center;transition:all 0.3s ease;border-top:3px solid transparent; cursor: pointer;}
  .produto-card:hover{transform:translateY(-2px);box-shadow:0 5px 12px rgba(0,0,0,0.08)}
  .produto-card h3{margin:0 0 4px 0;font-size:13px;color:var(--text);font-weight:600}
  .produto-card .count{font-size:18px;font-weight:700;margin:4px 0}
  .produto-soja{border-top-color: var(--produto-soja);}
  .produto-milho{border-top-color: var(--produto-milho);}
  .produto-sorgo{border-top-color: var(--produto-sorgo);}
  .produto-total{border-top-color: var(--produto-total);}
  /* Se√ß√£o de Clientes e Destinos */
  .clientes-section{margin-bottom:24px}
  .clientes-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-bottom:24px}
  .cliente-card{background:var(--card);border-radius:8px;padding:14px;box-shadow:0 3px 8px rgba(0,0,0,0.06);transition:all 0.3s ease}
  .cliente-card:hover{transform:translateY(-2px);box-shadow:0 5px 12px rgba(0,0,0,0.08)}
  .cliente-name{font-weight:700;font-size:16px;color:var(--text);margin:0 0 6px 0}
  .cliente-destino{font-weight:600;color:var(--accent);margin:0 0 10px 0;font-size:13px}
  .cliente-info{display:flex;justify-content:space-between;margin-bottom:6px;align-items:center}
  .info-label{font-weight:600;color:var(--muted);font-size:12px}
  .info-value{font-weight:700;font-size:13px}
  .cliente-produto{padding:3px 7px;border-radius:5px;font-size:11px;font-weight:600;display:inline-block;margin-top:4px}
  .caminhoes-info{display:flex;gap:8px;margin-top:6px;padding-top:6px;border-top:1px solid #eee}
  .caminhoes-separados{display:flex;gap:6px;align-items:center}
  /* T√≠tulos expans√≠veis */
  .section-header{background:linear-gradient(90deg,var(--primary),var(--accent));color:white;padding:12px;border-radius:8px;margin-bottom:12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-weight:700;transition:all 0.3s ease;font-size:15px}
  .section-header:hover{opacity:0.95}
  .section-header .toggle-icon{transition:transform 0.3s ease}
  .section-header.collapsed .toggle-icon{transform:rotate(-90deg)}
  .section-content{display:block;transition:all 0.3s ease;overflow:hidden}
  .section-content.collapsed{display:none}
  h2{color:var(--primary);margin:6px 0 12px 0;font-size:18px}
  .card{background:var(--card);border-radius:8px;padding:12px;margin-bottom:16px;box-shadow:0 4px 12px rgba(16,24,40,0.06)}
  .table-wrap{overflow-x:auto}
  table{width:100%;border-collapse:collapse;margin:0;font-size:12px;min-width:750px}
  th,td{border:1px solid #e6eefc;padding:8px;text-align:left;vertical-align:top}
  th{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;font-weight:700;white-space:nowrap}
  tr:nth-child(even){background:#fbfdff}
  .status{display:inline-block;padding:5px 9px;border-radius:14px;color:#fff;font-weight:700;font-size:11px}
  .status-aberto{background:var(--warning)}
  .status-fechado{background:var(--success)}
  /* Estilos para os status de programa√ß√£o */
  .status-programacao{display:inline-block;padding:5px 10px;border-radius:14px;color:#fff;font-weight:700;font-size:11px;min-width:90px;text-align:center}
  .status-carregado{background-color: var(--status-carregado);}
  .status-embarque{background-color: var(--status-embarque);}
  .status-transito{background-color: var(--status-transito);}
  .status-contratar{background-color: var(--status-contratar);}
  .empty{color:var(--muted);font-style:italic;padding:10px}
  
  @media (max-width:900px){
    table{min-width:650px}
    th, td{padding:6px;font-size:11px}
    .status-cards, .produto-cards{flex-direction:column}
    .clientes-container{grid-template-columns:1fr}
    .cliente-card{min-width:260px}
  }
  @media (max-width:600px){
    body{padding:8px}
    .section-header{padding:10px;font-size:14px}
    .cliente-card{min-width:100%;padding:12px}
    .status-card{min-width:140px;padding:10px}
    .produto-card{min-width:130px;padding:8px}
    /* Ajuste para cabe√ßalho em telas pequenas */
    header {
      flex-direction: column;
      align-items: flex-start;
    }
    .header-nav {
      width: 100%;
      justify-content: space-between;
      margin-top: 8px;
    }
    .header-link {
      font-size: 13px;
      padding: 5px 8px;
    }
  }
</style>
</head>
<body>
  <header>
    <div class="header-title">
      <img src="https://raw.githubusercontent.com/mvkpasta-prog/planilhas-lotes/main/mvklogo.png" alt="Logo MVK" style="height: 22px; vertical-align: middle; margin-right: 8px;">
      Controle de Lotes ‚Äî Entrega & Retirada
    </div>
    <div class="header-nav">
        <a href="Retiradas.html" class="header-link" target="_self">
            <i class="fas fa-truck-moving"></i> Lotes de Retirada
        </a>
        <div class="last-update-top" id="lastUpdateTop">
          <i class="fas fa-hourglass-half"></i> <span>Atualizando...</span>
        </div>
    </div>
  </header>
  <div class="wrap">
    <div class="status-cards">
      <div class="status-card status-card-carregado">
        <h3>CARREGADO</h3>
        <div class="count" id="count-carregado">0</div>
      </div>
      <div class="status-card status-card-embarque">
        <h3>NO EMBARQUE</h3>
        <div class="count" id="count-embarque">0</div>
      </div>
      <div class="status-card status-card-transito">
        <h3>EM TR√ÇNSITO</h3>
        <div class="count" id="count-transito">0</div>
      </div>
      <div class="status-card status-card-contratar">
        <h3>CONTRATAR</h3>
        <div class="count" id="count-contratar">0</div>
      </div>
    </div>
    <div class="produto-cards">
      <div class="produto-card produto-soja">
        <h3>SOJA</h3>
        <div class="count" id="count-soja">0 KG</div>
      </div>
      <div class="produto-card produto-milho">
        <h3>MILHO</h3>
        <div class="count" id="count-milho">0 KG</div>
      </div>
      <div class="produto-card produto-sorgo">
        <h3>SORGO</h3>
        <div class="count" id="count-sorgo">0 KG</div>
      </div>
      <div class="produto-card produto-total" id="card-total-embarcado">
        <h3>TOTAL EMBARCADO</h3>
        <div class="count" id="count-total">0 KG</div>
      </div>
    </div>
    
    <div class="clientes-section">
      <div class="section-header" id="toggle-clientes">
        <span>Resumo por Cliente e Destino</span>
        <i class="fas fa-chevron-down toggle-icon"></i>
      </div>
      <div class="section-content card" id="content-clientes">
          <div class="clientes-container" id="clientesContainer">
          </div>
      </div>
    </div>
    
    <div class="section-header" id="toggle-programacao">
      <span>üöú Lotes em Programa√ß√£o</span>
      <i class="fas fa-chevron-down toggle-icon"></i>
    </div>
    <div class="section-content card collapsed" id="content-programacao">
      <div id="programacaoContent" class="table-wrap"></div>
    </div>
    
    <div class="section-header" id="toggle-entrega">
      <span>üöö Lotes de Entrega</span>
      <i class="fas fa-chevron-down toggle-icon"></i>
    </div>
    <div class="section-content card collapsed" id="content-entrega">
      <div id="entregaContent" class="table-wrap"></div>
    </div>
    
    <div class="section-header" id="toggle-retirada">
      <span>üöõ Lotes de Retirada</span>
      <i class="fas fa-chevron-down toggle-icon"></i>
    </div>
    <div class="section-content card collapsed" id="content-retirada">
      <div id="retiradaContent" class="table-wrap"></div>
    </div>
    
  </div>
<script>
/* ====== CONFIG - coloque aqui seu SHEET_ID se mudar ====== */
const SHEET_ID = '1o0wF2ScSkyxqY8FHFI-rA6k_3uMI2wsZr2wQG8JD4B4';
const GIDS = {
  programacao: '0',        // aba PROGRAMA√á√ÉO
  entrega: '1906952763',   // aba LOTES ENTREGA
  retirada: '1984691910'   // aba LOTES RETIRADA
};
// Configura√ß√£o do intervalo de atualiza√ß√£o autom√°tica (em milissegundos)
const AUTO_UPDATE_INTERVAL = 300000;
/* colunas que ficam ocultas em exibi√ß√£o (aparecem em detalhes) - normalizadas */
const HIDDEN_COLS = ['idorigemymvk1', 'numero_contrato', 'contrato', 'localizacao'];
/* colunas removidas (normalizadas) de todas as tabelas */
const REMOVED_COMMON = ['safra', 'royalties'];
/* Vari√°vel global para armazenar os totais de produto para a funcionalidade de clique */
let globalProdutosTotais = { soja: 0, milho: 0, sorgo: 0, total: 0 };

/* --- FUN√á√ïES UTILIT√ÅRIAS MANTIDAS --- */

/* Normaliza cabe√ßalho: remove acento, espa√ßos e pontua√ß√£o */
function normalizeHeader(h){
  if(h === undefined || h === null) return '';
  return String(h).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,'');
}
/* Normaliza texto: remove acentos ‚Äî reutiliz√°vel para status */
function normalizeText(text) {
  if(text === undefined || text === null) return '';
  return String(text).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
}
/* Parse CSV tolerante (trata v√≠rgulas dentro de aspas) */
function parseCSV(text){
  if(!text) return {arrays:[], headersOrig:[], headersNorm:[], objects:[]};
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
  if(lines.length === 0) return {arrays:[], headersOrig:[], headersNorm:[], objects:[]};
  // Split com Regex para considerar v√≠rgulas apenas fora de aspas.
  const parsed = lines.map(line => line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"|"$/g,'').trim()));
  const headersOrig = parsed.shift().map(h => h||'');
  const headersNorm = headersOrig.map(h => normalizeHeader(h));
  const objects = parsed.map(cells => {
    const obj = {};
    headersNorm.forEach((key, idx) => {
      obj[key] = cells[idx] !== undefined ? cells[idx] : '';
    });
    return obj;
  });
  return {arrays: parsed, headersOrig, headersNorm, objects};
}
/* fetch CSV via gviz - retorna parseCSV result */
async function fetchSheetByGid(gid){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('Erro ao buscar planilha: ' + r.status);
  const text = await r.text();
  return parseCSV(text);
}
/* util: parse number tolerant */
function parseNumber(val){
  if(val === undefined || val === null) return NaN;
  const s = String(val).replace(/\s/g,'').replace(/\./g,'').replace(/,/g,'.');
  const n = parseFloat(s.replace(/[^\d\.\-]/g,''));
  return isNaN(n) ? NaN : n;
}
/* Formata n√∫mero com separadores de milhar */
function formatNumber(value) {
  if(isNaN(value)) return '0';
  return new Intl.NumberFormat('pt-BR').format(Math.round(value));
}
/* Formata n√∫mero como moeda brasileira */
function formatCurrencyBRL(value) {
  if (isNaN(value)) return value;
  return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL'
  }).format(value);
}
function escapeHtml(s){
  if(s === undefined || s === null) return '';
  return String(s).replace(/[&<>"'\/]/g, c => ({'&':'&amp;','<':'<','>':'>','"':'&quot;',"'":'&#x2F;'}[c]));
}

/* build table HTML: rowsArrays = array of arrays; rowsObjects = array of objects keyed by normalized headers */
function buildTableHTML(rowsArrays, rowsObjects, headersOrig, headersNorm, opts){
  const hiddenNorm = opts.hiddenNorm || [];
  const removedNorm = opts.removedNorm || [];
  const numericKey = opts.numericKey || '';
  const forceInclude = opts.forceInclude || [];
  const currencyCols = opts.currencyCols || [];
  const statusCol = opts.statusCol || '';
  
  const visible = headersNorm.filter(h => !removedNorm.includes(h));
  let displayCols = visible.filter(h => !hiddenNorm.includes(h));
  
  forceInclude.forEach(fc => {
    if(visible.includes(fc) && !displayCols.includes(fc)) displayCols.unshift(fc);
    else if(visible.includes(fc)) displayCols = [fc, ...displayCols.filter(x => x !== fc)];
  });
  if(displayCols.length === 0){
    return '<div class="empty">Sem colunas para exibir.</div>';
  }
  
  let html = '<table><thead><tr>';
  displayCols.forEach(h => {
    const idx = headersNorm.indexOf(h);
    const title = (idx>=0 ? headersOrig[idx] : h) || h;
    html += `<th>${escapeHtml(title)}</th>`;
  });
  if(numericKey) html += '<th>Status</th>';
  html += '</tr></thead><tbody>';
  
  rowsObjects.forEach((obj, i) => {
    const arr = rowsArrays[i] || [];
    // O status de FECHADO/ABERTO aqui depende do `numericKey` (ex: Saldo)
    const isClosed = numericKey ? (parseNumber(arr[headersNorm.indexOf(numericKey)] || '0') <= 0) : false;

    html += `<tr class="${isClosed ? 'status-fechado' : 'status-aberto'}">`;
    displayCols.forEach(h => {
      const idx = headersNorm.indexOf(h);
      let value = (obj[h] !== undefined && obj[h] !== '') ? obj[h] : (arr[idx] !== undefined ? arr[idx] : '');
      
      if(currencyCols.includes(h)) {
        const numValue = parseNumber(value);
        if(!isNaN(numValue)) {
          value = formatCurrencyBRL(numValue);
        }
      }
      
      if(h === statusCol) {
        // L√≥gica de formata√ß√£o de status de programa√ß√£o
        const statusNorm = normalizeText(value);
        let statusClass = 'status-contratar';
        if (statusNorm.includes('carregado') || statusNorm.includes('completo')) statusClass = 'status-carregado';
        else if (statusNorm.includes('embarque')) statusClass = 'status-embarque';
        else if (statusNorm.includes('transito')) statusClass = 'status-transito';

        html += `<td><span class="status-programacao ${statusClass}">${escapeHtml(value)}</span></td>`;
      } else {
        html += `<td>${escapeHtml(value)}</td>`;
      }
    });
    // Coluna Status final:
    if(numericKey) {
        html += `<td>${isClosed ? '<span class="status status-fechado">FECHADO</span>':'<span class="status status-aberto">ABERTO</span>'}</td>`;
    }
    html += '</tr>';
  });
  html += '</tbody></table>';
  return html;
}

/* Agrupa dados de Programa√ß√£o e Entrega por Contrato / Destino */
function groupByContract(rowsArrProg, rowsArrEnt, headersNormProg, headersNormEnt) {
  const grupos = {};
  
  // 1. Processar PROGRAMA√á√ÉO
  rowsArrProg.forEach(arr => {
    const contrato = arr[headersNormProg.indexOf('numero_contrato')] || 'Contrato Desconhecido';
    const produto = arr[headersNormProg.indexOf('produto')] || 'Produto Desconhecido';
    const peso = parseNumber(arr[headersNormProg.indexOf('peso')]) || 0;
    const frete = parseNumber(arr[headersNormProg.indexOf('valorfrete')]) || 0;
    const destino = arr[headersNormProg.indexOf('destinofinal')] || 'Destino Desconhecido';
    const status = normalizeText(arr[headersNormProg.indexOf('status')] || '');
    const numCaminhao = arr[headersNormProg.indexOf('numero_caminhao')] || '';

    if(!grupos[contrato]) {
      grupos[contrato] = {
        contrato,
        destino,
        produtos: new Set(),
        pesoProgramado: 0,
        pesoEmbarcado: 0,
        valorFrete: 0,
        caminhoes: new Set(),
        statusContador: {carregado: 0, embarque: 0, transito: 0, contratar: 0}
      };
    }
    grupos[contrato].produtos.add(produto);
    grupos[contrato].pesoProgramado += peso;
    grupos[contrato].valorFrete += frete;
    if(numCaminhao) grupos[contrato].caminhoes.add(numCaminhao);

    // Contar status
    if (status.includes('carregado') || status.includes('completo')) grupos[contrato].statusContador.carregado++;
    else if (status.includes('embarque')) grupos[contrato].statusContador.embarque++;
    else if (status.includes('transito')) grupos[contrato].statusContador.transito++;
    else grupos[contrato].statusContador.contratar++;
  });

  // 2. Processar ENTREGA para atualizar o peso embarcado
  const pesoEmbarcadoIndex = headersNormEnt.indexOf('pesoembarcado') || headersNormEnt.indexOf('quantidadeembarcada');
  const contratoIndexEnt = headersNormEnt.indexOf('numero_contrato') || headersNormEnt.indexOf('contrato'); // Pode ser 'contrato' ou 'numero_contrato'
  
  rowsArrEnt.forEach(arr => {
    const contrato = arr[contratoIndexEnt] || 'Contrato Desconhecido';
    const pesoEmbarcado = parseNumber(arr[pesoEmbarcadoIndex] || '0');
    
    if(grupos[contrato]) {
      grupos[contrato].pesoEmbarcado += pesoEmbarcado;
    } 
    // Se n√£o estiver na programa√ß√£o, ignora (o foco √© o contrato da programa√ß√£o)
  });

  // Finalizar
  const resumo = Object.values(grupos).map(grupo => ({
    ...grupo,
    pesoProgramado: Math.round(grupo.pesoProgramado),
    pesoEmbarcado: Math.round(grupo.pesoEmbarcado),
    pesoRestante: Math.round(grupo.pesoProgramado - grupo.pesoEmbarcado),
    produtos: Array.from(grupo.produtos).join(' / '),
    numCaminhoes: grupo.caminhoes.size
  })).sort((a, b) => b.pesoProgramado - a.pesoProgramado);

  return resumo;
}

/* Extrair produto do texto (√∫ltima parte ap√≥s o √∫ltimo tra√ßo) */
function extractProduto(text) {
  if(!text) return '';
  return normalizeText(text); // Apenas normalizamos para compara√ß√£o
}

/* Calcula os totais de SOJA, MILHO, SORGO, e o total geral de peso embarcado (usando LOTES ENTREGA) */
function calculateProdutosTotais(rowsArrEnt, headersNormEnt) {
    let soja = 0, milho = 0, sorgo = 0;
    
    // Mapeamento dos √≠ndices
    const produtoIndex = headersNormEnt.indexOf('produto');
    const pesoEmbarcadoIndex = headersNormEnt.indexOf('pesoembarcado') || headersNormEnt.indexOf('quantidadeembarcada');

    rowsArrEnt.forEach(arr => {
        const produtoText = arr[produtoIndex] ? arr[produtoIndex].trim() : '';
        const produtoNorm = extractProduto(produtoText);
        const peso = parseNumber(arr[pesoEmbarcadoIndex] || '0');
        
        if(isNaN(peso)) return;
        
        // Somar ao produto correspondente
        if(produtoNorm.includes('soja')) {
          soja += peso;
        } else if(produtoNorm.includes('milho')) {
          milho += peso;
        } else if(produtoNorm.includes('sorgo')) {
          sorgo += peso;
        }
    });
    return {soja, milho, sorgo};
}

/* Gerar HTML para os cards de resumo de Contrato/Destino */
function buildResumoClientesHTML(resumos) {
  if(resumos.length === 0) {
    return '<div class="empty">Nenhuma programa√ß√£o de contrato encontrada.</div>';
  }
  let html = '';
  resumos.forEach(resumo => {
    // Definir cor do produto (simples, pega o primeiro)
    let corProduto = '#6b7280'; // Cinza padr√£o
    const produtoUp = (resumo.produtos || '').toUpperCase();
    if(produtoUp.includes('SOJA')) {
      corProduto = 'var(--produto-soja)'; // Verde para Soja
    } else if(produtoUp.includes('MILHO')) {
      corProduto = 'var(--produto-milho)'; // Amarelo para Milho
    } else if(produtoUp.includes('SORGO')) {
      corProduto = 'var(--produto-sorgo)'; // Cinza para Sorgo
    }

    const isFinalizado = resumo.pesoRestante <= 0;
    const statusFinalizadoClass = isFinalizado ? 'status-fechado' : 'status-aberto';
    const statusFinalizadoText = isFinalizado ? 'FINALIZADO' : 'ABERTO';
    
    // Total de carregamentos:
    const totalCarregamentos = Object.values(resumo.statusContador).reduce((a, b) => a + b, 0);

    html += `
      <div class="cliente-card">
        <h3 class="cliente-name">${escapeHtml(resumo.contrato)} <span class="status ${statusFinalizadoClass}" style="margin-left: 10px; font-size: 11px;">${statusFinalizadoText}</span></h3>
        <div class="cliente-destino">üìç ${escapeHtml(resumo.destino)}</div>
        <div class="cliente-info">
          <span class="info-label">Produto:</span>
          <span class="info-value">
             <span class="cliente-produto" style="background-color: ${corProduto}; color: white;">${escapeHtml(resumo.produtos)}</span>
          </span>
        </div>
        <div class="cliente-info">
          <span class="info-label">Peso Programado:</span>
          <span class="info-value">${formatNumber(resumo.pesoProgramado)} KG</span>
        </div>
        <div class="cliente-info">
          <span class="info-label">Peso Embarcado:</span>
          <span class="info-value">${formatNumber(resumo.pesoEmbarcado)} KG</span>
        </div>
        <div class="cliente-info" style="margin-top: 6px; padding-top: 6px; border-top: 1px dashed #ddd; font-weight: 700;">
          <span class="info-label" style="font-weight: 700;">SALDO:</span>
          <span class="info-value" style="color: ${resumo.pesoRestante > 0 ? 'var(--primary)' : 'var(--success)'};">${formatNumber(resumo.pesoRestante)} KG</span>
        </div>
        <div class="caminhoes-info">
          <div class="caminhoes-separados">
            <i class="fas fa-truck" style="color: var(--muted);"></i>
            <span class="info-label">${resumo.numCaminhoes}</span>
            <span class="info-label">/ ${totalCarregamentos}</span>
          </div>
          <div class="caminhoes-separados" title="Carregado">
            <i class="fas fa-check-circle" style="color: var(--status-carregado);"></i>
            <span class="info-label">${resumo.statusContador.carregado}</span>
          </div>
          <div class="caminhoes-separados" title="No Embarque">
            <i class="fas fa-warehouse" style="color: var(--status-embarque);"></i>
            <span class="info-label">${resumo.statusContador.embarque}</span>
          </div>
          <div class="caminhoes-separados" title="Em Tr√¢nsito">
            <i class="fas fa-road" style="color: var(--status-transito);"></i>
            <span class="info-label">${resumo.statusContador.transito}</span>
          </div>
        </div>
      </div>
    `;
  });
  return html;
}

/* Atualizar o texto da √∫ltima atualiza√ß√£o (no topo) */
function updateLastUpdateTime() {
  const now = new Date();
  const timeString = now.toLocaleTimeString('pt-BR');
  const dateString = now.toLocaleDateString('pt-BR');
  document.getElementById('lastUpdateTop').innerHTML = `
    <i class="fas fa-check-circle" style="color: rgba(255,255,255,0.9);"></i>
    <span>√öltima atualiza√ß√£o: ${timeString} - ${dateString}</span>
  `;
}

/* --- Main load function --- */
async function loadAll(isAutoUpdate = false){
  try{
    if(isAutoUpdate) {
      document.getElementById('lastUpdateTop').innerHTML = `
        <i class="fas fa-hourglass-half" style="color: rgba(255,255,255,0.9);"></i>
        <span>Atualizando...</span>
      `;
      document.body.classList.add('updating');
    }
    
    // 1. Fetch Programa√ß√£o
    const prog = await fetchSheetByGid(GIDS.programacao);
    const rowsArrProg = prog.arrays;
    const headersOrigProg = prog.headersOrig;
    const headersNormProg = prog.headersNorm;
    const objsProg = prog.objects;
    
    // 2. Fetch Lotes Entrega
    const ent = await fetchSheetByGid(GIDS.entrega);
    const rowsArrEnt = ent.arrays;
    const headersOrigEnt = ent.headersOrig;
    const headersNormEnt = ent.headersNorm;
    const objsEnt = ent.objects;

    // 3. Fetch Lotes Retirada (Dados crus, usados apenas para preencher a tabela)
    const ret = await fetchSheetByGid(GIDS.retirada);
    const rowsArrRet = ret.arrays;
    const headersOrigRet = ret.headersOrig;
    const headersNormRet = ret.headersNorm;
    const objsRet = ret.objects;

    // ===== RESUMO POR CLIENTE E DESTINO =====
    const resumoClientes = groupByContract(rowsArrProg, rowsArrEnt, headersNormProg, headersNormEnt);
    
    document.getElementById('clientesContainer').innerHTML = buildResumoClientesHTML(resumoClientes);
    
    // ===== CONTADORES E TOTAIS DE PRODUTO =====
    
    // Contadores de Status (usa dados de Programa√ß√£o)
    const countCarregado = rowsArrProg.filter(arr => normalizeText(arr[headersNormProg.indexOf('status')] || '').includes('carregado') || normalizeText(arr[headersNormProg.indexOf('status')] || '').includes('completo')).length;
    const countEmbarque = rowsArrProg.filter(arr => normalizeText(arr[headersNormProg.indexOf('status')] || '').includes('embarque')).length;
    const countTransito = rowsArrProg.filter(arr => normalizeText(arr[headersNormProg.indexOf('status')] || '').includes('transito')).length;
    const countContratar = rowsArrProg.filter(arr => !normalizeText(arr[headersNormProg.indexOf('status')] || '').includes('carregado') && !normalizeText(arr[headersNormProg.indexOf('status')] || '').includes('completo') && !normalizeText(arr[headersNormProg.indexOf('status')] || '').includes('embarque') && !normalizeText(arr[headersNormProg.indexOf('status')] || '').includes('transito')).length;

    document.getElementById('count-carregado').textContent = countCarregado;
    document.getElementById('count-embarque').textContent = countEmbarque;
    document.getElementById('count-transito').textContent = countTransito;
    document.getElementById('count-contratar').textContent = countContratar;

    // Calcular totais por produto (usa dados de Entrega)
    const produtosTotais = calculateProdutosTotais(rowsArrEnt, headersNormEnt);
    
    // Armazenar no objeto global para a funcionalidade de clique
    globalProdutosTotais.soja = produtosTotais.soja;
    globalProdutosTotais.milho = produtosTotais.milho;
    globalProdutosTotais.sorgo = produtosTotais.sorgo;
    
    // Calcular e exibir TOTAL EMBARCADO
    const totalEmbarcado = produtosTotais.soja + produtosTotais.milho + produtosTotais.sorgo;
    globalProdutosTotais.total = totalEmbarcado; // Armazenar o total
    
    // Atualizar cards de produto com "KG" ao lado
    document.getElementById('count-soja').textContent = `${formatNumber(produtosTotais.soja)} KG`;
    document.getElementById('count-milho').textContent = `${formatNumber(produtosTotais.milho)} KG`;
    document.getElementById('count-sorgo').textContent = `${formatNumber(produtosTotais.sorgo)} KG`;
    document.getElementById('count-total').textContent = `${formatNumber(totalEmbarcado)} KG`;
    
    // ===== TABELAS COMPLETAS (PROGRAMA√á√ÉO, ENTREGA, RETIRADA) =====
    const removedNorm = REMOVED_COMMON.map(normalizeHeader);
    
    // PROGRAMA√á√ÉO
    const tableProgHTML = buildTableHTML(rowsArrProg, objsProg, headersOrigProg, headersNormProg, {
      hiddenNorm: HIDDEN_COLS.map(normalizeHeader),
      removedNorm: removedNorm,
      statusCol: headersNormProg.indexOf('status') !== -1 ? 'status' : '',
      currencyCols: ['valorfrete'],
      forceInclude: ['numero_contrato', 'produto', 'destino_final', 'peso']
    });
    document.getElementById('programacaoContent').innerHTML = tableProgHTML || '<div class="empty">Nenhuma programa√ß√£o encontrada.</div>';

    // LOTES ENTREGA (Usar 'saldo' ou 'peso_embarcado' para o status de 'FECHADO/ABERTO' aqui n√£o √© o ideal, ent√£o o status ser√° omitido)
    const saldoEntregaKey = headersNormEnt.find(h => h.includes('saldo'));
    const tableEntHTML = buildTableHTML(rowsArrEnt, objsEnt, headersOrigEnt, headersNormEnt, {
      hiddenNorm: HIDDEN_COLS.map(normalizeHeader),
      removedNorm: removedNorm,
      numericKey: saldoEntregaKey, // Se tiver 'saldo', usa
      currencyCols: ['valorfrete'],
      forceInclude: ['numero_contrato', 'produto', 'local_embarque', 'peso_embarcado']
    });
    document.getElementById('entregaContent').innerHTML = tableEntHTML || '<div class="empty">Nenhum lote de entrega encontrado.</div>';

    // LOTES RETIRADA (Usar 'quantidade_a_retirar' para o status de 'FECHADO/ABERTO')
    const saldoRetiradaKey = headersNormRet.find(h => h.includes('quantidadearetirar'));
    const tableRetHTML = buildTableHTML(rowsArrRet, objsRet, headersOrigRet, headersNormRet, {
      hiddenNorm: HIDDEN_COLS.map(normalizeHeader),
      removedNorm: removedNorm,
      numericKey: saldoRetiradaKey, // Usa saldo para status Aberto/Fechado
      forceInclude: ['numero_contrato', 'produto', 'local_embarque', 'quantidadearetirar']
    });
    document.getElementById('retiradaContent').innerHTML = tableRetHTML || '<div class="empty">Nenhum lote de retirada encontrado.</div>';
    
    // Expandir a se√ß√£o principal
    document.getElementById('content-clientes').classList.remove('collapsed');
    document.getElementById('toggle-clientes').classList.remove('collapsed');
    
    // Atualizar o texto da √∫ltima atualiza√ß√£o
    updateLastUpdateTime();
    document.body.classList.remove('updating');
  }
  catch(err){
    console.error('Erro loadAll:', err);
    document.getElementById('clientesContainer').innerHTML = '<div class="empty">Erro ao carregar dados de clientes (ver console).</div>';
    document.getElementById('lastUpdateTop').innerHTML = `
      <i class="fas fa-exclamation-triangle" style="color: rgba(255,255,255,0.9);"></i>
      <span>Erro na atualiza√ß√£o</span>
    `;
    document.body.classList.remove('updating');
  }
}

/* Toggle sections */
function setupToggleHandlers() {
  document.getElementById('toggle-clientes').addEventListener('click', function() {
    toggleSection('clientes');
  });
  document.getElementById('toggle-programacao').addEventListener('click', function() {
    toggleSection('programacao');
  });
  document.getElementById('toggle-entrega').addEventListener('click', function() {
    toggleSection('entrega');
  });
  document.getElementById('toggle-retirada').addEventListener('click', function() {
    toggleSection('retirada');
  });
}
function toggleSection(sectionId) {
  const content = document.getElementById(`content-${sectionId}`);
  const header = document.getElementById(`toggle-${sectionId}`);
  const isCollapsed = content.classList.contains('collapsed');
  if(isCollapsed) {
    content.classList.remove('collapsed');
    header.classList.remove('collapsed');
  } else {
    content.classList.add('collapsed');
    header.classList.add('collapsed');
  }
}

/* Handler para o clique no card de Total Embarcado */
function handleTotalCardClick() {
    const totalString = `Total Embarcado: ${formatNumber(globalProdutosTotais.total)} KG\nSoja: ${formatNumber(globalProdutosTotais.soja)} KG\nMilho: ${formatNumber(globalProdutosTotais.milho)} KG\nSorgo: ${formatNumber(globalProdutosTotais.sorgo)} KG`;
    navigator.clipboard.writeText(totalString)
        .then(() => {
            alert('Resumo do embarque copiado para a √°rea de transfer√™ncia:\n' + totalString);
        })
        .catch(err => {
            console.error('Erro ao copiar: ', err);
            alert('Erro ao copiar. Resumo:\n' + totalString);
        });
}


/* Configurar atualiza√ß√£o autom√°tica */
let autoUpdateInterval;
function startAutoUpdate() {
  // Executar imediatamente ao carregar
  loadAll(true);
  // Configurar intervalo para atualiza√ß√µes subsequentes (5 minutos)
  autoUpdateInterval = setInterval(() => {
    loadAll(true);
  }, AUTO_UPDATE_INTERVAL);
}
/* init */
// Setup toggle handlers and start auto update after DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  setupToggleHandlers();
  // Adicionar handler de clique ao card "TOTAL EMBARCADO"
  document.getElementById('card-total-embarcado').addEventListener('click', handleTotalCardClick);
  startAutoUpdate();
  // Adicionar evento de visibilidade para pausar/recuperar atualiza√ß√µes
  document.addEventListener('visibilitychange', function() {
    if(document.hidden) {
      // Nota: Para manter o comportamento do original, a pausa autom√°tica (clearInterval) n√£o foi implementada
      // para evitar problemas de sincroniza√ß√£o. A atualiza√ß√£o √© apenas for√ßada quando volta a ser vis√≠vel.
    } else {
      // Atualizar imediatamente quando a p√°gina volta a ficar vis√≠vel
      loadAll(true);
    }
  });
});
</script>
</body>
</html>
