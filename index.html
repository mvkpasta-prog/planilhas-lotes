<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Controle de Lotes - Entrega & Retirada</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root{
      --primary:#2563eb;--secondary:#0ea5e9;--bg:#f7fbff;--card:#fff;--text:#0f172a;
      --muted:#6b7280;--success:#10b981;--warning:#f59e0b;
    }
    *{box-sizing:border-box}
    body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;margin:0;background:var(--bg);color:var(--text);padding:18px}
    header{background:linear-gradient(90deg,var(--primary),var(--secondary));color:white;padding:14px;border-radius:10px;margin-bottom:18px;text-align:center;font-weight:700}
    .container{max-width:1200px;margin:0 auto}
    .top-actions{display:flex;justify-content:flex-end;gap:10px;margin-bottom:12px}
    button.refresh{background:var(--primary);color:white;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .section{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(15,23,42,0.06)}
    h2{margin:0 0 10px 0;color:var(--primary);display:flex;align-items:center;gap:8px}
    .card{background:#fff;border-radius:10px;padding:10px;margin-bottom:10px}
    table{width:100%;border-collapse:collapse;font-size:0.92rem}
    th,td{border:1px solid #e6eefc;padding:8px;text-align:left;vertical-align:top}
    th{background:linear-gradient(90deg,var(--primary),var(--secondary));color:#fff;font-weight:700}
    tr:nth-child(even){background:#fbfdff}
    .status{padding:6px 10px;border-radius:18px;color:#fff;font-weight:700;display:inline-block}
    .status-aberto{background:var(--warning)}
    .status-concluido{background:var(--success)}
    .empty{color:var(--muted);font-style:italic;padding:10px}
    .btn-details{background:transparent;border:0;color:var(--primary);cursor:pointer;text-decoration:underline;padding:0}
    .details-row{display:none;background:#f3f7ff}
    .details-row.visible{display:table-row}
    @media(max-width:900px){th,td{font-size:0.82rem}}
  </style>
</head>
<body>
  <header>ðŸ“¦ Controle de Lotes â€” Entrega & Retirada</header>
  <div class="container">
    <div class="top-actions">
      <button class="refresh" id="btnRefresh"><i class="fas fa-sync-alt"></i> Atualizar</button>
    </div>

    <div class="grid">
      <section class="section" id="secProgramacao">
        <h2><i class="fas fa-calendar-check"></i> ProgramaÃ§Ã£o</h2>
        <div id="programacaoContent" class="card"></div>
      </section>

      <section class="section" id="secEntrega">
        <h2><i class="fas fa-truck-loading"></i> Lotes de Entrega</h2>
        <div id="entregaContent" class="card"></div>
      </section>

      <section class="section" id="secRetirada">
        <h2><i class="fas fa-warehouse"></i> Lotes de Retirada</h2>
        <div id="retiradaContent" class="card"></div>
      </section>
    </div>
  </div>

  <script>
  /***********************
   * CONFIG
   ***********************/
  const SHEET_ID = '1CZZgYJiZic9pyFFTdyldm_gVwn2K-zSGY9uhFJ5Nz6Q';
  const GIDS = {
    programacao: '1183141602',
    entrega: '271702555',
    retirada: '585404986'
  };

  // colunas escondidas (aparecem sÃ³ em "detalhes")
  const HIDDEN_COLS = ['nfp','royalties','safra'];

  // colunas removidas de vez
  const REMOVED_COLS = [
    'localizacao','idorigemymvk1',
    'informacoesdestino','situacaoent','iddestino'
  ];

  /***********************
   * Normalizador de cabeÃ§alhos
   ***********************/
  function normalizeHeader(h){
    if(!h && h !== 0) return '';
    return String(h)
      .trim()
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z0-9]/g,'');
  }

  /***********************
   * Parser CSV
   ***********************/
  function parseCSV(text){
    if(!text) return {rows:[], headers:[], originals:[]};
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
    if(lines.length === 0) return {rows:[], headers:[], originals:[]};

    const parsed = lines.map(line => line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"|"$/g,'').trim()));
    const origHeaders = parsed.shift().map(h => h || '');
    const headers = origHeaders.map(h => normalizeHeader(h));

    const rows = parsed.map(cells => {
      const obj = {};
      headers.forEach((key, idx) => {
        obj[key] = (cells[idx] !== undefined) ? cells[idx].replace(/^"|"$/g,'').trim() : '';
      });
      return obj;
    });

    return {rows, headers, originals: origHeaders};
  }

  async function fetchCSV(gid){
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}`;
    const r = await fetch(url);
    const txt = await r.text();
    return parseCSV(txt);
  }

  function parseNumber(val){
    if(val === undefined || val === null) return NaN;
    const s = String(val).replace(/\s/g,'').replace(/\./g,'').replace(/,/g,'.');
    const n = parseFloat(s.replace(/[^\d\.\-]/g,''));
    return isNaN(n) ? NaN : n;
  }

  function renderEmpty(msg){
    return `<div class="empty">${msg}</div>`;
  }

  function findHeaderKey(headers, patterns){
    for(const p of patterns){
      const found = headers.find(h => h.includes(p));
      if(found) return found;
    }
    if(patterns.includes('saldoret')){
      const f = headers.find(h => h.includes('saldo') && (h.includes('ret')||h.includes('retirada')||h.includes('retkg')));
      if(f) return f;
    }
    if(patterns.includes('saldoent')){
      const f = headers.find(h => h.includes('saldo') && (h.includes('ent')||h.includes('entrega')||h.includes('entkg')));
      if(f) return f;
    }
    const f = headers.find(h => h.includes('saldo'));
    if(f) return f;
    return null;
  }

  function buildTableHTML(rows, headers, originals, hiddenNorm, removedNorm, numericKey, mode){
    if(!rows || rows.length === 0) return '';

    const visible = headers.filter(h => !removedNorm.includes(h));
    let displayCols = visible.filter(h => !hiddenNorm.includes(h));

    // garantir NÂº CONTRATO (ncontrato)
    if(visible.includes('ncontrato') && !displayCols.includes('ncontrato')){
      displayCols.unshift('ncontrato');
    }

    let html = '<table><thead><tr>';
    displayCols.forEach(h => {
      const idx = headers.indexOf(h);
      const title = (idx >= 0) ? originals[idx] : h;
      html += `<th>${escapeHtml(title)}</th>`;
    });
    html += '<th>Status</th><th>AÃ§Ãµes</th></tr></thead><tbody>';

    rows.forEach((row, idx) => {
      const n = parseNumber(row[numericKey] || '0');
      html += '<tr>';
      displayCols.forEach(h => {
        html += `<td>${escapeHtml(row[h] || '')}</td>`;
      });
      html += `<td>${n>0 ? `<span class="status status-aberto">Aberto</span>` : `<span class="status status-concluido">ConcluÃ­do</span>`}</td>`;
      html += `<td><button class="btn-details" onclick="toggleDetails('${mode}-${idx}')">Ver Detalhes</button></td>`;
      html += '</tr>';

      let detailsHtml = '';
      hiddenNorm.forEach(h => {
        const idxH = headers.indexOf(h);
        if(idxH >= 0){
          const title = originals[idxH];
          const val = row[h] || '';
          if(val) detailsHtml += `<div><strong>${escapeHtml(title)}:</strong> ${escapeHtml(val)}</div>`;
        }
      });

      if(detailsHtml){
        const colspan = displayCols.length + 2;
        html += `<tr id="details-${mode}-${idx}" class="details-row"><td colspan="${colspan}">${detailsHtml}</td></tr>`;
      }
    });

    html += '</tbody></table>';
    return html;
  }

  function escapeHtml(s){
    if(s === undefined || s === null) return '';
    return String(s).replace(/[&<>"'\/]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#x27;','/':'&#x2F;'}[c]));
  }

  window.toggleDetails = function(id){
    const el = document.getElementById('details-'+id);
    if(!el) return;
    el.classList.toggle('visible');
  };

  async function loadAll(){
    try{
      const progData = await fetchCSV(GIDS.programacao);
      if(!progData.rows.length){
        document.getElementById('programacaoContent').innerHTML = renderEmpty('Nenhuma programaÃ§Ã£o encontrada.');
      } else {
        const html = buildTableHTML(progData.rows, progData.headers, progData.originals, [], [], '', 'prog');
        document.getElementById('programacaoContent').innerHTML = html;
      }
    }catch(e){
      document.getElementById('programacaoContent').innerHTML = `<div class="empty">Erro: ${escapeHtml(e.message||e)}</div>`;
    }

    try{
      const ent = await fetchCSV(GIDS.entrega);
      const rows = ent.rows; const headers = ent.headers; const orig = ent.originals;
      if(!rows.length){
        document.getElementById('entregaContent').innerHTML = renderEmpty('Nenhum dado de entrega.');
      } else {
        const hiddenNorm = HIDDEN_COLS.map(normalizeHeader);
        const removedNorm = REMOVED_COLS.map(normalizeHeader);
        const saldoKey = findHeaderKey(headers, ['saldoent','saldoentrega','saldoentkg']);
        if(!saldoKey){
          document.getElementById('entregaContent').innerHTML = `<div class="empty">Coluna de saldo entrega nÃ£o encontrada.</div>`;
        } else {
          const filtered = rows.filter(r => parseNumber(r[saldoKey]||'0') > 0);
          if(!filtered.length){
            document.getElementById('entregaContent').innerHTML = renderEmpty('Nenhum lote de entrega em aberto.');
          } else {
            const html = buildTableHTML(filtered, headers, orig, hiddenNorm, removedNorm, saldoKey, 'entrega');
            document.getElementById('entregaContent').innerHTML = html;
          }
        }
      }
    }catch(e){
      document.getElementById('entregaContent').innerHTML = `<div class="empty">Erro: ${escapeHtml(e.message||e)}</div>`;
    }

    try{
      const ret = await fetchCSV(GIDS.retirada);
      const rows = ret.rows; const headers = ret.headers; const orig = ret.originals;
      if(!rows.length){
        document.getElementById('retiradaContent').innerHTML = renderEmpty('Nenhum dado de retirada.');
      } else {
        const hiddenNorm = HIDDEN_COLS.map(normalizeHeader);
        const removedNorm = REMOVED_COLS.map(normalizeHeader);
        const saldoKey = findHeaderKey(headers, ['saldoret','saldoretkg','saldoretirada']);
        if(!saldoKey){
          document.getElementById('retiradaContent').innerHTML = `<div class="empty">Coluna de saldo retirada nÃ£o encontrada.</div>`;
        } else {
          const filtered = rows.filter(r => parseNumber(r[saldoKey]||'0') > 0);
          if(!filtered.length){
            document.getElementById('retiradaContent').innerHTML = renderEmpty('Nenhum lote de retirada em aberto.');
          } else {
            const html = buildTableHTML(filtered, headers, orig, hiddenNorm, removedNorm, saldoKey, 'retirada');
            document.getElementById('retiradaContent').innerHTML = html;
          }
        }
      }
    }catch(e){
      document.getElementById('retiradaContent').innerHTML = `<div class="empty">Erro: ${escapeHtml(e.message||e)}</div>`;
    }
  }

  document.getElementById('btnRefresh').addEventListener('click', loadAll);
  loadAll();
  </script>
</body>
</html>
