<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controle de Lotes ‚Äî Entregas</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  :root{
    --primary:#2563eb; --accent:#0ea5e9; --bg:#f6fbff; --card:#fff; --text:#0f172a;
    --muted:#6b7280; --success:#10b981; --warning:#f59e0b;
    --status-carregado: #10b981; /* Verde */
    --status-embarque: #3b82f6; /* Azul */
    --status-transito: #ef4444; /* Vermelho */
    --status-contratar: #f97316; /* Laranja */
    --produto-soja: #10b981; /* Verde para Soja */
    --produto-milho: #fbbf24; /* Amarelo para Milho */
    --produto-sorgo: #6b7280; /* Cinza para Sorgo */
    --produto-total: #8b5cf6; /* Roxo para Total */
  }
  *{box-sizing:border-box}
  body{font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;margin:0;background:var(--bg);color:var(--text);padding:12px}
  /* NOVO: Estilo do Logo MVK como Background/Watermark */
  body::before {
    content: '';
    position: fixed; /* Fixar no viewport */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('https://raw.githubusercontent.com/mvkpasta-prog/planilhas-lotes/main/mvklogo.png');
    background-repeat: no-repeat;
    background-position: center center;
    background-size: 80vh; /* Ocupa 80% da altura do viewport */
    opacity: 0.05; /* N√≠vel de transpar√™ncia para efeito sutil de marca d'√°gua */
    z-index: -1; /* Garantir que fique atr√°s do conte√∫do */
    pointer-events: none; /* Permite interagir com o conte√∫do por baixo */
  }
  header{
    background:linear-gradient(90deg,var(--primary),var(--accent));
    color:white;
    padding:12px;
    border-radius:8px;
    margin-bottom:16px;
    text-align:center;
    font-weight:700;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    position: relative;
    /* Ajuste para alinhar o conte√∫do principal do header e o bot√£o */
    flex-wrap: wrap; 
  }
  .header-title {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .last-update-top {
    font-size: 12px;
    color: rgba(255,255,255,0.9);
    display: flex;
    align-items:center;
    gap: 6px;
  }
  /* Removido o CSS de anima√ß√£o para o spinner */
  .updating .last-update-top i{ /* A classe updating n√£o tem mais efeito de rota√ß√£o */ }
  
  .wrap{max-width:1400px;margin:0 auto;width:100%}
  .actions{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px}
  .btn{background:var(--primary);color:#fff;border:0;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:700;font-size:14px}
  .btn:hover{opacity:.95}
  /* NOVO: Estilo para o bot√£o no header */
  .header-btn {
    background: #fff; /* Fundo branco */
    color: var(--primary); /* Texto na cor prim√°ria */
    border: none;
    padding: 6px 10px; /* Um pouco menor que o btn padr√£o */
    border-radius: 6px;
    cursor: pointer;
    font-weight: 700;
    font-size: 13px; /* Fonte ligeiramente menor */
    text-decoration: none; /* Remover sublinhado do link */
    transition: background 0.2s ease, opacity 0.2s ease;
    white-space: nowrap; /* N√£o quebrar a linha */
  }
  .header-btn:hover {
    background: var(--bg); /* Ligeiro cinza claro no hover */
    opacity: 0.95;
  }
  /* Cards de Status no topo - vers√£o compacta (ligeiramente menores) */
  .status-cards{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px}
  .status-card{background:var(--card);border-radius:8px;padding:10px;box-shadow:0 3px 8px rgba(0,0,0,0.06);flex:1;min-width:150px;text-align:center;transition:all 0.3s ease}
  .status-card:hover{transform:translateY(-2px);box-shadow:0 5px 12px rgba(0,0,0,0.08)}
  .status-card h3{margin:0 0 6px 0;font-size:14px;color:var(--text);font-weight:600}
  .status-card .count{font-size:22px;font-weight:700;margin:6px 0}
  .status-card-carregado{border-top:3px solid var(--status-carregado);}
  .status-card-embarque{border-top:3px solid var(--status-embarque);}
  .status-card-transito{border-top:3px solid var(--status-transito);}
  .status-card-contratar{border-top:3px solid var(--status-contratar);}
  /* Cards de Produtos - vers√£o compacta (ligeiramente menores) */
  .produto-cards{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px}
  .produto-card{background:var(--card);border-radius:8px;padding:8px;box-shadow:0 3px 8px rgba(0,0,0,0.06);flex:1;min-width:140px;text-align:center;transition:all 0.3s ease;border-top:3px solid transparent; cursor: pointer;} /* Adicionado cursor: pointer; */
  .produto-card:hover{transform:translateY(-2px);box-shadow:0 5px 12px rgba(0,0,0,0.08)}
  .produto-card h3{margin:0 0 4px 0;font-size:13px;color:var(--text);font-weight:600}
  .produto-card .count{font-size:18px;font-weight:700;margin:4px 0}
  .produto-soja{border-top-color: var(--produto-soja);}
  .produto-milho{border-top-color: var(--produto-milho);}
  .produto-sorgo{border-top-color: var(--produto-sorgo);}
  .produto-total{border-top-color: var(--produto-total);}
  /* Se√ß√£o de Clientes e Destinos */
  .clientes-section{margin-bottom:24px}
  .clientes-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-bottom:24px}
  .cliente-card{background:var(--card);border-radius:8px;padding:14px;box-shadow:0 3px 8px rgba(0,0,0,0.06);transition:all 0.3s ease}
  .cliente-card:hover{transform:translateY(-2px);box-shadow:0 5px 12px rgba(0,0,0,0.08)}
  .cliente-name{font-weight:700;font-size:16px;color:var(--text);margin:0 0 6px 0} /* AUMENTADO DE 15px para 16px */
  .cliente-destino{font-weight:600;color:var(--accent);margin:0 0 10px 0;font-size:13px}
  .cliente-info{display:flex;justify-content:space-between;margin-bottom:6px;align-items:center}
  .info-label{font-weight:600;color:var(--muted);font-size:12px}
  .info-value{font-weight:700;font-size:13px}
  .cliente-produto{padding:3px 7px;border-radius:5px;font-size:11px;font-weight:600;display:inline-block;margin-top:4px}
  .status-carregado-tag{background-color: var(--status-carregado);color: white;padding: 2px 7px;border-radius: 10px;font-size: 11px;font-weight: 600;}
  .status-pendente-tag{background-color: var(--status-embarque);color: white;padding: 2px 7px;border-radius: 10px;font-size: 11px;font-weight: 600;}
  .caminhoes-info{display:flex;gap:8px;margin-top:6px;padding-top:6px;border-top:1px solid #eee}
  .caminhoes-separados{display:flex;gap:6px;align-items:center}
  /* T√≠tulos expans√≠veis */
  .section-header{background:linear-gradient(90deg,var(--primary),var(--accent));color:white;padding:12px;border-radius:8px;margin-bottom:12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-weight:700;transition:all 0.3s ease;font-size:15px}
  .section-header:hover{opacity:0.95}
  .section-header .toggle-icon{transition:transform 0.3s ease}
  .section-header.collapsed .toggle-icon{transform:rotate(-90deg)}
  .section-content{display:block;transition:all 0.3s ease;overflow:hidden}
  .section-content.collapsed{display:none}
  h2{color:var(--primary);margin:6px 0 12px 0;font-size:18px}
  .card{background:var(--card);border-radius:8px;padding:12px;margin-bottom:16px;box-shadow:0 4p
  x 12px rgba(16,24,40,0.06)}
  .table-wrap{overflow-x:auto}
  table{width:100%;border-collapse:collapse;margin:0;font-size:12px;min-width:750px}
  th,td{border:1px solid #e6eefc;padding:8px;text-align:left;vertical-align:top}
  th{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;font-weight:700;white-space:nowrap}
  tr:nth-child(even){background:#fbfdff}
  .status{display:inline-block;padding:5px 9px;border-radius:14px;color:#fff;font-weight:700;font-size:11px}
  .status-aberto{background:var(--warning)}
  .status-fechado{background:var(--success)}
  /* Estilos para os novos status da programa√ß√£o */
  .status-programacao{display:inline-block;padding:5px 10px;border-radius:14px;color:#fff;font-weight:700;font-size:11px;min-width:90px;text-align:center}
  .status-carregado{background-color: var(--status-carregado);}
  .status-embarque{background-color: var(--status-embarque);}
  .status-transito{background-color: var(--status-transito);}
  .status-contratar{background-color: var(--status-contratar);}
  .empty{color:var(--muted);font-style:italic;padding:10px}
  @media (max-width:900px){
    table{min-width:650px}
    th, td{padding:6px;font-size:11px}
    .status-cards, .produto-cards{flex-direction:column}
    .clientes-container{grid-template-columns:1fr}
    .cliente-card{min-width:260px}
  }
  @media (max-width:600px){
    body{padding:8px}
    .section-header{padding:10px;font-size:14px}
    .cliente-card{min-width:100%;padding:12px}
    .status-card{min-width:140px;padding:10px}
    .produto-card{min-width:130px;padding:8px}
    /* Ajuste para mobile para que o bot√£o e o t√≠tulo do header caibam */
    header {
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
    }
    .header-title {
      width: 100%;
      justify-content: space-between;
    }
    .last-update-top {
      order: 3; /* Move para baixo no mobile */
    }
    .header-btn {
      order: 2; /* Posi√ß√£o intermedi√°ria no mobile */
      width: 100%; /* Ocupa a largura total no mobile */
      text-align: center;
    }
  }
</style>
</head>
<body>
  <header>
    <div class="header-title">
      <img src="https://raw.githubusercontent.com/mvkpasta-prog/planilhas-lotes/main/mvklogo.png" alt="Logo MVK" style="height: 22px; vertical-align: middle; margin-right: 8px;">
      Controle de Lotes ‚Äî Entregas
    </div>
    <a href="lotes de entrega.html" class="header-btn" title="Acessar Lista Detalhada de Entregas">
      üöö Lista de Entregas
    </a>
    <a href="Retiradas.html" class="header-btn" title="Acessar Lotes de Retirada">
      üì¶ Lotes de Retirada
    </a>
    <div class="last-update-top" id="lastUpdateTop">
      <i class="fas fa-hourglass-half"></i> <span>Atualizando...</span>
    </div>
  </header>
  <div class="wrap">
    <div class="status-cards">
      <div class="status-card status-card-carregado">
        <h3>CARREGADO</h3>
        <div class="count" id="count-carregado">0</div>
      </div>
      <div class="status-card status-card-embarque">
        <h3>NO EMBARQUE</h3>
        <div class="count" id="count-embarque">0</div>
      </div>
      <div class="status-card status-card-transito">
        <h3>EM TR√ÇNSITO</h3>
        <div class="count" id="count-transito">0</div>
      </div>
      <div class="status-card status-card-contratar">
        <h3>CONTRATAR</h3>
        <div class="count" id="count-contratar">0</div>
      </div>
    </div>
    <div class="produto-cards">
      <div class="produto-card produto-soja">
        <h3>SOJA</h3>
        <div class="count" id="count-soja">0 KG</div>
      </div>
      <div class="produto-card produto-milho">
        <h3>MILHO</h3>
        <div class="count" id="count-milho">0 KG</div>
      </div>
      <div class="produto-card produto-sorgo">
        <h3>SORGO</h3>
        <div class="count" id="count-sorgo">0 KG</div>
      </div>
      <div class="produto-card produto-total" id="card-total-embarcado">
        <h3>TOTAL EMBARCADO</h3>
        <div class="count" id="count-total">0 KG</div>
      </div>
    </div>
    <div class="clientes-section">
      <div class="clientes-container" id="clientesContainer">
        </div>
    </div>
    <div class="section-header" id="toggle-programacao">
      <span>üóì Programa√ß√£o</span>
      <i class="fas fa-chevron-down toggle-icon"></i>
    </div>
    <div class="section-content card" id="content-programacao">
      <div id="programacaoContent" class="table-wrap"></div>
    </div>
    </div>
<script>
/* ====== CONFIG - coloque aqui seu SHEET_ID se mudar ====== */
const SHEET_ID = '1o0wF2ScSkyxqY8FHFI-rA6k_3uMI2wsZr2wQG8JD4B4';
const GIDS = {
  entrega: '1186247985',    // aba LOTES DE ENTREGA
  retirada: '1984691910',   // aba LOTES RETIRADA
  programacao: '1183141602'// aba PROGRAMA√á√ÉO (mantido o original '1CZZgYJiZic9pyFFTdyldm_gVwn2K-zSGY9uhFJ5Nz6Q' para este GID, mas o SHEET_ID foi alterado)
};
// Configura√ß√£o do intervalo de atualiza√ß√£o autom√°tica (em milissegundos)
// 300000 = 5 minutos (5 * 60 * 1000)
const AUTO_UPDATE_INTERVAL = 300000;
/* colunas que ficam ocultas em exibi√ß√£o (aparecem em detalhes) - normalizadas */
const HIDDEN_COLS = ['nfp','royalties','safra'];
/* colunas removidas (normalizadas) de todas as tabelas */
const REMOVED_COMMON = ['localizacao','idorigemymvk1'];
/* colunas removidas especificamente da Programa√ß√£o (normalizadas) */
const REMOVED_PROGRAMACAO = [
  'observacoes','ordem','notafiscal','dacte','mdfe','conftipocam','agendamento',
  'descarga','comprovantededescarga','horarioprev','classificacaodestino','chaveid',
  'frete', 'statusagendamento', 'datadedescarga', 'notafiscal' // Adicionadas conforme solicita√ß√£o
];
/* Vari√°vel global para armazenar os totais de produto para o resumo */
let globalProdutosTotais = { soja: 0, milho: 0, sorgo: 0, total: 0 };

/* Normaliza cabe√ßalho: remove acento, espa√ßos e pontua√ß√£o */
function normalizeHeader(h){
  if(h === undefined || h === null) return '';
  return String(h).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,'');
}
/* Normaliza texto: remove acentos ‚Äî reutiliz√°vel para status */
function normalizeText(text) {
  if(text === undefined || text === null) return '';
  return String(text).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
}
/* Parse CSV tolerante (trata v√≠rgulas dentro de aspas)
   Retorna { arrays: [ [col1,col2,...], ... ], headersOrig: [], headersNorm: [], objects: [ {normKey: value}, ... ] } */
function parseCSV(text){
  if(!text) return {arrays:[], headersOrig:[], headersNorm:[], objects:[]};
  // Corrigido: Express√£o regular v√°lida para dividir linhas
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
  if(lines.length === 0) return {arrays:[], headersOrig:[], headersNorm:[], objects:[]};
  const parsed = lines.map(line => line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"|"$/g,'').trim()));
  const headersOrig = parsed.shift().map(h => h||'');
  const headersNorm = headersOrig.map(h => normalizeHeader(h));
  const objects = parsed.map(cells => {
    const obj = {};
    headersNorm.forEach((key, idx) => {
      obj[key] = cells[idx] !== undefined ? cells[idx] : '';
    });
    return obj;
  });
  return {arrays: parsed, headersOrig, headersNorm, objects};
}
/* fetch CSV via gviz - retorna parseCSV result */
async function fetchSheetByGid(gid){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('Erro ao buscar planilha: ' + r.status);
  const text = await r.text();
  return parseCSV(text);
}
/* util: parse number tolerant */
function parseNumber(val){
  if(val === undefined || val === null) return NaN;
  const s = String(val).replace(/\s/g,'').replace(/\./g,'').replace(/,/g,'.');
  const n = parseFloat(s.replace(/[^\d\.\-]/g,''));
  return isNaN(n) ? NaN : n;
}
/* util: parse date only (dd/mm/yyyy ou yyyy-mm-dd) -> Date (00:00:00) or null */
function parseDateOnly(s){
  if(!s) return null;
  const str = s.trim();
  // Tenta formato dd/mm/yyyy
  let match = str.match(/^(\d{1,2})[/-](\d{1,2})[/-](\d{4})$/);
  if (match) {
    const day = parseInt(match[1], 10);
    const month = parseInt(match[2], 10) - 1; // M√™s √© 0-indexado
    const year = parseInt(match[3], 10);
    // Cria a data no fuso local, definindo hora para 00:00:00
    const date = new Date(year, month, day, 0, 0, 0, 0);
    if(date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) {
      return date;
    }
  }
  // Tenta formato yyyy-mm-dd
  match = str.match(/^(\d{4})[/-](\d{1,2})[/-](\d{1,2})$/);
  if (match) {
    const year = parseInt(match[1], 10);
    const month = parseInt(match[2], 10) - 1; // M√™s √© 0-indexado
    const day = parseInt(match[3], 10);
    const date = new Date(year, month, day, 0, 0, 0, 0);
    if(date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) {
      return date;
    }
  }
  // Se n√£o reconhecer o formato, tenta o new Date() gen√©rico (pode ser inconsistente)
  try {
    const d = new Date(str);
    if (!isNaN(d.getTime())) {
        return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0);
    }
  } catch(e) { /* ignore */ }
  return null;
}
/* util: format number to KG (ex: 30.000 KG) */
function formatNumber(n){
  if(isNaN(n)) return '0';
  return n.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}
/* util: format date to DD/MM/YYYY */
function formatDate(date){
  if(!date || isNaN(date.getTime())) return '-';
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}
/* util: calcula a diferen√ßa em dias entre duas datas (date1 - date2) */
function dateDiffInDays(date1, date2){
    if(!date1 || !date2 || isNaN(date1.getTime()) || isNaN(date2.getTime())) return NaN;
    const diffTime = date1.getTime() - date2.getTime();
    // 1000 * 60 * 60 * 24 = milissegundos em um dia
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays;
}
/* util: gera uma cor de acordo com o status */
function getStatusColor(status) {
    const normStatus = normalizeText(status);
    if (normStatus.includes('carregado')) return 'var(--status-carregado)';
    if (normStatus.includes('embarque')) return 'var(--status-embarque)';
    if (normStatus.includes('transito')) return 'var(--status-transito)';
    if (normStatus.includes('contratar')) return 'var(--status-contratar)';
    return 'var(--muted)';
}

/* Agrupamento e Renderiza√ß√£o Principal */
function groupAndRender(dataObjects){
  // 1. Resetar totais
  const statusCounts = {carregado:0, embarque:0, transito:0, contratar:0};
  globalProdutosTotais = { soja: 0, milho: 0, sorgo: 0, total: 0 };
  
  // 2. Agrupar por Cliente + Destino
  const groupedData = {};
  dataObjects.forEach(row => {
    // Normaliza status para contagem
    const status = normalizeText(row.status);
    if(status.includes('carregado')) statusCounts.carregado++;
    else if(status.includes('embarque')) statusCounts.embarque++;
    else if(status.includes('transito')) statusCounts.transito++;
    else if(status.includes('contratar')) statusCounts.contratar++;
    
    // Acumula total por produto
    const peso = parseNumber(row.peso) || 0;
    const produto = normalizeText(row.produto);
    if(produto.includes('soja')) globalProdutosTotais.soja += peso;
    else if(produto.includes('milho')) globalProdutosTotais.milho += peso;
    else if(produto.includes('sorgo')) globalProdutosTotais.sorgo += peso;
    globalProdutosTotais.total += peso;
    
    // Chave de agrupamento: Cliente + Destino
    const key = `${row.cliente || 'S/ Cliente'}-${row.destino || 'S/ Destino'}`;
    if(!groupedData[key]){
      groupedData[key] = {
        cliente: row.cliente || 'S/ Cliente',
        destino: row.destino || 'S/ Destino',
        totalPeso: 0,
        totalCarregado: 0,
        lotes: []
      };
    }
    
    groupedData[key].totalPeso += peso;
    const pesoCarregado = parseNumber(row.pesocarregado) || 0;
    groupedData[key].totalCarregado += pesoCarregado;
    
    groupedData[key].lotes.push(row);
  });
  
  // 3. Renderizar Cards de Clientes
  const container = document.getElementById('clientesContainer');
  container.innerHTML = '';
  
  Object.values(groupedData).forEach(group => {
    // Determinar status principal para o card: contratado, carregado, ou pendente/embarque
    let principalStatus = 'contratar';
    let pesoFaltante = group.totalPeso - group.totalCarregado;
    let lotesFaltantes = group.lotes.filter(l => parseNumber(l.pesofaltante) > 0).length;

    if (lotesFaltantes === 0 && group.lotes.length > 0) {
        principalStatus = 'carregado';
    } else if (lotesFaltantes > 0) {
        principalStatus = 'embarque'; // Ou transito/contratar, mas 'embarque' √© um bom default para pendente
    }
    
    // Gerar HTML dos lotes detalhados para o modal (n√£o usado no card principal)
    const lotesHtml = group.lotes.map(lote => {
      const loteStatus = normalizeText(lote.status);
      const isCarregado = loteStatus.includes('carregado');
      const tagClass = isCarregado ? 'status-carregado-tag' : 'status-pendente-tag';
      const tagText = isCarregado ? 'CARREGADO' : 'PENDENTE';
      const pesoFalta = parseNumber(lote.pesofaltante) || 0;
      const pesoCarregado = parseNumber(lote.pesocarregado) || 0;
      
      return `
        <div class="cliente-info">
            <span class="info-label">${lote.contrato}</span>
            <span class="info-value">
                <span class="${tagClass}">${tagText}</span>
            </span>
        </div>
        <div class="cliente-info">
            <span class="info-label">Volume:</span>
            <span class="info-value">${formatNumber(parseNumber(lote.peso) || 0)} KG</span>
        </div>
        <div class="cliente-info">
            <span class="info-label">Carregado:</span>
            <span class="info-value">${formatNumber(pesoCarregado)} KG</span>
        </div>
        <div class="cliente-info">
            <span class="info-label" style="font-weight:700;">Falta:</span>
            <span class="info-value" style="font-weight:700; color: ${pesoFalta > 0 ? 'var(--status-transito)' : 'var(--status-carregado)'};">${formatNumber(pesoFalta)} KG</span>
        </div>
        ${lote.cidade ? `<div class="cliente-produto" style="background-color: var(--muted); color: white;">üìç ${lote.cidade}</div>` : ''}
        ${lote.produto ? `<div class="cliente-produto" style="background-color: var(--produto-${normalizeText(lote.produto)}); color: white;">${lote.produto}</div>` : ''}
        <hr style="border:0; border-top: 1px dashed #eee; margin: 8px 0;">
      `;
    }).join('');

    // Conta caminh√µes
    const caminhoesTotais = group.lotes.reduce((acc, lote) => {
        const pesoFalta = parseNumber(lote.pesofaltante) || 0;
        // Se a quantidade de caminh√µes estiver dispon√≠vel (a ser adicionada na planilha se necess√°rio), usar.
        // Por enquanto, estimativa simples. 30.000 KG por caminh√£o.
        const caminhoesNecessarios = Math.ceil(pesoFalta / 30000);
        return acc + caminhoesNecessarios;
    }, 0);
    
    // Calcula o percentual carregado
    const percentCarregado = group.totalPeso > 0 ? Math.round((group.totalCarregado / group.totalPeso) * 100) : 0;
    
    // Renderiza o card
    const cardHtml = `
      <div class="cliente-card" style="border-left-color: ${getStatusColor(principalStatus)};">
        <div class="cliente-name">${group.cliente}</div>
        <div class="cliente-destino">Destino: ${group.destino}</div>
        
        <div class="cliente-info">
            <span class="info-label">Volume Total:</span>
            <span class="info-value">${formatNumber(group.totalPeso)} KG</span>
        </div>
        <div class="cliente-info">
            <span class="info-label">Total Carregado:</span>
            <span class="info-value">${formatNumber(group.totalCarregado)} KG</span>
        </div>
        <div class="cliente-info">
            <span class="info-label" style="font-weight:700;">Falta Carregar:</span>
            <span class="info-value" style="font-weight:700; color: ${pesoFaltante > 0 ? 'var(--status-transito)' : 'var(--status-carregado)'};">${formatNumber(pesoFaltante)} KG</span>
        </div>
        
        <div style="background:#eee; height:8px; border-radius:4px; margin-top:10px;">
            <div style="width:${percentCarregado}%; height:100%; background:${getStatusColor(principalStatus)}; border-radius:4px; transition:width 0.5s ease;"></div>
        </div>
        <div style="font-size:11px; color:var(--muted); margin-top:4px; text-align:right;">
            ${percentCarregado}% Carregado
        </div>

        <div class="caminhoes-info">
            <div class="caminhoes-separados" title="${lotesFaltantes} Lote(s) com saldo a embarcar.">
                <i class="fas fa-boxes" style="color:var(--muted);"></i>
                <span style="font-weight:700; font-size:13px; color:var(--text);">${lotesFaltantes}</span>
                <span style="font-size:11px; color:var(--muted);">Lotes Pendentes</span>
            </div>
        </div>
        
      </div>
    `;
    container.insertAdjacentHTML('beforeend', cardHtml);
  });
  
  // 4. Atualizar os T√≥tems (Totais)
  document.getElementById('count-carregado').textContent = formatNumber(statusCounts.carregado);
  document.getElementById('count-embarque').textContent = formatNumber(statusCounts.embarque);
  document.getElementById('count-transito').textContent = formatNumber(statusCounts.transito);
  document.getElementById('count-contratar').textContent = formatNumber(statusCounts.contratar);
  
  document.getElementById('count-soja').textContent = `${formatNumber(globalProdutosTotais.soja)} KG`;
  document.getElementById('count-milho').textContent = `${formatNumber(globalProdutosTotais.milho)} KG`;
  document.getElementById('count-sorgo').textContent = `${formatNumber(globalProdutosTotais.sorgo)} KG`;
  document.getElementById('count-total').textContent = `${formatNumber(globalProdutosTotais.total)} KG`;
}

/* Renderiza√ß√£o da Tabela de Programa√ß√£o */
function renderProgramacao(dataObjects, headersNorm, headersOrig){
  const content = document.getElementById('programacaoContent');
  if(dataObjects.length === 0){
    content.innerHTML = '<div class="empty">Nenhuma programa√ß√£o encontrada.</div>';
    return;
  }
  
  // Cria a tabela
  let tableHtml = '<table><thead><tr>';
  
  // Monta o cabe√ßalho
  const visibleHeadersNorm = [];
  headersNorm.forEach((hNorm, index) => {
    if(!REMOVED_COMMON.includes(hNorm) && !REMOVED_PROGRAMACAO.includes(hNorm)){
      tableHtml += `<th>${headersOrig[index]}</th>`;
      visibleHeadersNorm.push(hNorm);
    }
  });
  tableHtml += '</tr></thead><tbody>';
  
  // Monta as linhas
  dataObjects.forEach(row => {
    tableHtml += '<tr>';
    visibleHeadersNorm.forEach(hNorm => {
      let cellContent = row[hNorm] || '-';
      let cellClass = '';
      
      // Formata√ß√£o especial para Status
      if(hNorm === 'status'){
        const statusText = normalizeText(cellContent);
        let statusClass = 'status-contratar'; // Default
        if(statusText.includes('carregado')) statusClass = 'status-carregado';
        else if(statusText.includes('embarque')) statusClass = 'status-embarque';
        else if(statusText.includes('transito')) statusClass = 'status-transito';
        
        cellContent = `<span class="status-programacao ${statusClass}">${row[hNorm]}</span>`;
      } 
      // Formata√ß√£o para Data
      else if(hNorm.includes('data')){
          const date = parseDateOnly(cellContent);
          cellContent = formatDate(date);
      }
      // Formata√ß√£o para Peso
      else if(hNorm.includes('peso') || hNorm.includes('volume')){
          const peso = parseNumber(cellContent);
          cellContent = isNaN(peso) ? '-' : `${formatNumber(peso)} KG`;
      }
      
      tableHtml += `<td>${cellContent}</td>`;
    });
    tableHtml += '</tr>';
  });
  
  tableHtml += '</tbody></table>';
  content.innerHTML = tableHtml;
}

/* Fun√ß√£o principal de carregamento */
async function loadAll(forceUpdate = false){
  // Se n√£o estiver for√ßando a atualiza√ß√£o, checar se est√° vis√≠vel
  if(!forceUpdate && document.hidden) return;

  const statusElement = document.getElementById('lastUpdateTop');
  const body = document.body;

  // 1. Atualizar Status (Come√ßando)
  body.classList.add('updating');
  statusElement.innerHTML = `<i class="fas fa-spinner fa-spin"></i> <span>Atualizando...</span>`;
  
  try{
    // 2. Buscar dados de Entregas (Lotes)
    const entregaData = await fetchSheetByGid(GIDS.entrega);
    
    // 3. Renderizar Entregas e Totais
    groupAndRender(entregaData.objects);
    
    // 4. Buscar dados de Programa√ß√£o
    const programacaoData = await fetchSheetByGid(GIDS.programacao);
    
    // 5. Renderizar Programa√ß√£o
    renderProgramacao(programacaoData.objects, programacaoData.headersNorm, programacaoData.headersOrig);
    
    // 6. Atualizar Status (Finalizado)
    const now = new Date();
    const formattedTime = now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', second: '2-digit'});
    
    statusElement.innerHTML = `
      <i class="far fa-clock"></i> <span>√öltima atualiza√ß√£o: ${formattedTime}</span>
    `;
    body.classList.remove('updating');
  }
  catch(err){
    console.error('Erro loadAll:', err);
    document.getElementById('clientesContainer').innerHTML = '<div class="empty">Erro ao carregar dados. Verifique a conex√£o ou as configura√ß√µes da planilha (ver console).</div>';
    document.getElementById('programacaoContent').innerHTML = '<div class="empty">Erro ao carregar dados. Verifique a conex√£o ou as configura√ß√µes da planilha (ver console).</div>';
    statusElement.innerHTML = `
      <i class="fas fa-exclamation-triangle" style="color: rgba(255,255,255,0.9);"></i>
      <span>Erro na atualiza√ß√£o</span>
    `;
    body.classList.remove('updating');
  }
}

/* Toggle handlers para as se√ß√µes expans√≠veis */
function setupToggleHandlers(){
  const toggleProgramacao = document.getElementById('toggle-programacao');
  const contentProgramacao = document.getElementById('content-programacao');
  
  toggleProgramacao.addEventListener('click', () => {
    toggleSection(toggleProgramacao, contentProgramacao);
  });
  
  // Manter Programa√ß√£o fechada por padr√£o ao carregar
  contentProgramacao.classList.add('collapsed');
  toggleProgramacao.classList.add('collapsed');
}

/* Handler de clique no card total para abrir a programa√ß√£o */
function handleTotalCardClick(event) {
    const toggleProgramacao = document.getElementById('toggle-programacao');
    const contentProgramacao = document.getElementById('content-programacao');
    // Se a programa√ß√£o estiver fechada, abre
    if (contentProgramacao.classList.contains('collapsed')) {
        toggleSection(toggleProgramacao, contentProgramacao);
    }
    // Rola para a se√ß√£o
    toggleProgramacao.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

/* Fun√ß√£o de toggle universal */
function toggleSection(header, content){
  let isCollapsed = content.classList.contains('collapsed');
  if(isCollapsed) {
    content.classList.remove('collapsed');
    header.classList.remove('collapsed');
  } else {
    content.classList.add('collapsed');
    header.classList.add('collapsed');
  }
}
/* Configurar atualiza√ß√£o autom√°tica */
let autoUpdateInterval;
function startAutoUpdate() {
  // Executar imediatamente ao carregar
  loadAll(true);
  // Configurar intervalo para atualiza√ß√µes subsequentes (5 minutos)
  autoUpdateInterval = setInterval(() => {
    loadAll(true);
  }, AUTO_UPDATE_INTERVAL);
}
function stopAutoUpdate() {
  if(autoUpdateInterval) {
    clearInterval(autoUpdateInterval);
    autoUpdateInterval = null;
  }
}
/* init */
// Setup toggle handlers and start auto update after DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  setupToggleHandlers();
  // NOVO: Adicionar handler de clique ao card "TOTAL EMBARCADO"
  document.getElementById('card-total-embarcado').addEventListener('click', handleTotalCardClick);
  startAutoUpdate();
  // Adicionar evento de visibilidade para pausar/recuperar atualiza√ß√µes
  document.addEventListener('visibilitychange', function() {
    if(document.hidden) {
      console.log('P√°gina oculta - pausando atualiza√ß√µes autom√°ticas');
    } else {
      console.log('P√°gina vis√≠vel - retomando atualiza√ß√µes autom√°ticas');
      // Atualizar imediatamente quando a p√°gina volta a ficar vis√≠vel
      loadAll(true);
    }
  });
});
</script>
</body>
</html>
