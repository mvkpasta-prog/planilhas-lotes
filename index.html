<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controle de Lotes â€” Entrega & Retirada</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  :root{
    --primary:#2563eb; --accent:#0ea5e9; --bg:#f6fbff; --card:#fff; --text:#0f172a;
    --muted:#6b7280; --success:#10b981; --warning:#f59e0b;
  }
  *{box-sizing:border-box}
  body{font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;margin:0;background:var(--bg);color:var(--text);padding:18px}
  header{background:linear-gradient(90deg,var(--primary),var(--accent));color:white;padding:14px;border-radius:8px;margin-bottom:18px;text-align:center;font-weight:700}
  .wrap{max-width:1280px;margin:0 auto}
  .actions{display:flex;justify-content:flex-end;margin-bottom:12px}
  .btn{background:var(--primary);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
  .btn:hover{opacity:.95}
  h2{color:var(--primary);margin:6px 0 12px 0}
  .card{background:var(--card);border-radius:10px;padding:12px;margin-bottom:18px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
  .table-wrap{overflow-x:auto}
  table{width:100%;border-collapse:collapse;margin:0;font-size:13px;min-width:760px}
  th,td{border:1px solid #e6eefc;padding:10px;text-align:left;vertical-align:top}
  th{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;font-weight:700;white-space:nowrap}
  tr:nth-child(even){background:#fbfdff}
  .status{display:inline-block;padding:6px 10px;border-radius:16px;color:#fff;font-weight:700}
  .status-aberto{background:var(--warning)}
  .status-fechado{background:var(--success)}
  .empty{color:var(--muted);font-style:italic;padding:12px}
  .btn-details{background:transparent;border:0;color:var(--primary);cursor:pointer;text-decoration:underline;padding:0}
  .details-row{display:none;background:#f3f7ff}
  @media (max-width:900px){
    table{min-width:700px}
    th, td{padding:8px;font-size:12px}
  }
</style>
</head>
<body>
  <header>ðŸ“¦ Controle de Lotes â€” Entrega & Retirada</header>

  <div class="wrap">
    <div class="actions">
      <button id="btnRefresh" class="btn"><i class="fas fa-sync-alt"></i> Atualizar</button>
    </div>

    <div class="card" id="cardEntrega">
      <h2>ðŸšš Lotes de Entrega</h2>
      <div id="entregaContent" class="table-wrap"></div>
    </div>

    <div class="card" id="cardRetirada">
      <h2>ðŸ“¦ Lotes de Retirada</h2>
      <div id="retiradaContent" class="table-wrap"></div>
    </div>

    <div class="card" id="cardProg">
      <h2>ðŸ—“ ProgramaÃ§Ã£o â€” Somente hoje</h2>
      <div id="programacaoContent" class="table-wrap"></div>
    </div>
  </div>

<script>
/* ========== Config ========== */
const SHEET_ID = '1CZZgYJiZic9pyFFTdyldm_gVwn2K-zSGY9uhFJ5Nz6Q';
const GIDS = {
  entrega: '271702555',
  retirada: '585404986',
  programacao: '1183141602'
};

/* hidden columns in details */
const HIDDEN_COLS = ['nfp','royalties','safra'];
/* common removed columns */
const REMOVED_COMMON = ['localizacao','idorigemymvk1'];
/* programacao removed extras (inclui os novos pedidos) */
const REMOVED_PROGRAMACAO = [
  'observacoes','ordem','notafiscal','dacte','mdfe','conftipocam','agendamento',
  'descarga','comprovantededescarga','horarioprev','classificacaodestino','chaveid',
  'frete','statusagendamento','datadedescarga'
];

/* normalize header */
function normalizeHeader(h){
  if(h === undefined || h === null) return '';
  return String(h).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,'');
}

/* parse CSV robust (handles commas inside quotes) */
function parseCSV(text){
  if(!text) return {arrays:[], headersOrig:[], headersNorm:[], objects:[]};
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
  if(lines.length === 0) return {arrays:[], headersOrig:[], headersNorm:[], objects:[]};

  const parsed = lines.map(line => line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"|"$/g,'').trim()));
  const headersOrig = parsed.shift().map(h => h || '');
  const headersNorm = headersOrig.map(h => normalizeHeader(h));
  const objects = parsed.map(cells => {
    const obj = {};
    headersNorm.forEach((k, idx) => obj[k] = cells[idx] !== undefined ? cells[idx] : '');
    return obj;
  });
  return {arrays: parsed, headersOrig, headersNorm, objects};
}

/* fetch sheet via gviz csv */
async function fetchSheetByGid(gid){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('Erro ao buscar planilha: ' + r.status);
  const text = await r.text();
  return parseCSV(text);
}

/* parse number robust */
function parseNumber(v){
  if(v === undefined || v === null) return NaN;
  const s = String(v).replace(/\s/g,'').replace(/\./g,'').replace(/,/g,'.');
  const n = parseFloat(s.replace(/[^\d\.\-]/g,''));
  return isNaN(n) ? NaN : n;
}

/* parse date only */
function parseDateOnly(s){
  if(!s) return null;
  const str = String(s).trim();
  if(str.includes('/')){ const p = str.split('/'); if(p.length>=3){ const d=parseInt(p[0],10), m=parseInt(p[1],10), y=parseInt(p[2],10); if(!isNaN(d)&&!isNaN(m)&&!isNaN(y)) return new Date(y,m-1,d); } }
  if(str.includes('-')){ const p=str.split('-'); if(p.length>=3){ const y=parseInt(p[0],10), m=parseInt(p[1],10), d=parseInt(p[2],10); if(!isNaN(d)&&!isNaN(m)&&!isNaN(y)) return new Date(y,m-1,d); } }
  const dt = new Date(str);
  return isNaN(dt.getTime()) ? null : new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
}

function escapeHtml(s){ if(s === undefined || s === null) return ''; return String(s).replace(/[&<>"'\/]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#x27;','/':'&#x2F;'}[c])); }

/* build generic table. opts:
   - hiddenNorm: []
   - removedNorm: []
   - numericKeyNorm: normalized header string (if available) OR null
   - numericIndex: fallback index for numeric column (0-based) if numericKeyNorm not present
   - forceCols: [{key:'contrato_forcado', title:'NÂº CONTRATO', values:[..]}]
   - prefix: string prefix for details IDs: 'ent','ret','prog'
*/
function buildTableHTML(rowsArr, rowsObj, headersOrig, headersNorm, opts){
  const hiddenNorm = opts.hiddenNorm || [];
  const removedNorm = opts.removedNorm || [];
  const numericKeyNorm = opts.numericKeyNorm || null;
  const numericIndex = (opts.numericIndex !== undefined) ? opts.numericIndex : -1;
  const forceCols = opts.forceCols || [];
  const prefix = opts.prefix || 'tbl';

  // columns to display: start with forceCols keys
  let displayCols = forceCols.map(fc => fc.key);
  // then append headersNorm that aren't removed or hidden or already included
  headersNorm.forEach(h => {
    if(removedNorm.includes(h)) return;
    if(hiddenNorm.includes(h)) return;
    if(displayCols.includes(h)) return;
    displayCols.push(h);
  });

  if(displayCols.length === 0) return '<div class="empty">Sem colunas para exibir.</div>';

  // header titles: if force column, use title; else use headersOrig at same index
  let html = '<table><thead><tr>';
  displayCols.forEach(c => {
    const force = forceCols.find(f => f.key === c);
    if(force){
      html += `<th>${escapeHtml(force.title)}</th>`;
    } else {
      const idx = headersNorm.indexOf(c);
      const title = (idx >= 0) ? headersOrig[idx] : c;
      html += `<th>${escapeHtml(title || c)}</th>`;
    }
  });
  if(numericKeyNorm || numericIndex >= 0) html += '<th>Status</th>';
  html += '<th>AÃ§Ãµes</th></tr></thead><tbody>';

  for(let i=0;i<rowsArr.length;i++){
    const arr = rowsArr[i] || [];
    const obj = rowsObj[i] || {};
    // compute numeric value
    let numValRaw = '';
    if(numericKeyNorm && obj[numericKeyNorm] !== undefined && obj[numericKeyNorm] !== '') numValRaw = obj[numericKeyNorm];
    else if(numericIndex >= 0 && arr[numericIndex] !== undefined) numValRaw = arr[numericIndex];
    const n = parseNumber(numValRaw || '0');

    html += '<tr>';
    displayCols.forEach(c => {
      const force = forceCols.find(f => f.key === c);
      let val = '';
      if(force){
        val = (force.values && force.values[i] !== undefined) ? force.values[i] : '';
      } else {
        const idx = headersNorm.indexOf(c);
        if(obj[c] !== undefined && obj[c] !== '') val = obj[c];
        else if(idx >= 0 && arr[idx] !== undefined) val = arr[idx];
        else val = '';
      }
      html += `<td>${escapeHtml(val)}</td>`;
    });

    if(numericKeyNorm || numericIndex >= 0){
      html += `<td>${n>0?'<span class="status status-aberto">ABERTO</span>':'<span class="status status-fechado">FECHADO</span>'}</td>`;
    }
    html += `<td><button class="btn-details" data-prefix="${prefix}" data-row="${i}">Ver Detalhes</button></td></tr>`;

    // details content: show hiddenNorm columns (with originals)
    let detailsHtml = '';
    hiddenNorm.forEach(h => {
      const idx = headersNorm.indexOf(h);
      let value = '';
      if(obj[h] !== undefined && obj[h] !== '') value = obj[h];
      else if(idx >= 0 && arr[idx] !== undefined) value = arr[idx];
      if(value) detailsHtml += `<div><strong>${escapeHtml(headersOrig[idx]||h)}:</strong> ${escapeHtml(value)}</div>`;
    });
    if(detailsHtml){
      const colspan = displayCols.length + ((numericKeyNorm || numericIndex >= 0) ? 2 : 1);
      html += `<tr class="details-row" id="details-${prefix}-${i}" style="display:none"><td colspan="${colspan}">${detailsHtml}</td></tr>`;
    }
  }

  html += '</tbody></table>';
  return html;
}

/* attach toggles to buttons after rendering */
function attachDetailToggles(){
  document.querySelectorAll('.btn-details').forEach(btn=>{
    btn.onclick = () => {
      const prefix = btn.dataset.prefix;
      const row = btn.dataset.row;
      const el = document.getElementById(`details-${prefix}-${row}`);
      if(!el) return;
      el.style.display = (el.style.display === 'table-row') ? 'none' : 'table-row';
    };
  });
}

/* main loader */
async function loadAll(){
  try{
    // ----- LOTES DE ENTREGA -----
    const ent = await fetchSheetByGid(GIDS.entrega);
    const rowsArrEntAll = ent.arrays || [];
    const headersOrigEnt = ent.headersOrig || [];
    const headersNormEnt = ent.headersNorm || [];
    const objsEntAll = ent.objects || [];

    // saldo detection: try header otherwise fallback to index 8 (col I)
    const saldoKeyEnt = (['saldoent','saldoentrega','saldoentkg','saldoent(kg)','saldoentkg'].find(k => headersNormEnt.includes(k)) ) || null;
    const saldoIndexEnt = 8; // column I index 8 (0-based)
    // build filtered arrays only saldo > 0
    const rowsArrEnt = [], rowsObjEnt = [], contratoVals = [];
    for(let i=0;i<rowsArrEntAll.length;i++){
      const arr = rowsArrEntAll[i] || [];
      const obj = objsEntAll[i] || {};
      // numeric value:
      let rawSaldo = '';
      if(saldoKeyEnt && obj[saldoKeyEnt]) rawSaldo = obj[saldoKeyEnt];
      else if(arr[saldoIndexEnt] !== undefined) rawSaldo = arr[saldoIndexEnt];
      const n = parseNumber(rawSaldo || '0');
      if(!isNaN(n) && n > 0){
        rowsArrEnt.push(arr);
        rowsObjEnt.push(obj);
        // force contract from column B index 1
        contratoVals.push(arr[1] !== undefined ? arr[1] : (obj['ncontrato'] || obj['contrato'] || ''));
      }
    }

    // render entrega: force column contrato_forcado at left, numeric column using header if found else index
    const forceColsEnt = [{ key: 'contrato_forcado', title: 'NÂº CONTRATO', values: contratoVals }];
    const entHTML = buildTableHTML(rowsArrEnt, rowsObjEnt, headersOrigEnt, headersNormEnt, {
      hiddenNorm: HIDDEN_COLS.map(normalizeHeader),
      removedNorm: REMOVED_COMMON.map(normalizeHeader),
      numericKeyNorm: saldoKeyEnt,
      numericIndex: saldoKeyEnt ? -1 : saldoIndexEnt,
      forceCols: forceColsEnt,
      prefix: 'ent'
    });
    document.getElementById('entregaContent').innerHTML = entHTML || '<div class="empty">Nenhum lote de entrega em aberto.</div>';

    // ----- LOTES DE RETIRADA -----
    const ret = await fetchSheetByGid(GIDS.retirada);
    const rowsArrRetAll = ret.arrays || [];
    const headersOrigRet = ret.headersOrig || [];
    const headersNormRet = ret.headersNorm || [];
    const objsRetAll = ret.objects || [];

    // detect and remove "informacoes origem" header(s)
    const removedRet = REMOVED_COMMON.map(normalizeHeader);
    // try to find header that includes both 'inform' and 'orig' or exactly 'informacoesdaorigem' etc
    headersNormRet.forEach(h => { if(h.includes('inform') && h.includes('orig')) removedRet.push(h); });

    const saldoKeyRet = (['saldoret','saldoretkg','saldoretirada','saldoret(kg)'].find(k => headersNormRet.includes(k))) || null;
    const saldoIndexRet = 9; // column J index 9
    // optionally filter by SITUAÃ‡ÃƒO == 'Pendente' if header exists
    const situacaoKey = headersNormRet.find(h => h.includes('situacao')) || null;

    const rowsArrRet = [], rowsObjRet = [];
    for(let i=0;i<rowsArrRetAll.length;i++){
      const arr = rowsArrRetAll[i] || [];
      const obj = objsRetAll[i] || {};
      let rawSaldo = '';
      if(saldoKeyRet && obj[saldoKeyRet]) rawSaldo = obj[saldoKeyRet];
      else if(arr[saldoIndexRet] !== undefined) rawSaldo = arr[saldoIndexRet];
      const n = parseNumber(rawSaldo || '0');
      if(isNaN(n) || n <= 0) continue;
      // if situacao exists require 'Pendente'
      if(situacaoKey){
        const sit = (obj[situacaoKey] || arr[ headersNormRet.indexOf(situacaoKey) ] || '').toString().trim();
        if(sit && sit.toLowerCase() !== 'pendente') continue;
      }
      rowsArrRet.push(arr);
      rowsObjRet.push(obj);
    }

    const retHTML = buildTableHTML(rowsArrRet, rowsObjRet, headersOrigRet, headersNormRet, {
      hiddenNorm: HIDDEN_COLS.map(normalizeHeader),
      removedNorm: removedRet,
      numericKeyNorm: saldoKeyRet,
      numericIndex: saldoKeyRet ? -1 : saldoIndexRet,
      prefix: 'ret'
    });
    document.getElementById('retiradaContent').innerHTML = retHTML || '<div class="empty">Nenhum lote de retirada em aberto.</div>';

    // ----- PROGRAMAÃ‡ÃƒO (somente hoje) -----
    const prog = await fetchSheetByGid(GIDS.programacao);
    const rowsArrProgAll = prog.arrays || [];
    const headersOrigProg = prog.headersOrig || [];
    const headersNormProg = prog.headersNorm || [];
    const objsProgAll = prog.objects || [];

    const removedProg = [...REMOVED_COMMON.map(normalizeHeader), ...REMOVED_PROGRAMACAO.map(normalizeHeader)];
    // find date header normalized or fallback index 0
    const dateKeyProg = headersNormProg.find(h => h.includes('data')) || headersNormProg[0] || null;
    const dateIndexProg = 0;

    const today = new Date(); const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
    const rowsArrProg = [], rowsObjProg = [];
    for(let i=0;i<rowsArrProgAll.length;i++){
      const arr = rowsArrProgAll[i] || [];
      const obj = objsProgAll[i] || {};
      let rawDate = '';
      if(dateKeyProg && obj[dateKeyProg]) rawDate = obj[dateKeyProg];
      else if(arr[dateIndexProg] !== undefined) rawDate = arr[dateIndexProg];
      const dt = parseDateOnly(rawDate);
      if(dt && dt.getTime() === todayStart){
        rowsArrProg.push(arr);
        rowsObjProg.push(obj);
      }
    }

    const progHTML = buildTableHTML(rowsArrProg, rowsObjProg, headersOrigProg, headersNormProg, {
      hiddenNorm: HIDDEN_COLS.map(normalizeHeader),
      removedNorm: removedProg,
      numericKeyNorm: null,
      numericIndex: -1,
      prefix: 'prog'
    });
    document.getElementById('programacaoContent').innerHTML = progHTML || '<div class="empty">Nenhuma programaÃ§Ã£o para hoje.</div>';

    // attach detail toggles
    attachDetailToggles();
  }
  catch(err){
    console.error('Erro ao carregar dados:', err);
    document.getElementById('entregaContent').innerHTML = '<div class="empty">Erro ao carregar Lotes de Entrega (veja console).</div>';
    document.getElementById('retiradaContent').innerHTML = '<div class="empty">Erro ao carregar Lotes de Retirada (veja console).</div>';
    document.getElementById('programacaoContent').innerHTML = '<div class="empty">Erro ao carregar ProgramaÃ§Ã£o (veja console).</div>';
  }
}

/* attach toggle handlers for details buttons */
function attachDetailToggles(){
  document.querySelectorAll('.btn-details').forEach(btn=>{
    btn.onclick = () => {
      const prefix = btn.dataset.prefix;
      const i = btn.dataset.row;
      const el = document.getElementById(`details-${prefix}-${i}`);
      if(!el) return;
      el.style.display = el.style.display === 'table-row' ? 'none' : 'table-row';
    };
  });
}

/* init */
document.getElementById('btnRefresh').addEventListener('click', () => {
  document.getElementById('entregaContent').innerHTML = '<div class="empty">Atualizando...</div>';
  document.getElementById('retiradaContent').innerHTML = '<div class="empty">Atualizando...</div>';
  document.getElementById('programacaoContent').innerHTML = '<div class="empty">Atualizando...</div>';
  loadAll();
});
loadAll();
</script>
</body>
</html>
