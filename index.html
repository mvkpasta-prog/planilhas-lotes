<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controle de Lotes â€” Entrega & Retirada</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  :root{
    --primary:#2563eb; --accent:#0ea5e9; --bg:#f6fbff; --card:#fff; --text:#0f172a;
    --muted:#6b7280; --success:#10b981; --warning:#f59e0b;
  }
  *{box-sizing:border-box}
  body{font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;margin:0;background:var(--bg);color:var(--text);padding:18px}
  header{background:linear-gradient(90deg,var(--primary),var(--accent));color:white;padding:14px;border-radius:8px;margin-bottom:18px;text-align:center;font-weight:700}
  .wrap{max-width:1280px;margin:0 auto}
  .actions{display:flex;justify-content:flex-end;margin-bottom:12px}
  .btn{background:var(--primary);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
  .btn:hover{opacity:.95}
  h2{color:var(--primary);margin:6px 0 12px 0}
  .card{background:var(--card);border-radius:10px;padding:12px;margin-bottom:18px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
  .table-wrap{overflow-x:auto}
  table{width:100%;border-collapse:collapse;margin:0;font-size:13px;min-width:800px}
  th,td{border:1px solid #e6eefc;padding:10px;text-align:left;vertical-align:top}
  th{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;font-weight:700;white-space:nowrap}
  tr:nth-child(even){background:#fbfdff}
  .status{display:inline-block;padding:6px 10px;border-radius:16px;color:#fff;font-weight:700}
  .status-aberto{background:var(--warning)}
  .status-fechado{background:var(--success)}
  .empty{color:var(--muted);font-style:italic;padding:12px}
  .btn-details{background:transparent;border:0;color:var(--primary);cursor:pointer;text-decoration:underline;padding:0}
  .details-row{display:none;background:#f3f7ff}
  .details-row.visible{display:table-row}
  @media (max-width:900px){
    table{min-width:700px}
    th, td{padding:8px;font-size:12px}
  }
</style>
</head>
<body>
  <header>ðŸ“¦ Controle de Lotes â€” Entrega & Retirada</header>

  <div class="wrap">
    <div class="actions">
      <button id="btnRefresh" class="btn"><i class="fas fa-sync-alt"></i> Atualizar</button>
    </div>

    <div class="card" id="cardEntrega">
      <h2>ðŸšš Lotes de Entrega</h2>
      <div id="entregaContent" class="table-wrap"></div>
    </div>

    <div class="card" id="cardRetirada">
      <h2>ðŸ“¦ Lotes de Retirada</h2>
      <div id="retiradaContent" class="table-wrap"></div>
    </div>

    <div class="card" id="cardProg">
      <h2>ðŸ—“ ProgramaÃ§Ã£o â€” Somente hoje</h2>
      <div id="programacaoContent" class="table-wrap"></div>
    </div>
  </div>

<script>
/* ====== CONFIG - coloque aqui seu SHEET_ID se mudar ====== */
const SHEET_ID = '1CZZgYJiZic9pyFFTdyldm_gVwn2K-zSGY9uhFJ5Nz6Q';
const GIDS = {
  entrega: '271702555',    // aba LOTES DE ENTREGA
  retirada: '585404986',   // aba LOTES RETIRADA
  programacao: '1183141602'// aba PROGRAMAÃ‡ÃƒO
};

/* colunas que ficam ocultas em exibiÃ§Ã£o (aparecem em detalhes) - normalizadas */
const HIDDEN_COLS = ['nfp','royalties','safra'];

/* colunas removidas (normalizadas) de todas as tabelas */
const REMOVED_COMMON = ['localizacao','idorigemymvk1'];

/* colunas removidas especificamente da ProgramaÃ§Ã£o (normalizadas) */
const REMOVED_PROGRAMACAO = [
  'observacoes','ordem','notafiscal','dacte','mdfe','conftipocam','agendamento',
  'descarga','comprovantededescarga','horarioprev','classificacaodestino','chaveid'
];

/* Normaliza cabeÃ§alho: remove acento, espaÃ§os e pontuaÃ§Ã£o */
function normalizeHeader(h){
  if(h === undefined || h === null) return '';
  return String(h).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,'');
}

/* Parse CSV tolerante (trata vÃ­rgulas dentro de aspas)
   Retorna { arrays: [ [col1,col2,...], ... ], headersOrig: [], headersNorm: [], objects: [ {normKey: value}, ... ] }
*/
function parseCSV(text){
  if(!text) return {arrays:[], headersOrig:[], headersNorm:[], objects:[]};
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
  if(lines.length === 0) return {arrays:[], headersOrig:[], headersNorm:[], objects:[]};

  const parsed = lines.map(line => line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"|"$/g,'').trim()));
  const headersOrig = parsed.shift().map(h => h||'');
  const headersNorm = headersOrig.map(h => normalizeHeader(h));

  const objects = parsed.map(cells => {
    const obj = {};
    headersNorm.forEach((key, idx) => {
      obj[key] = cells[idx] !== undefined ? cells[idx] : '';
    });
    return obj;
  });

  return {arrays: parsed, headersOrig, headersNorm, objects};
}

/* fetch CSV via gviz - retorna parseCSV result */
async function fetchSheetByGid(gid){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('Erro ao buscar planilha: ' + r.status);
  const text = await r.text();
  return parseCSV(text);
}

/* util: parse number tolerant */
function parseNumber(val){
  if(val === undefined || val === null) return NaN;
  const s = String(val).replace(/\s/g,'').replace(/\./g,'').replace(/,/g,'.');
  const n = parseFloat(s.replace(/[^\d\.\-]/g,''));
  return isNaN(n) ? NaN : n;
}

/* util: parse date only (dd/mm/yyyy ou yyyy-mm-dd) -> Date (00:00:00) or null */
function parseDateOnly(s){
  if(!s) return null;
  const str = String(s).trim();
  // dd/mm/yyyy
  if(str.includes('/')){
    const parts = str.split('/');
    if(parts.length >= 3){
      const d = parseInt(parts[0],10), m = parseInt(parts[1],10), y = parseInt(parts[2],10);
      if(!isNaN(d) && !isNaN(m) && !isNaN(y)) return new Date(y, m-1, d);
    }
  }
  // yyyy-mm-dd or yyyy/mm/dd
  if(str.includes('-') || (str.includes('/') && str.indexOf('/') === 4)){
    const sep = str.includes('-')? '-' : '/';
    const parts = str.split(sep);
    if(parts.length >= 3){
      const y = parseInt(parts[0],10), m = parseInt(parts[1],10), d = parseInt(parts[2],10);
      if(!isNaN(d) && !isNaN(m) && !isNaN(y)) return new Date(y, m-1, d);
    }
  }
  const dt = new Date(str);
  if(!isNaN(dt.getTime())) return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
  return null;
}

/* encontra header normalizado que contenha um dos padrÃµes */
function findHeaderKey(headersNorm, patterns){
  for(const p of patterns){
    const f = headersNorm.find(h => h.includes(p));
    if(f) return f;
  }
  // fallbacks inteligentes
  if(patterns.includes('saldoent')){
    const f = headersNorm.find(h => h.includes('saldo') && (h.includes('ent') || h.includes('entrega') || h.includes('entkg')));
    if(f) return f;
  }
  if(patterns.includes('saldoret')){
    const f = headersNorm.find(h => h.includes('saldo') && (h.includes('ret') || h.includes('retirada') || h.includes('retkg')));
    if(f) return f;
  }
  if(patterns.some(x => x.includes('contrato'))){
    const f = headersNorm.find(h => h.includes('contrato'));
    if(f) return f;
  }
  // any saldo
  const f = headersNorm.find(h => h.includes('saldo'));
  if(f) return f;
  return null;
}

/* build table HTML: rowsArrays = array of arrays; rowsObjects = array of objects keyed by normalized headers */
function buildTableHTML(rowsArrays, rowsObjects, headersOrig, headersNorm, opts){
  // opts: {hiddenNorm:[], removedNorm:[], numericKey: 'somenorm', forceColsNorm:[]}
  const hiddenNorm = opts.hiddenNorm || [];
  const removedNorm = opts.removedNorm || [];
  const numericKey = opts.numericKey || '';
  const forceInclude = opts.forceInclude || [];

  // visible columns: headersNorm minus removed
  const visible = headersNorm.filter(h => !removedNorm.includes(h));
  // display columns exclude hidden
  let displayCols = visible.filter(h => !hiddenNorm.includes(h));

  // ensure forced columns appear first
  forceInclude.forEach(fc => {
    if(visible.includes(fc) && !displayCols.includes(fc)) displayCols.unshift(fc);
    else if(visible.includes(fc)) displayCols = [fc, ...displayCols.filter(x => x !== fc)];
  });

  if(displayCols.length === 0){
    return '<div class="empty">Sem colunas para exibir.</div>';
  }

  // construct header titles using originals
  let html = '<table><thead><tr>';
  displayCols.forEach(h => {
    const idx = headersNorm.indexOf(h);
    const title = (idx>=0 ? headersOrig[idx] : h) || h;
    html += `<th>${escapeHtml(title)}</th>`;
  });
  if(numericKey) html += '<th>Status</th>';
  html += '<th>AÃ§Ãµes</th></tr></thead><tbody>';

  rowsObjects.forEach((obj, i) => {
    const arr = rowsArrays[i] || [];
    const n = numericKey ? parseNumber( obj[numericKey] || arr[numericKeyIndex(headersNorm, numericKey)] || '0' ) : NaN;
    html += '<tr>';
    displayCols.forEach(h => {
      // prefer object value, fallback to array by index if available
      const idx = headersNorm.indexOf(h);
      const value = (obj[h] !== undefined && obj[h] !== '') ? obj[h] : (arr[idx] !== undefined ? arr[idx] : '');
      html += `<td>${escapeHtml(value)}</td>`;
    });
    if(numericKey) html += `<td>${n>0?'<span class="status status-aberto">ABERTO</span>':'<span class="status status-fechado">FECHADO</span>'}</td>`;
    html += `<td><button class="btn-details" data-row="${i}">Ver Detalhes</button></td>`;
    html += '</tr>';

    // details: show hiddenNorm columns (with original titles)
    let details = '';
    hiddenNorm.forEach(h => {
      const idx = headersNorm.indexOf(h);
      if(idx >= 0){
        const title = headersOrig[idx] || h;
        const val = (obj[h] !== undefined && obj[h] !== '') ? obj[h] : (arr[idx] !== undefined ? arr[idx] : '');
        if(val) details += `<div><strong>${escapeHtml(title)}:</strong> ${escapeHtml(val)}</div>`;
      }
    });
    if(details){
      const colspan = displayCols.length + (numericKey?2:1);
      html += `<tr class="details-row" id="details-${i}" style="display:none"><td colspan="${colspan}">${details}</td></tr>`;
    }
  });

  html += '</tbody></table>';
  return html;
}

// helper: get index of normalized key (or -1)
function numericKeyIndex(headersNorm, key){ return headersNorm.indexOf(key); }

function escapeHtml(s){
  if(s === undefined || s === null) return '';
  return String(s).replace(/[&<>"'\/]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#x27;','/':'&#x2F;'}[c]));
}

/* --- Main load function --- */
async function loadAll(){
  try{
    // ===== LOTES DE ENTREGA =====
    const ent = await fetchSheetByGid(GIDS.entrega);
    const rowsArrEnt = ent.arrays;      // array of arrays
    const headersOrigEnt = ent.headersOrig;
    const headersNormEnt = ent.headersNorm;
    const objsEnt = ent.objects;

    // Force: NÂº CONTRATO deve vir da coluna B (index 1). Fallback - find header containing 'contrato'.
    const contratoKey = findHeaderKey(headersNormEnt, ['ncontrato','numerocontrato','numero','contrato','no_contrato','numcontrato']) || null;
    const contratoIndex = 1; // column B -> index 1 (0-based)
    // Saldo Entrega (coluna I index 8) - also try to find header
    const saldoKeyEnt = findHeaderKey(headersNormEnt, ['saldoent','saldoentrega','saldoentkg']) || null;
    const saldoIndexEnt = 8;

    // build filtered rows: only saldo > 0
    const rowsObjEntFiltered = [];
    const rowsArrEntFiltered = [];
    for(let i=0;i<rowsArrEnt.length;i++){
      const arr = rowsArrEnt[i];
      const obj = objsEnt[i] || {};
      // get saldo: prefer normalized header, else fallback to index 8
      let saldoVal = '';
      if(saldoKeyEnt && obj[saldoKeyEnt] !== undefined && obj[saldoKeyEnt] !== '') saldoVal = obj[saldoKeyEnt];
      else if(arr[saldoIndexEnt] !== undefined) saldoVal = arr[saldoIndexEnt];
      const n = parseNumber(saldoVal || '0');
      if(!isNaN(n) && n > 0){
        // ensure NÂº CONTRATO appears: if contratoKey found use obj, else fallback arr[1]
        if(contratoKey && (obj[contratoKey] === undefined || obj[contratoKey] === '')){
          // if missing, but arr has index 1, set it on object for display purposes
          if(arr[contratoIndex] !== undefined) obj[contratoKey] = arr[contratoIndex];
        }
        rowsObjEntFiltered.push(obj);
        rowsArrEntFiltered.push(arr);
      }
    }

    // define removed and hidden for entrega
    const removedEnt = REMOVED_COMMON.map(normalizeHeader);
    // we don't hide NFP etc here (unless present)
    const hiddenEnt = HIDDEN_COLS.map(normalizeHeader);

    // ensure NÂº CONTRATO is forced front if found, else fallback will use column index
    const forceIncludeEnt = [];
    if(contratoKey) forceIncludeEnt.push(contratoKey);

    const tableEntHTML = buildTableHTML(rowsArrEntFiltered, rowsObjEntFiltered, headersOrigEnt, headersNormEnt, {
      hiddenNorm: hiddenEnt,
      removedNorm: removedEnt,
      numericKey: saldoKeyEnt || headersNormEnt[saldoIndexEnt] || '',
      forceInclude: forceIncludeEnt
    });

    document.getElementById('entregaContent').innerHTML = tableEntHTML || '<div class="empty">Nenhum lote de entrega em aberto.</div>';

    // ===== LOTES DE RETIRADA =====
    const ret = await fetchSheetByGid(GIDS.retirada);
    const rowsArrRet = ret.arrays;
    const headersOrigRet = ret.headersOrig;
    const headersNormRet = ret.headersNorm;
    const objsRet = ret.objects;

    // Remove INFORMAÃ‡Ã•ES ORIGEM from display: normalized key might be like 'informacoesdaorigem' etc
    const removedRet = [...REMOVED_COMMON.map(normalizeHeader)];
    // Also remove 'informacoesdaorigem' by trying to detect headers containing 'origem' or exact phrase
    const possOrigem = headersNormRet.find(h => h.includes('origem') && h.includes('informacao'));
    if(possOrigem) removedRet.push(possOrigem);

    // Hidden columns: nfp, royalties, safra (normalized)
    const hiddenRet = HIDDEN_COLS.map(normalizeHeader);

    // saldo retirada key detection fallback index (J -> index 9)
    const saldoKeyRet = findHeaderKey(headersNormRet, ['saldoret','saldoretkg','saldoretirada']) || null;
    const saldoIndexRet = 9;

    const rowsObjRetFiltered = [];
    const rowsArrRetFiltered = [];
    for(let i=0;i<rowsArrRet.length;i++){
      const arr = rowsArrRet[i];
      const obj = objsRet[i] || {};
      // get saldo
      let saldoVal = '';
      if(saldoKeyRet && obj[saldoKeyRet] !== undefined && obj[saldoKeyRet] !== '') saldoVal = obj[saldoKeyRet];
      else if(arr[saldoIndexRet] !== undefined) saldoVal = arr[saldoIndexRet];
      const n = parseNumber(saldoVal || '0');
      if(!isNaN(n) && n > 0){
        rowsObjRetFiltered.push(obj);
        rowsArrRetFiltered.push(arr);
      }
    }

    const tableRetHTML = buildTableHTML(rowsArrRetFiltered, rowsObjRetFiltered, headersOrigRet, headersNormRet, {
      hiddenNorm: hiddenRet,
      removedNorm: removedRet,
      numericKey: saldoKeyRet || headersNormRet[saldoIndexRet] || ''
    });

    document.getElementById('retiradaContent').innerHTML = tableRetHTML || '<div class="empty">Nenhum lote de retirada em aberto.</div>';

    // ===== PROGRAMAÃ‡ÃƒO (somente hoje) =====
    const prog = await fetchSheetByGid(GIDS.programacao);
    const rowsArrProg = prog.arrays;
    const headersOrigProg = prog.headersOrig;
    const headersNormProg = prog.headersNorm;
    const objsProg = prog.objects;

    // removed programacao fields normalized
    const removedProg = [...REMOVED_COMMON.map(normalizeHeader), ...REMOVED_PROGRAMACAO.map(normalizeHeader)];

    // find date key (fallback index 0)
    const dateKeyProg = findHeaderKey(headersNormProg, ['data','dataprogramacao','dataprog','dataentrega']) || headersNormProg[0] || null;
    const dateIndexProg = 0;

    const today = new Date(); const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();

    const rowsArrProgFiltered = [];
    const rowsObjProgFiltered = [];
    for(let i=0;i<rowsArrProg.length;i++){
      const arr = rowsArrProg[i];
      const obj = objsProg[i] || {};
      // get date
      let dtVal = '';
      if(dateKeyProg && obj[dateKeyProg]) dtVal = obj[dateKeyProg];
      else if(arr[dateIndexProg] !== undefined) dtVal = arr[dateIndexProg];
      const dt = parseDateOnly(dtVal);
      if(dt && dt.getTime() === todayStart){
        rowsArrProgFiltered.push(arr);
        rowsObjProgFiltered.push(obj);
      }
    }

    // Build programacao table: remove removedProg columns, no status numericKey
    const tableProgHTML = buildTableHTML(rowsArrProgFiltered, rowsObjProgFiltered, headersOrigProg, headersNormProg, {
      hiddenNorm: HIDDEN_COLS.map(normalizeHeader),
      removedNorm: removedProg,
      numericKey: '' // no automatic status column here
    });

    document.getElementById('programacaoContent').innerHTML = tableProgHTML || '<div class="empty">Nenhuma programaÃ§Ã£o para hoje.</div>';

    // attach detail toggles (delegation)
    attachDetailToggleHandlers();
  }
  catch(err){
    console.error('Erro loadAll:', err);
    document.getElementById('entregaContent').innerHTML = '<div class="empty">Erro ao carregar dados (ver console).</div>';
    document.getElementById('retiradaContent').innerHTML = '<div class="empty">Erro ao carregar dados (ver console).</div>';
    document.getElementById('programacaoContent').innerHTML = '<div class="empty">Erro ao carregar dados (ver console).</div>';
  }
}

/* toggles for details buttons (delegation) */
function attachDetailToggleHandlers(){
  document.querySelectorAll('.btn-details').forEach(btn=>{
    btn.onclick = (e) => {
      const rowIndex = btn.getAttribute('data-row');
      if(!rowIndex) return;
      const id = 'details-' + rowIndex;
      const el = document.getElementById(id);
      if(!el) return;
      const visible = el.style.display === 'table-row';
      el.style.display = visible ? 'none' : 'table-row';
    };
  });
}

/* init */
document.getElementById('btnRefresh').addEventListener('click', () => {
  document.getElementById('entregaContent').innerHTML = '<div class="empty">Atualizando...</div>';
  document.getElementById('retiradaContent').innerHTML = '<div class="empty">Atualizando...</div>';
  document.getElementById('programacaoContent').innerHTML = '<div class="empty">Atualizando...</div>';
  loadAll();
});

loadAll();
</script>
</body>
</html>
