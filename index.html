<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Controle de Lotes ‚Äî Entrega & Retirada</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root{
      --primary:#2563eb; --secondary:#0ea5e9; --bg:#f7fbff; --card:#fff; --text:#0f172a;
      --muted:#6b7280; --success:#10b981; --warning:#f59e0b;
    }
    *{box-sizing:border-box}
    body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;margin:0;background:var(--bg);color:var(--text);padding:18px}
    header{background:linear-gradient(90deg,var(--primary),var(--secondary));color:white;padding:14px;border-radius:10px;margin-bottom:18px;text-align:center;font-weight:700}
    .container{max-width:1200px;margin:0 auto}
    .top-actions{display:flex;justify-content:flex-end;gap:10px;margin-bottom:12px}
    button.refresh{background:var(--primary);color:white;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .section{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(15,23,42,0.06)}
    h2{margin:0 0 10px 0;color:var(--primary);display:flex;align-items:center;gap:8px}
    .card{background:#fff;border-radius:10px;padding:10px;margin-bottom:10px}
    table{width:100%;border-collapse:collapse;font-size:0.92rem}
    th,td{border:1px solid #e6eefc;padding:8px;text-align:left;vertical-align:top}
    th{background:linear-gradient(90deg,var(--primary),var(--secondary));color:#fff;font-weight:700}
    tr:nth-child(even){background:#fbfdff}
    .status{padding:6px 10px;border-radius:18px;color:#fff;font-weight:700;display:inline-block}
    .status-aberto{background:var(--warning)}
    .status-concluido{background:var(--success)}
    .empty{color:var(--muted);font-style:italic;padding:10px}
    .btn-details{background:transparent;border:0;color:var(--primary);cursor:pointer;text-decoration:underline;padding:0}
    .details-row{display:none;background:#f3f7ff}
    .details-row.visible{display:table-row}
    @media(max-width:900px){th,td{font-size:0.82rem}}
  </style>
</head>
<body>
  <header>üì¶ Controle de Lotes ‚Äî Entrega & Retirada</header>

  <div class="container">
    <div class="top-actions">
      <button class="refresh" id="btnRefresh"><i class="fas fa-sync-alt"></i> Atualizar</button>
    </div>

    <div class="grid">
      <section class="section" id="secProgramacao">
        <h2><i class="fas fa-calendar-check"></i> Programa√ß√£o (Somente hoje)</h2>
        <div id="programacaoContent" class="card"></div>
      </section>

      <section class="section" id="secEntrega">
        <h2><i class="fas fa-truck-loading"></i> Lotes de Entrega</h2>
        <div id="entregaContent" class="card"></div>
      </section>

      <section class="section" id="secRetirada">
        <h2><i class="fas fa-warehouse"></i> Lotes de Retirada</h2>
        <div id="retiradaContent" class="card"></div>
      </section>
    </div>
  </div>

  <script>
  /***********************
   * CONFIG
   ***********************/
  const SHEET_ID = '1CZZgYJiZic9pyFFTdyldm_gVwn2K-zSGY9uhFJ5Nz6Q';
  const GIDS = {
    programacao: '1183141602',
    entrega: '271702555',
    retirada: '585404986'
  };

  // colunas que ficam escondidas nos details (normalizadas)
  const HIDDEN_COLS = ['nfp','royalties','safra'];

  // colunas removidas globalmente (normalizadas)
  const REMOVED_COMMON = ['localizacao','idorigemymvk1','informacoesdestino','situacaoent','iddestino'];

  // colunas removidas ESPEC√çFICO para Programa√ß√£o (normalizadas)
  const REMOVED_PROGRAMACAO = [
    'observacoes','ordem','notafiscal','notafical','dacte','mdfe','conftipocam','agendamento',
    'descarga','comprovantededescarga','horarioprev','classificacaodestino','chaveid'
  ];

  /***********************
   * UTIL: normaliza cabe√ßalhos (remove acentos, pontua√ß√£o e espa√ßos)
   ***********************/
  function normalizeHeader(h){
    if(!h && h !== 0) return '';
    return String(h)
      .trim()
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')   // remove acentos
      .replace(/[^a-z0-9]/g,'');                        // remove tudo que n√£o seja alfanum√©rico
  }

  /***********************
   * UTIL: parse CSV tolerante (trata v√≠rgulas dentro de aspas)
   * retorna { rows: [ {normalizedKey: value} ... ], headers: [normalizedKeys], originals: [originais] }
   ***********************/
  function parseCSV(text){
    if(!text) return {rows:[], headers:[], originals:[]};
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
    if(lines.length === 0) return {rows:[], headers:[], originals:[]};

    // split de forma segura: v√≠rgulas fora de aspas
    const parsed = lines.map(line => line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"|"$/g,'').trim()));
    const origHeaders = parsed.shift().map(h => h || '');
    const headers = origHeaders.map(h => normalizeHeader(h));

    const rows = parsed.map(cells => {
      const obj = {};
      headers.forEach((key, idx) => {
        obj[key] = (cells[idx] !== undefined) ? cells[idx].replace(/^"|"$/g,'').trim() : '';
      });
      return obj;
    });

    return {rows, headers, originals: origHeaders};
  }

  /***********************
   * UTIL: leitura CSV via gviz (mais confi√°vel)
   ***********************/
  async function fetchCSV(gid){
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('Erro ao buscar planilha: ' + r.status);
    const txt = await r.text();
    return parseCSV(txt);
  }

  /***********************
   * UTIL: converte string pra n√∫mero (tolerante)
   ***********************/
  function parseNumber(val){
    if(val === undefined || val === null) return NaN;
    const s = String(val).replace(/\s/g,'').replace(/\./g,'').replace(/,/g,'.'); // 1.234,56 -> 1234.56
    const n = parseFloat(s.replace(/[^\d\.\-]/g,'')); // tira caracteres n√£o num√©ricos (exceto - .)
    return isNaN(n) ? NaN : n;
  }

  /***********************
   * UTIL: parse date dd/mm/yyyy ou yyyy-mm-dd -> Date sem hor√°rio
   ***********************/
  function parseDateOnly(s){
    if(!s) return null;
    const str = String(s).trim();
    // tenta dd/mm/yyyy
    if(str.includes('/')){
      const parts = str.split('/');
      if(parts.length >= 3){
        const d = parseInt(parts[0],10), m = parseInt(parts[1],10), y = parseInt(parts[2],10);
        if(!isNaN(d) && !isNaN(m) && !isNaN(y)) return new Date(y, m-1, d);
      }
    }
    // tenta yyyy-mm-dd ou yyyy/mm/dd
    if(str.includes('-') || str.includes('/')){
      const sep = str.includes('-')? '-' : '/';
      const parts = str.split(sep);
      if(parts.length >= 3){
        const y = parseInt(parts[0],10), m = parseInt(parts[1],10), d = parseInt(parts[2],10);
        if(!isNaN(d) && !isNaN(m) && !isNaN(y)) return new Date(y, m-1, d);
      }
    }
    // tentativa final: Date parser
    const dt = new Date(str);
    if(!isNaN(dt.getTime())) return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
    return null;
  }

  /***********************
   * Render helpers
   ***********************/
  function renderEmpty(msg){
    return `<div class="empty">${msg}</div>`;
  }

  // busca header existente por lista de padr√µes (headers j√° normalizados)
  function findHeaderKey(headers, patterns){
    for(const p of patterns){
      const found = headers.find(h => h.includes(p));
      if(found) return found;
    }
    // alguns fallback gen√©ricos
    if(patterns.includes('saldoret')){
      const f = headers.find(h => h.includes('saldo') && (h.includes('ret') || h.includes('retirada') || h.includes('retkg')));
      if(f) return f;
    }
    if(patterns.includes('saldoent')){
      const f = headers.find(h => h.includes('saldo') && (h.includes('ent') || h.includes('entrega') || h.includes('entkg')));
      if(f) return f;
    }
    if(patterns.includes('ncontrato') || patterns.includes('contrato')){
      const f = headers.find(h => h.includes('contrato'));
      if(f) return f;
    }
    const f = headers.find(h => h.includes('saldo'));
    if(f) return f;
    return null;
  }

  // buildTable: forceInclude = array de headers normalizados para garantir exibi√ß√£o (ex: ['ncontrato'])
  function buildTableHTML(rows, headers, originals, hiddenNorm, removedNorm, numericKey, mode, forceInclude = []){
    if(!rows || rows.length === 0) return '';

    // vis√≠veis = headers sem os removidos
    const visible = headers.filter(h => !removedNorm.includes(h));
    // colunas exibidas (sem as hidden)
    let displayCols = visible.filter(h => !hiddenNorm.includes(h));

    // garantir colunas em forceInclude na frente (se existirem)
    forceInclude.forEach(fc => {
      if(visible.includes(fc) && !displayCols.includes(fc)){
        displayCols.unshift(fc);
      } else if(visible.includes(fc)){
        // mover para frente se j√° est√° presente
        displayCols = [fc, ...displayCols.filter(x => x !== fc)];
      }
    });

    // se n√£o h√° colunas vis√≠veis, mostrar nada
    if(displayCols.length === 0) return '';

    // montar cabe√ßalho (usar nomes originais)
    let html = '<table><thead><tr>';
    displayCols.forEach(h => {
      const idx = headers.indexOf(h);
      const title = (idx >= 0) ? originals[idx] : h;
      html += `<th>${escapeHtml(title)}</th>`;
    });

    const showStatus = Boolean(numericKey);
    if(showStatus) html += '<th>Status</th>';
    html += '<th>A√ß√µes</th></tr></thead><tbody>';

    rows.forEach((row, idx) => {
      const n = showStatus ? parseNumber(row[numericKey] || '0') : NaN;
      html += '<tr>';
      displayCols.forEach(h => {
        html += `<td>${escapeHtml(row[h] || '')}</td>`;
      });
      if(showStatus) html += `<td>${n>0 ? `<span class="status status-aberto">Aberto</span>` : `<span class="status status-concluido">Conclu√≠do</span>`}</td>`;
      html += `<td><button class="btn-details" onclick="toggleDetails('${mode}-${idx}')">Ver Detalhes</button></td>`;
      html += '</tr>';

      // detalhes: mostrar colunas hidden (com nomes originais)
      let detailsHtml = '';
      hiddenNorm.forEach(h => {
        const idxH = headers.indexOf(h);
        if(idxH >= 0){
          const title = originals[idxH];
          const val = row[h] || '';
          if(val) detailsHtml += `<div><strong>${escapeHtml(title)}:</strong> ${escapeHtml(val)}</div>`;
        }
      });

      if(detailsHtml){
        const colspan = displayCols.length + (showStatus ? 2 : 1);
        html += `<tr id="details-${mode}-${idx}" class="details-row"><td colspan="${colspan}">${detailsHtml}</td></tr>`;
      }
    });

    html += '</tbody></table>';
    return html;
  }

  function escapeHtml(s){
    if(s === undefined || s === null) return '';
    return String(s).replace(/[&<>"'\/]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#x27;','/':'&#x2F;'}[c]));
  }

  window.toggleDetails = function(id){
    const el = document.getElementById('details-'+id);
    if(!el) return;
    el.classList.toggle('visible');
  };

  /***********************
   * Carrega tudo
   ***********************/
  async function loadAll(){
    // PROGRAMACAO -> somente hoje, remove colunas especificadas
    try{
      const progData = await fetchCSV(GIDS.programacao);
      const rows = progData.rows || [], headers = progData.headers || [], orig = progData.originals || [];
      if(!rows.length){
        document.getElementById('programacaoContent').innerHTML = renderEmpty('Nenhuma programa√ß√£o encontrada.');
      } else {
        const hiddenNorm = HIDDEN_COLS.map(normalizeHeader);
        const removedNorm = [...REMOVED_COMMON.map(normalizeHeader), ...REMOVED_PROGRAMACAO.map(normalizeHeader)];
        // localizar coluna de data
        const dateKey = findHeaderKey(headers, ['data','dataprogramacao','dataprog','dataentrega']);
        if(!dateKey){
          console.warn('Programa√ß√£o - date column not found. headers:', headers);
          document.getElementById('programacaoContent').innerHTML = renderEmpty('Coluna de data n√£o encontrada na programa√ß√£o.');
        } else {
          // hoje (sem hor√°rio)
          const now = new Date(); const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
          const filtered = rows.filter(r => {
            const dt = parseDateOnly(r[dateKey]);
            return dt && dt.getTime() === today;
          });
          if(!filtered.length){
            document.getElementById('programacaoContent').innerHTML = renderEmpty('Nenhuma programa√ß√£o para hoje.');
          } else {
            // numericKey vazio (n√£o exibe coluna status)
            const html = buildTableHTML(filtered, headers, orig, hiddenNorm, removedNorm, '', 'prog');
            document.getElementById('programacaoContent').innerHTML = html || renderEmpty('Nenhuma programa√ß√£o para hoje.');
          }
        }
      }
    }catch(e){
      console.error('Erro programacao', e);
      document.getElementById('programacaoContent').innerHTML = `<div class="empty">Erro ao carregar programa√ß√£o: ${escapeHtml(e.message||e)}</div>`;
    }

    // ENTREGA -> N¬∫ CONTRATO (coluna B) deve aparecer; filtrar SALDO ENT > 0
    try{
      const ent = await fetchCSV(GIDS.entrega);
      const rows = ent.rows || [], headers = ent.headers || [], orig = ent.originals || [];
      if(!rows.length){
        document.getElementById('entregaContent').innerHTML = renderEmpty('Nenhum dado de entrega.');
      } else {
        const hiddenNorm = HIDDEN_COLS.map(normalizeHeader);
        const removedNorm = REMOVED_COMMON.map(normalizeHeader); // remove as colunas comuns pedidas
        // localizar saldo entrega
        const saldoKey = findHeaderKey(headers, ['saldoent','saldoentrega','saldoentkg','saldokg','saldoentkg']);
        if(!saldoKey){
          console.warn('Entrega - saldo column not found. headers:', headers, 'orig:', orig);
          document.getElementById('entregaContent').innerHTML = `<div class="empty">Coluna de "Saldo Entrega" n√£o encontrada (verifique cabe√ßalho).</div>`;
        } else {
          // localizar N¬∫ CONTRATO (v√°rias formas)
          const contratoKey = findHeaderKey(headers, ['ncontrato','numerocontrato','numero_contrato','numero','contrato','no_contrato','numcontrato']);
          if(!contratoKey){
            console.warn('Entrega - contrato column not found. headers:', headers, 'orig:', orig);
            // n√£o falhar, s√≥ n√£o for√ßamos
          }
          // filtrar > 0
          const filtered = rows.filter(r => parseNumber(r[saldoKey]||'0') > 0);
          if(!filtered.length){
            document.getElementById('entregaContent').innerHTML = renderEmpty('Nenhum lote de entrega em aberto.');
          } else {
            const forceInclude = contratoKey ? [contratoKey] : [];
            const html = buildTableHTML(filtered, headers, orig, hiddenNorm, removedNorm, saldoKey, 'entrega', forceInclude);
            document.getElementById('entregaContent').innerHTML = html;
          }
        }
      }
    }catch(e){
      console.error('Erro entrega', e);
      document.getElementById('entregaContent').innerHTML = `<div class="empty">Erro ao carregar lotes de entrega: ${escapeHtml(e.message||e)}</div>`;
    }

    // RETIRADA -> SALDO RET. (KG) > 0, esconder NFP/Royalties/Safra e remover localizacao, idorigemymvk1
    try{
      const ret = await fetchCSV(GIDS.retirada);
      const rows = ret.rows || [], headers = ret.headers || [], orig = ret.originals || [];
      if(!rows.length){
        document.getElementById('retiradaContent').innerHTML = renderEmpty('Nenhum dado de retirada.');
      } else {
        const hiddenNorm = HIDDEN_COLS.map(normalizeHeader);
        const removedNorm = REMOVED_COMMON.map(normalizeHeader);
        const saldoKey = findHeaderKey(headers, ['saldoret','saldoretkg','saldoretirada','saldoretkg']);
        if(!saldoKey){
          console.warn('Retirada - saldo column not found. headers:', headers, 'orig:', orig);
          document.getElementById('retiradaContent').innerHTML = `<div class="empty">Coluna de "Saldo Ret." n√£o encontrada (verifique cabe√ßalho).</div>`;
        } else {
          const filtered = rows.filter(r => parseNumber(r[saldoKey]||'0') > 0);
          if(!filtered.length){
            document.getElementById('retiradaContent').innerHTML = renderEmpty('Nenhum lote de retirada em aberto.');
          } else {
            const html = buildTableHTML(filtered, headers, orig, hiddenNorm, removedNorm, saldoKey, 'retirada');
            document.getElementById('retiradaContent').innerHTML = html;
          }
        }
      }
    }catch(e){
      console.error('Erro retirada', e);
      document.getElementById('retiradaContent').innerHTML = `<div class="empty">Erro ao carregar lotes de retirada: ${escapeHtml(e.message||e)}</div>`;
    }
  }

  document.getElementById('btnRefresh').addEventListener('click', loadAll);
  // carregar ao abrir
  loadAll();

  /***********************
   * Debug notes
   * - Se alguma se√ß√£o disser "coluna ... n√£o encontrada", abra o Console (F12) e cole aqui a sa√≠da dos "headers" mostrados
   * - Certifique-se que a planilha est√° vis√≠vel para quem tem o link (ou p√∫blica) para que o browser fa√ßa o fetch do CSV
   ***********************/
  </script>
</body>
</html>
