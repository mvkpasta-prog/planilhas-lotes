<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controle de Lotes ‚Äî Lotes de Entrega</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  :root{
    --primary:#2563eb; --accent:#0ea5e9; --bg:#f6fbff; --card:#fff; --text:#0f172a;
    --muted:#6b7280; --success:#10b981; --warning:#f59e0b;
    --status-carregado: #10b981;
    --status-embarque: #3b82f6;
    --status-transito: #ef4444;
    --status-contratar: #f97316;
    --produto-soja: #10b981;
    --produto-milho: #fbbf24;
    --produto-sorgo: #6b7280;
    --produto-total: #8b5cf6;
  }
  *{box-sizing:border-box}
  body{font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;margin:0;background:var(--bg);color:var(--text);padding:12px}
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('https://raw.githubusercontent.com/mvkpasta-prog/planilhas-lotes/main/mvklogo.png');
    background-repeat: no-repeat;
    background-position: center center;
    background-size: 80vh;
    opacity: 0.05;
    z-index: -1;
    pointer-events: none;
  }
  header{
    background:linear-gradient(90deg,var(--primary),var(--accent));
    color:white;
    padding:12px;
    border-radius:8px;
    margin-bottom:16px;
    text-align:center;
    font-weight:700;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    flex-wrap: wrap;
  }
  .header-title { display:flex; align-items:center; gap:8px; min-width:200px; }
  .last-update-top { font-size:12px; color:rgba(255,255,255,0.9); display:flex; align-items:center; gap:6px; }
  .wrap{max-width:1400px;margin:0 auto;width:100%}
  .header-btn { background:#fff; color:var(--primary); border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-weight:700; font-size:13px; text-decoration:none; transition:background .2s, opacity .2s; display:flex; align-items:center; gap:6px; }
  .header-btn:hover { background:var(--bg); opacity:.95; }

  /* novo layout dos status cards: grid com duas colunas; produtos ficam numa linha abaixo em 4 colunas */
  .status-cards {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .status-card{background:var(--card);border-radius:8px;padding:10px;box-shadow:0 3px 8px rgba(0,0,0,0.06);text-align:center;transition:all .3s; min-height:72px; display:flex; flex-direction:column; justify-content:center;}
  .status-card:hover{transform:translateY(-2px);box-shadow:0 5px 12px rgba(0,0,0,0.08)}
  .status-card h3{margin:0 0 6px 0;font-size:14px;color:var(--text);font-weight:600}
  .status-card .count{font-size:22px;font-weight:700;margin:6px 0}

  /* area que ocupa a segunda linha com 4 cards de produto */
  .product-row {
    grid-column: 1 / -1; /* ocupa as 2 colunas da grid pai */
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
  }

  .clientes-section{margin-bottom:24px}
  .clientes-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-bottom:24px}
  .cliente-card{background:var(--card);border-radius:8px;padding:14px;box-shadow:0 3px 8px rgba(0,0,0,0.06);transition:all .3s; cursor:pointer;}
  .cliente-card:hover{transform:translateY(-2px);box-shadow:0 5px 12px rgba(0,0,0,0.08)}
  .cliente-name{font-weight:700;font-size:16px;color:var(--text);margin:0 0 6px 0}
  .cliente-destino{font-weight:600;color:var(--accent);margin:0 0 10px 0;font-size:13px}
  .cliente-info{display:flex;justify-content:space-between;margin-bottom:6px;align-items:center}
  .info-label{font-weight:600;color:var(--muted);font-size:12px}
  .info-value{font-weight:700;font-size:13px}
  .cliente-produto{padding:3px 7px;border-radius:5px;font-size:11px;font-weight:600;display:inline-block;margin-top:4px}
  .status-pendente-tag{background-color: var(--status-embarque);color: white;padding: 2px 7px;border-radius: 10px;font-size: 11px;font-weight: 600;}
  .empty{color:var(--muted);font-style:italic;padding:10px;text-align:center;}
  #filterInput {flex-grow:1; min-width:200px; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px}

  .modal-overlay {position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.6); display:none; justify-content:center; align-items:center; z-index:1000}
  .modal-content {background:var(--card); padding:20px; border-radius:8px; max-width:900px; width:95%; max-height:90vh; overflow-y:auto; position:relative;}
  .modal-close {position:absolute; top:10px; right:10px; background:none; border:none; font-size:22px; cursor:pointer; color:var(--muted)}
  .modal-header h3 {margin-top:0; font-size:18px; color:var(--primary); border-bottom:2px solid var(--accent); padding-bottom:8px; margin-bottom:15px;}
  .modal-body p {margin:5px 0; font-size:14px}
  .modal-body .info-label {font-weight:600; color:var(--text); display:inline-block; min-width:160px;}
  .modal-body .info-value {font-weight:400; color:var(--muted);}
  .contrato-item {padding:8px 0; border-bottom:1px dashed #eee;}
  .contrato-item:last-child {border-bottom:none;}
  .contracts-table {width:100%; border-collapse:collapse; margin-top:12px}
  .contracts-table th, .contracts-table td {padding:8px; border:1px solid #eee; font-size:13px; text-align:left}
  .contracts-table th {background:#fafafa; font-weight:700}
  .product-breakdown {display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
  .product-chip {padding:6px 10px; border-radius:999px; font-weight:700; font-size:13px; color:#fff; display:inline-block}

  @media (max-width:1100px){
    .product-row { grid-template-columns: repeat(2, 1fr); }
  }
  @media (max-width:700px){
    .status-cards { grid-template-columns: 1fr; }
    .product-row { grid-template-columns: repeat(2,1fr); }
  }
  @media (max-width:480px){
    .product-row { grid-template-columns: 1fr; }
  }

  @media (max-width:600px){
    body{padding:8px}
    .cliente-card{min-width:100%; padding:12px}
    header {flex-direction:column; align-items:flex-start; gap:10px}
    .header-btn {width:100%; justify-content:center; order:2}
    .header-title {width:100%; justify-content:space-between}
    .last-update-top {order:3}
  }

  /* estilo do toggle button igual ao Retiradas */
  .toggle-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 700;
    font-size: 14px;
    transition: opacity 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
  }
  .toggle-btn.secondary {
    background: #ffffff;
    color: var(--primary);
    border: 2px solid rgba(255,255,255,0.15);
  }
  .toggle-btn:hover { opacity: 0.95; }
</style>
</head>
<body>
  <header>
    <div class="header-title">
      <img src="https://raw.githubusercontent.com/mvkpasta-prog/planilhas-lotes/main/mvklogo.png" alt="Logo MVK" style="height:22px; vertical-align:middle; margin-right:8px;">
      Controle de Lotes ‚Äî Lotes de Entrega
    </div>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <a href="index.html" class="header-btn" title="Voltar para a p√°gina principal"><i class="fas fa-home"></i> P√°gina Inicial</a>
      <a href="Retiradas.html" class="header-btn" title="Acessar Lotes de Retirada"><i class="fas fa-box"></i> Lotes de Retirada</a>
    </div>
    <div class="last-update-top" id="lastUpdateTop"><i class="fas fa-hourglass-half"></i> <span>Atualizando...</span></div>
  </header>

  <div class="wrap">
    <div class="status-cards">
      <!-- Top: Clientes e Contratos -->
      <div class="status-card">
        <h3>CLIENTES</h3>
        <div class="count" id="count-clientes">0</div>
      </div>

      <div class="status-card">
        <h3>CONTRATOS</h3>
        <div class="count" id="count-contratos">0</div>
      </div>

      <!-- Product row (ocupa as 2 colunas e mostra 4 cards) -->
      <div class="product-row">
        <div class="status-card produto-soja">
          <h3>SOJA (KG)</h3>
          <div class="count" id="count-soja">0</div>
        </div>

        <div class="status-card produto-milho">
          <h3>MILHO (KG)</h3>
          <div class="count" id="count-milho">0</div>
        </div>

        <div class="status-card">
          <h3>SORGO (KG)</h3>
          <div class="count" id="count-sorgo">0</div>
        </div>

        <div class="status-card">
          <h3>TOTAL (KG)</h3>
          <div class="count" id="count-total">0</div>
        </div>
      </div>
    </div>

    <div class="clientes-section">
      <h2 style="margin-top:0;">üìç Lotes com Saldo a Entregar</h2>
      <div style="display:flex; gap:10px; margin-bottom:16px; flex-wrap:wrap;">
        <input type="text" id="filterInput" placeholder="Filtrar por Cliente, Contrato ou Cidade...">
        <button class="toggle-btn" id="toggleViewBtn" onclick="toggleView()"><i class="fas fa-sync-alt"></i> Mudar para Locais</button>
      </div>
      <div class="clientes-container" id="clientesContainer">
        <div class="empty">Carregando...</div>
      </div>
    </div>
  </div>

  <div id="resumoModal" class="modal-overlay">
    <div class="modal-content" role="dialog" aria-modal="true">
      <button class="modal-close" onclick="closeModal()">&times;</button>
      <div id="modalContentBody"></div>
    </div>
  </div>

<script>
const SHEET_ID = '1o0wF2ScSkyxqY8FHFI-rA6k_3uMI2wsZr2wQG8JD4B4';
const GID_ENTREGA = '1186247985';
const AUTO_UPDATE_INTERVAL = 300000;

let globalData = [];
let currentView = localStorage.getItem('lotes_entregas_view') || 'cliente'; // 'cliente' ou 'local'

/* ---------- UTILS ---------- */
function normalizeHeader(h) { if (h==null) return ''; return String(h).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,''); }
function normalizeText(t) { if (t==null) return ''; return String(t).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
function parseCSV(text) {
  if (!text) return { arrays: [], headersOrig: [], headersNorm: [], objects: [] };
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
  if (lines.length === 0) return { arrays: [], headersOrig: [], headersNorm: [], objects: [] };
  const parsed = lines.map(line => line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"|"$/g,'').trim()));
  const headersOrig = parsed.shift().map(h => h || '');
  const headersNorm = headersOrig.map(h => normalizeHeader(h));
  const objects = parsed.map(cells => {
    const obj = {};
    headersNorm.forEach((key, idx) => { obj[key] = cells[idx] !== undefined ? cells[idx] : ''; });
    return obj;
  });
  return { arrays: parsed, headersOrig, headersNorm, objects };
}
async function fetchSheetByGid(gid) {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}`;
  const r = await fetch(url);
  if (!r.ok) throw new Error('Erro ao buscar planilha: ' + r.status);
  const text = await r.text();
  return parseCSV(text);
}
function parseNumber(val) {
  if (val===undefined || val===null) return NaN;
  const s = String(val).replace(/\s/g,'').replace(/\./g,'').replace(/,/g,'.');
  return parseFloat(s.replace(/[^\d\.\-]/g,''));
}
function formatNumber(value) {
  if (isNaN(value)) return '0';
  return new Intl.NumberFormat('pt-BR').format(Math.round(value));
}
function escapeHtml(s) {
  if (s===undefined || s===null) return '';
  return String(s).replace(/[&<>"'\/]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#x2F;'}[c]));
}
function escapeForJs(s) {
  if (s===undefined || s===null) return '';
  return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/\r/g,'').replace(/\n/g,'\\n');
}

/* ---------- PROCESSAMENTO ---------- */
function extractContractNumber(raw) {
  if (!raw) return '';
  const s = String(raw).trim();
  if (s.includes('-')) return s.split('-')[0].trim();
  return s;
}

function processData(rowsArr) {
  // Agrupa por cliente (padr√£o)
  const grupos = {};
  for (let i = 0; i < rowsArr.length; i++) {
    const row = rowsArr[i];
    if (!row || row.length < 9) continue;

    const contratoRaw = ((row[1] && String(row[1]).trim() !== '') ? String(row[1]).trim() : (row[0] || '')).toString().trim();
    const contrato = extractContractNumber(contratoRaw);
    const cliente = (row[2] || '').trim();  // C
    const cidadeCompleta = row[3] || '';    // D
    const produto = (row[4] || '').trim();  // E
    const safra = (row[5] || '').trim();    // F
    const volume = parseNumber(row[6]) || 0; // G
    const embarcado = parseNumber(row[7]) || 0; // H
    const falta = parseNumber(row[8]) || 0;     // I

    if (falta <= 0 || !cliente) continue;

    let cidade = cidadeCompleta;
    if (cidadeCompleta.includes('-')) cidade = cidadeCompleta.split('-').slice(1).join('-').trim();

    if (!grupos[cliente]) {
      grupos[cliente] = { cliente, cidadeRef: cidade, contratos: [], totalVolume:0, totalEmbarcado:0, totalFalta:0, produtos: new Set() };
    }

    grupos[cliente].contratos.push({
      contrato, cidade, produto, safra, volume, embarcado, falta,
      searchKey: normalizeText(`${cliente} ${contrato} ${cidade} ${produto}`)
    });

    grupos[cliente].totalVolume += volume;
    if (produto) grupos[cliente].produtos.add(produto);
    grupos[cliente].totalEmbarcado += embarcado;
    grupos[cliente].totalFalta += falta;
  }

  return Object.values(grupos).sort((a,b) => b.totalFalta - a.totalFalta);
}

/* Agrupa por cidade destino ‚Äî retorna array de grupos { cidade, contratos: [...], clientes: Set, totals... } */
function processDataByCity(rowsArr) {
  const grupos = {};
  for (let i = 0; i < rowsArr.length; i++) {
    const row = rowsArr[i];
    if (!row || row.length < 9) continue;
    const contratoRaw = ((row[1] && String(row[1]).trim() !== '') ? String(row[1]).trim() : (row[0] || '')).toString().trim();
    const contrato = extractContractNumber(contratoRaw);
    const cliente = (row[2] || '').trim();  // C
    const cidadeCompleta = row[3] || '';    // D
    const produto = (row[4] || '').trim();  // E
    const safra = (row[5] || '').trim();    // F
    const volume = parseNumber(row[6]) || 0; // G
    const embarcado = parseNumber(row[7]) || 0; // H
    const falta = parseNumber(row[8]) || 0;     // I

    if (falta <= 0 || !cidadeCompleta) continue;

    let cidade = cidadeCompleta;
    if (cidadeCompleta.includes('-')) cidade = cidadeCompleta.split('-').slice(1).join('-').trim();

    if (!grupos[cidade]) {
      grupos[cidade] = { cidade, contratos: [], clientes: new Set(), totalVolume:0, totalEmbarcado:0, totalFalta:0, produtos: new Set() };
    }

    grupos[cidade].contratos.push({
      contrato, cliente, produto, safra, volume, embarcado, falta,
      searchKey: normalizeText(`${cliente} ${contrato} ${cidade} ${produto}`)
    });

    grupos[cidade].clientes.add(cliente);
    grupos[cidade].totalVolume += volume;
    if (produto) grupos[cidade].produtos.add(produto);
    grupos[cidade].totalEmbarcado += embarcado;
    grupos[cidade].totalFalta += falta;
  }
  return Object.values(grupos).sort((a,b) => b.totalFalta - a.totalFalta);
}

/* ---------- RENDERIZA√á√ÉO ---------- */
function renderClientCards(data, filter = '') {
  const container = document.getElementById('clientesContainer');
  container.innerHTML = '';
  if (!data || data.length === 0) {
    container.innerHTML = '<div class="empty">Nenhum lote com saldo a entregar.</div>';
    return;
  }
  const f = normalizeText(filter || '');
  let totalClientes = data.length;
  let totalContratos = 0;
  let totalSoja = 0, totalMilho = 0, totalSorgo = 0;

  data.forEach(group => {
    // aplicar filtro pelo searchKey das linhas do contrato
    const contratosFiltrados = group.contratos.filter(c => c.searchKey.includes(f));
    if (f && contratosFiltrados.length === 0) return;

    totalContratos += group.contratos.length;
    group.contratos.forEach(c => {
      const prod = (c.produto || '').toLowerCase();
      if (prod.includes('soja')) totalSoja += c.falta;
      else if (prod.includes('milho')) totalMilho += c.falta;
      else if (prod.includes('sorgo')) totalSorgo += c.falta;
    });

    const card = document.createElement('div');
    card.className = 'cliente-card';
    const prodList = Array.from(group.produtos).slice(0,3).map(p => `<span class="cliente-produto" style="background-color:var(--produto-soja); color:#fff">${escapeHtml(p)}</span>`).join(' ');
    const inner = `
      <div class="cliente-name">${escapeHtml(group.cliente)}</div>
      <div class="cliente-destino">${escapeHtml(group.cidadeRef)}</div>
      <div class="cliente-info">
        <div><span class="info-label">Saldo (kg)</span> <div class="info-value">${formatNumber(group.totalFalta)}</div></div>
        <div><span class="info-label">Contratos</span> <div class="info-value">${group.contratos.length}</div></div>
      </div>
      <div style="margin-top:8px">${prodList}</div>
    `;
    card.innerHTML = inner;
    card.onclick = () => openClientModal(group);
    container.appendChild(card);
  });

  // Atualiza contadores topo
  document.getElementById('count-clientes').innerText = totalClientes;
  document.getElementById('count-contratos').innerText = totalContratos;
  document.getElementById('count-soja').innerText = formatNumber(totalSoja);
  document.getElementById('count-milho').innerText = formatNumber(totalMilho);
  document.getElementById('count-sorgo').innerText = formatNumber(totalSorgo);
  document.getElementById('count-total').innerText = formatNumber(totalSoja + totalMilho + totalSorgo);
}

function renderCityCards(data, filter = '') {
  const container = document.getElementById('clientesContainer');
  container.innerHTML = '';
  if (!data || data.length === 0) {
    container.innerHTML = '<div class="empty">Nenhuma cidade com saldo a entregar.</div>';
    return;
  }
  const f = normalizeText(filter || '');
  let totalCidades = data.length;
  let totalContratos = 0;
  let totalSoja = 0, totalMilho = 0, totalSorgo = 0;

  data.forEach(group => {
    const contratosFiltrados = group.contratos.filter(c => c.searchKey.includes(f));
    if (f && contratosFiltrados.length === 0) return;

    totalContratos += group.contratos.length;
    group.contratos.forEach(c => {
      const prod = (c.produto || '').toLowerCase();
      if (prod.includes('soja')) totalSoja += c.falta;
      else if (prod.includes('milho')) totalMilho += c.falta;
      else if (prod.includes('sorgo')) totalSorgo += c.falta;
    });

    const card = document.createElement('div');
    card.className = 'cliente-card';
    const clientesList = Array.from(group.clientes).slice(0,3).map(p => `<div style="font-size:13px">${escapeHtml(p)}</div>`).join('');
    const prodList = Array.from(group.produtos).slice(0,3).map(p => `<span class="cliente-produto" style="background-color:var(--produto-soja); color:#fff">${escapeHtml(p)}</span>`).join(' ');
    const inner = `
      <div class="cliente-name">${escapeHtml(group.cidade)}</div>
      <div class="cliente-destino">${escapeHtml(group.clientes.size + ' cliente(s)')}</div>
      <div class="cliente-info">
        <div><span class="info-label">Saldo (kg)</span> <div class="info-value">${formatNumber(group.totalFalta)}</div></div>
        <div><span class="info-label">Contratos</span> <div class="info-value">${group.contratos.length}</div></div>
      </div>
      <div style="margin-top:8px">${prodList}</div>
      <div style="margin-top:8px; color:var(--muted); font-size:13px">${clientesList}</div>
    `;
    card.innerHTML = inner;
    card.onclick = () => openCityModal(group);
    container.appendChild(card);
  });

  // Atualiza contadores topo
  document.getElementById('count-clientes').innerText = totalCidades;
  document.getElementById('count-contratos').innerText = totalContratos;
  document.getElementById('count-soja').innerText = formatNumber(totalSoja);
  document.getElementById('count-milho').innerText = formatNumber(totalMilho);
  document.getElementById('count-sorgo').innerText = formatNumber(totalSorgo);
  document.getElementById('count-total').innerText = formatNumber(totalSoja + totalMilho + totalSorgo);
}

/* ---------- MODAIS ---------- */
function openClientModal(group) {
  const body = document.getElementById('modalContentBody');
  let html = `<div class="modal-header"><h3>${escapeHtml(group.cliente)}</h3></div>`;
  html += `<div class="modal-body">`;
  html += `<p><strong>Cidade (ref):</strong> ${escapeHtml(group.cidadeRef)}</p>`;
  html += `<p><strong>Saldo total (kg):</strong> ${formatNumber(group.totalFalta)}</p>`;
  html += `<h4>Contratos</h4>`;
  html += `<div class="modal-clientes-list">`;
  group.contratos.forEach(c => {
    html += `<div class="contrato-item"><strong>Contrato:</strong> ${escapeHtml(c.contrato)} ‚Äî <strong>Produto:</strong> ${escapeHtml(c.produto)} ‚Äî <strong>Saldo:</strong> ${formatNumber(c.falta)}</div>`;
  });
  html += `</div></div>`;
  body.innerHTML = html;
  document.getElementById('resumoModal').style.display = 'flex';
}

function openCityModal(group) {
  const body = document.getElementById('modalContentBody');
  let html = `<div class="modal-header"><h3>${escapeHtml(group.cidade)}</h3></div>`;
  html += `<div class="modal-body">`;
  html += `<p><strong>Clientes:</strong> ${Array.from(group.clientes).join(', ')}</p>`;
  html += `<p><strong>Saldo total (kg):</strong> ${formatNumber(group.totalFalta)}</p>`;
  html += `<h4>Contratos</h4>`;
  html += `<div class="modal-clientes-list">`;
  group.contratos.forEach(c => {
    html += `<div class="contrato-item"><strong>Contrato:</strong> ${escapeHtml(c.contrato)} ‚Äî <strong>Cliente:</strong> ${escapeHtml(c.cliente)} ‚Äî <strong>Produto:</strong> ${escapeHtml(c.produto)} ‚Äî <strong>Saldo:</strong> ${formatNumber(c.falta)}</div>`;
  });
  html += `</div></div>`;
  body.innerHTML = html;
  document.getElementById('resumoModal').style.display = 'flex';
}

function closeModal() {
  document.getElementById('resumoModal').style.display = 'none';
}

/* ---------- VIEW / FILTER / TOGGLE ---------- */
function updateToggleButton() {
  const btn = document.getElementById('toggleViewBtn');
  if (!btn) return;
  if (currentView === 'cliente') {
    btn.innerHTML = '<i class="fas fa-sync-alt"></i> Mudar para Locais';
  } else {
    btn.innerHTML = '<i class="fas fa-sync-alt"></i> Mudar para Clientes';
  }
}
function toggleView() {
  currentView = (currentView === 'cliente') ? 'local' : 'cliente';
  localStorage.setItem('lotes_entregas_view', currentView);
  updateToggleButton();
  renderCurrentView();
}
function renderCurrentView() {
  const filter = document.getElementById('filterInput').value || '';
  if (currentView === 'cliente') {
    const clients = processData(globalData);
    renderClientCards(clients, filter);
  } else {
    const cities = processDataByCity(globalData);
    renderCityCards(cities, filter);
  }
}

/* ---------- FETCH / AUTO-UPDATE ---------- */
async function loadDataAndRender() {
  try {
    document.getElementById('lastUpdateTop').querySelector('span').innerText = 'Atualizando...';
    const parsed = await fetchSheetByGid(GID_ENTREGA);
    // parsed.arrays contains raw arrays
    globalData = parsed.arrays || [];
    renderCurrentView();
    document.getElementById('lastUpdateTop').querySelector('span').innerText = `√öltima atualiza√ß√£o: ${new Date().toLocaleString('pt-BR')}`;
  } catch (err) {
    console.error(err);
    document.getElementById('clientesContainer').innerHTML = `<div class="empty">Erro ao carregar dados: ${escapeHtml(err.message)}</div>`;
    document.getElementById('lastUpdateTop').querySelector('span').innerText = 'Erro na atualiza√ß√£o';
  }
}

// filtro dinamico
document.getElementById('filterInput').addEventListener('input', (e) => {
  renderCurrentView();
});

// modal fechar ao clicar no overlay
document.getElementById('resumoModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('resumoModal')) closeModal();
});

// inicializa√ß√£o
updateToggleButton();
loadDataAndRender();
setInterval(loadDataAndRender, AUTO_UPDATE_INTERVAL);

</script>
</body>
</html>
