<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controle de Lotes — Lotes de Entrega</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  :root{
    --primary:#2563eb; --accent:#0ea5e9; --bg:#f6fbff; --card:#fff; --text:#0f172a;
    --muted:#6b7280; --success:#10b981; --warning:#f59e0b;
    --status-carregado: #10b981;
    --status-embarque: #3b82f6;
    --status-transito: #ef4444;
    --status-contratar: #f97316;
    --produto-soja: #10b981;
    --produto-milho: #fbbf24;
    --produto-sorgo: #6b7280;
    --produto-total: #8b5cf6;
  }
  *{box-sizing:border-box}
  body{font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;margin:0;background:var(--bg);color:var(--text);padding:12px}
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('https://raw.githubusercontent.com/mvkpasta-prog/planilhas-lotes/main/mvklogo.png');
    background-repeat: no-repeat;
    background-position: center center;
    background-size: 80vh;
    opacity: 0.05;
    z-index: -1;
    pointer-events: none;
  }
  header{
    background:linear-gradient(90deg,var(--primary),var(--accent));
    color:white;
    padding:12px;
    border-radius:8px;
    margin-bottom:16px;
    text-align:center;
    font-weight:700;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    flex-wrap: wrap;
  }
  .header-title { display:flex; align-items:center; gap:8px; min-width:200px; }
  .last-update-top { font-size:12px; color:rgba(255,255,255,0.9); display:flex; align-items:center; gap:6px; }
  .wrap{max-width:1400px;margin:0 auto;width:100%}
  .header-btn { background:#fff; color:var(--primary); border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-weight:700; font-size:13px; text-decoration:none; transition:background .2s, opacity .2s; display:flex; align-items:center; gap:6px; }
  .header-btn:hover { background:var(--bg); opacity:.95; }

  /* novo layout dos status cards: grid com duas colunas; produtos ficam numa linha abaixo em 4 colunas */
  .status-cards {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .status-card{background:var(--card);border-radius:8px;padding:10px;box-shadow:0 3px 8px rgba(0,0,0,0.06);text-align:center;transition:all .3s; min-height:72px; display:flex; flex-direction:column; justify-content:center;}
  .status-card:hover{transform:translateY(-2px);box-shadow:0 5p...
  .status-card h3{margin:0 0 6px 0;font-size:14px;color:var(--text);font-weight:600}
  .status-card .count{font-size:22px;font-weight:700;margin:6px 0}

  /* area que ocupa a segunda linha com 4 cards de produto */
  .product-row {
    grid-column: 1 / -1; /* ocupa as 2 colunas da grid pai */
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
  }

  .clientes-section{margin-bottom:24px}
  .clientes-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-bottom:24px}
  .cliente-card{background:var(--card);border-radius:8px;padding:14px;box-shadow:0 3px 8px rgba(0,0,0,0.06);transition:all .3s; cursor:pointer;}
  .cliente-card:hover{transform:translateY(-2px);box-shadow:0 5px 12px rgba(0,0,0,0.08)}
  .cliente-name{font-weight:700;font-size:16px;color:var(--text);margin:0 0 6px 0}
  .cliente-destino{font-weight:600;color:var(--accent);margin:0 0 10px 0;font-size:13px} /* MANTIDO PARA LOTES POR CIDADE */
  .cliente-info{display:flex;justify-content:space-between;margin-bottom:6px;align-items:center}
  .info-label{font-weight:600;color:var(--muted);font-size:12px}
  .info-value{font-weight:700;font-size:13px}
  .cliente-produto{padding:3px 7px;border-radius:5px;font-size:11px;font-weight:600;display:inline-block;margin-top:4px}
  .status-pendente-tag{background-color: var(--status-embarque);color: white;padding: 2px 7px;border-radius: 10px;font-size: 11px;font-weight: 600;}
  .empty{color:var(--muted);font-style:italic;padding:10px;text-align:center;}
  
  /* ESTILOS PADRONIZADOS PARA FILTRO E NAVEGAÇÃO ENTRE VISTAS */
  .actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 12px;
  }
  #filterInput {flex-grow:1; min-width:200px; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px}


  .modal-overlay {position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.6); display:none; justify-content:center; align-items:center; z-index:1000}
  /* PADRONIZAÇÃO: max-width ajustado para ser mais compacto */
  .modal-content {background:var(--card); padding:20px; border-radius:8px; max-width:700px; width:95%; max-height:90vh; overflow-y:auto; position:relative;}
  .modal-close {position:absolute; top:10px; right:10px; background:none; border:none; font-size:22px; cursor:pointer; color:var(--muted)}
  .modal-header h3 {margin-top:0; font-size:18px; color:var(--primary); border-bottom:2px solid var(--accent); padding-bottom:8px; margin-bottom:15px;}
  .modal-body p {margin:5px 0; font-size:14px}
  
  /* ESTILOS PADRONIZADOS PARA DETALHES DENTRO DO MODAL (Como em Retiradas.html) */
  .modal-body .info-label {font-weight:600; color:var(--text); display:inline-block; min-width:180px;}
  .modal-body .info-value {font-weight:400; color:var(--muted);}
  .contrato-item {padding:8px 0; border-bottom:1px dashed #eee; margin-bottom:10px;}
  .contrato-item:last-child {border-bottom:none;}
  
  /* CLASSES ANTIGAS REMOVIDAS DO USO, MAS MANTIDAS NO CSS SE NECESSÁRIO EM OUTRAS PARTES: */
  .contracts-table {width:100%; border-collapse:collapse; margin-top:12px}
  .contracts-table th, .contracts-table td {padding:8px; border:1px solid #eee; font-size:13px; text-align:left}
  .contracts-table th {background:#fafafa; font-weight:700}
  
  .product-breakdown {display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
  .product-chip {padding:6px 10px; border-radius:999px; font-weight:700; font-size:13px; color:#fff; display:inline-block}
  @media (max-width:1100px){ .product-row { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width:700px){
    .status-cards { grid-template-columns: 1fr; }
    .product-row { grid-template-columns: repeat(2,1fr); }
  }
  @media (max-width:480px){ .product-row { grid-template-columns: 1fr; } }
  @media (max-width:600px){
    body{padding:8px}
    .cliente-card{min-width:100%; padding:12px}
    header {flex-direction:column; align-items:flex-start; gap:10px}
    .header-btn {width:100%; justify-content:center; order:2}
    .header-title {width:100%; justify-content:space-between}
    .last-update-top {order:3}
    /* Ajuste para mobile na área de filtro/view-toggle */
    .actions {flex-direction: column; align-items: stretch;}
    #filterInput {min-width: 100%;}
    .view-toggle {width: 100%; justify-content: space-around;}
    .view-toggle button {flex: 1;}
  } 
  
  /* estilos para o modal de cidade */
  .city-modal-overlay {position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.6); display:none; justify-content:center; align-items:center; z-index:1000}
  .city-modal-content {background:var(--card); padding:20px; border-radius:8px; max-width:800px; width:95%; max-height:90vh; overflow-y:auto; position:relative;}
  .city-modal-close {position:absolute; top:10px; right:10px; background:none; border:none; font-size:22px; cursor:pointer; color:var(--muted)}
  .city-modal-header h3 {margin-top:0; font-size:18px; color:var(--primary); border-bottom:2px solid var(--accent); padding-bottom:8px; margin-bottom:15px;}
  .city-client-list{margin-top:15px}
  .city-client-card{background:#f8faff;border:1px solid #e0e7ff;border-radius:6px;padding:12px;margin-bottom:10px;cursor:pointer;transition:background .2s}
  .city-client-card:hover{background:#edf2ff}
  .city-client-name{font-weight:700;font-size:15px;color:var(--text);margin:0 0 5px 0}
  .city-client-info{display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px}
  .city-client-info-label{font-weight:600;color:var(--muted)}
  .city-client-info-value{font-weight:700}
  .city-product-list{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;padding-top:6px;border-top:1px dashed #ddd}
  .city-product-chip{padding:3px 7px;border-radius:5px;font-size:11px;font-weight:600;display:inline-block;}
</style>
</head>
<body>
  <header>
    <div class="header-title">
      <img src="https://raw.githubusercontent.com/mvkpasta-prog/planilhas-lotes/main/mvklogo.png" alt="Logo MVK" style="height: 22px; vertical-align: middle; margin-right: 8px;">
      Controle de Lotes — Lotes de Entrega
    </div>
    <a href="index.html" class="header-btn" title="Voltar para o Resumo de Entregas">
      <i class="fas fa-arrow-left"></i> Voltar p/ Resumo
    </a>
    <div class="last-update-top" id="lastUpdateTop">
      <i class="fas fa-hourglass-half"></i> <span>Atualizando...</span>
    </div>
  </header>
  <div class="wrap">
    
    <div class="status-cards">
      </div>

    <div class="product-row">
      </div>
    
    <div class="clientes-section">
      <div class="actions">
          <input type="text" id="filterInput" placeholder="Filtrar por nome, cidade, status..." title="Filtrar lotes">
          <div class="view-toggle" id="viewToggle" style="display:flex;gap:8px;">
              <button id="viewClienteBtn" class="header-btn" style="padding:10px 14px;background:var(--primary);color:white;min-width:150px">Lotes por Cliente</button>
              <button id="viewCityBtn" class="header-btn" style="padding:10px 14px;background:#eee;color:var(--text);min-width:150px">Lotes por Cidade</button>
          </div>
      </div>
      <div class="clientes-container" id="clientesContainer">
        </div>
      <div class="empty" id="emptyMessage" style="display:none;">Nenhum lote encontrado.</div>
    </div>

    <div class="modal-overlay" id="resumoModal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">×</button>
        <div class="modal-header">
          <h3 id="modalTitle">Detalhes do Lote</h3>
        </div>
        <div class="modal-body" id="modalBody">
          </div>
      </div>
    </div>

    <div class="city-modal-overlay" id="cityModal">
      <div class="city-modal-content">
        <button class="city-modal-close" onclick="closeCityModal()">×</button>
        <div class="city-modal-header">
          <h3 id="cityModalTitle">Lotes na Cidade</h3>
        </div>
        <div class="city-client-list" id="cityModalBody">
          </div>
      </div>
    </div>
    
  </div>
<script>
/* ====== CONFIG - coloque aqui seu SHEET_ID se mudar ====== */
const SHEET_ID = '1o0wF2ScSkyxqY8FHFI-rA6k_3uMI2wsZr2wQG8JD4B4'; 
const GID_ENTREGA = '1186247985'; 

// Configuração do intervalo de atualização automática (em milissegundos)
const AUTO_UPDATE_INTERVAL = 300000; 

/* colunas que ficam ocultas em exibição (aparecem em detalhes) - normalizadas */
const HIDDEN_COLS = ['nfp','royalties','safra']; 
/* colunas removidas (normalizadas) de todas as tabelas */
const REMOVED_COMMON = ['localizacao','idorigemymvk1']; 

let globalData = [];
let currentView = 'cliente'; // Estado inicial
const clientContainer = document.getElementById('clientesContainer');
const emptyMessage = document.getElementById('emptyMessage');

/* Normaliza cabeçalho: remove acento, espaços e pontuação */
function normalizeHeader(h){
    if(h === undefined || h === null) return '';
    return h.toLowerCase().replace(/[^a-z0-9]/g, '');
}

/* Formatação de número para KG */
function formatNumber(num) {
    if (typeof num === 'string') {
        num = parseFloat(num.replace(/\./g, '').replace(',', '.'));
    }
    if (isNaN(num)) return '0';
    return num.toLocaleString('pt-BR', { maximumFractionDigits: 2 });
}

/* Escapar HTML para evitar XSS */
function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    return str.toString().replace(/[&<>"']/g, function(m) {
        return ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        })[m];
    });
}

/* Processa os dados para agrupar por Cliente (Vista Padrão) */
function processData(data) {
    const clients = new Map();
    const headers = data[0];
    const normalizedHeaders = headers.map(normalizeHeader);

    for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const item = {};

        normalizedHeaders.forEach((key, index) => {
            item[key] = row[index];
        });
        
        const clientName = item.nome;
        const key = clientName; 

        if (!clients.has(key)) {
            clients.set(key, { 
                nome: clientName, 
                destino: item.destino,
                produto: item.produto,
                status: item.status,
                peso: 0,
                caminhoes: 0,
                data: [] 
            });
        }
        
        const client = clients.get(key);
        // Soma peso e caminhões
        client.peso += parseFloat(item.peso || 0);
        client.caminhoes += parseInt(item.caminhoes || 0);
        
        // Adiciona todos os dados da linha como um "contrato"
        client.data.push(item);
    }
    
    return Array.from(clients.values());
}

/* Processa os dados para agrupar por Cidade (Vista Alternativa) */
function processDataByCity(data) {
    const cities = new Map();
    const headers = data[0];
    const normalizedHeaders = headers.map(normalizeHeader);

    for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const item = {};

        normalizedHeaders.forEach((key, index) => {
            item[key] = row[index];
        });

        const cityName = item.destino;
        const key = cityName;

        if (!cities.has(key)) {
            cities.set(key, { 
                nome: cityName, 
                peso: 0,
                caminhoes: 0,
                data: [] 
            });
        }

        const city = cities.get(key);
        city.peso += parseFloat(item.peso || 0);
        city.caminhoes += parseInt(item.caminhoes || 0);
        city.data.push(item);
    }

    return Array.from(cities.values());
}

/* Renderiza os cards agrupados por Cliente */
function renderClientCards(clients, filter) {
    let cardsHtml = '';
    const filteredClients = clients.filter(client => {
        if (!filter) return true;
        const searchTerm = filter.toLowerCase();
        return client.nome.toLowerCase().includes(searchTerm) || 
               client.destino.toLowerCase().includes(searchTerm) ||
               client.data.some(item => item.status && item.status.toLowerCase().includes(searchTerm));
    });

    if (filteredClients.length === 0) {
        clientContainer.innerHTML = '';
        emptyMessage.style.display = 'block';
        return;
    }

    filteredClients.forEach(client => {
        // Encontrar o status mais crítico para exibição no card
        const statusMap = { 'CONTRATAR': 4, 'EM TRÂNSITO': 3, 'NO EMBARQUE': 2, 'CARREGADO': 1 };
        let mostCriticalStatus = 'CARREGADO'; 
        let criticalLevel = 0;

        client.data.forEach(item => {
            const currentLevel = statusMap[item.status] || 0;
            if (currentLevel > criticalLevel) {
                criticalLevel = currentLevel;
                mostCriticalStatus = item.status;
            }
        });

        const statusTagClass = `status-${normalizeHeader(mostCriticalStatus)}`;

        // REMOÇÃO DA CIDADE/DESTINO DO CARD, CONFORME SOLICITADO
        const cardHtml = `
            <div class="cliente-card" onclick="openModal('${escapeHtml(client.nome)}', '${escapeHtml(client.destino)}', ${escapeHtml(JSON.stringify(client.data))})">
                <h4 class="cliente-name">${escapeHtml(client.nome)}</h4>
                <div class="cliente-info">
                    <span class="info-label">Contratos Abertos</span>
                    <span class="info-value">${client.data.length}</span>
                </div>
                <div class="cliente-info">
                    <span class="info-label">Peso Total</span>
                    <span class="info-value">${formatNumber(client.peso)} KG</span>
                </div>
                <div class="cliente-info">
                    <span class="info-label">Caminhões</span>
                    <span class="info-value">${client.caminhoes}</span>
                </div>
                <div style="margin-top:10px; text-align:right;">
                    <span class="status-pendente-tag ${statusTagClass}">${escapeHtml(mostCriticalStatus)}</span>
                </div>
            </div>
        `;
        cardsHtml += cardHtml;
    });

    clientContainer.innerHTML = cardsHtml;
    emptyMessage.style.display = 'none';
}

/* Renderiza os cards agrupados por Cidade */
function renderCityCards(cities, filter) {
    let cardsHtml = '';
    const filteredCities = cities.filter(city => {
        if (!filter) return true;
        const searchTerm = filter.toLowerCase();
        return city.nome.toLowerCase().includes(searchTerm) ||
               city.data.some(item => item.produto && item.produto.toLowerCase().includes(searchTerm)) ||
               city.data.some(item => item.status && item.status.toLowerCase().includes(searchTerm));
    });

    if (filteredCities.length === 0) {
        clientContainer.innerHTML = '';
        emptyMessage.style.display = 'block';
        return;
    }

    filteredCities.forEach(city => {
        // Contagem de produtos para exibição
        const productCounts = city.data.reduce((acc, item) => {
            const produto = normalizeHeader(item.produto);
            acc[produto] = (acc[produto] || 0) + 1;
            return acc;
        }, {});

        const productChipsHtml = Object.keys(productCounts).map(prod => {
            const colorClass = `produto-${prod}`;
            return `<span class="city-product-chip ${colorClass}" style="color:white;">${productCounts[prod]}x ${prod.toUpperCase()}</span>`;
        }).join('');
        
        const cardHtml = `
            <div class="cliente-card" onclick="openCityModal('${escapeHtml(city.nome)}', ${escapeHtml(JSON.stringify(city.data))})">
                <h4 class="cliente-name">📍 ${escapeHtml(city.nome)}</h4>
                <div class="cliente-info">
                    <span class="info-label">Lotes Abertos</span>
                    <span class="info-value">${city.data.length}</span>
                </div>
                <div class="cliente-info">
                    <span class="info-label">Peso Total</span>
                    <span class="info-value">${formatNumber(city.peso)} KG</span>
                </div>
                <div class="cliente-info">
                    <span class="info-label">Caminhões</span>
                    <span class="info-value">${city.caminhoes}</span>
                </div>
                <div class="city-product-list" style="margin-top:10px; padding-top:10px; border-top:1px solid #eee;">
                    ${productChipsHtml}
                </div>
            </div>
        `;
        cardsHtml += cardHtml;
    });

    clientContainer.innerHTML = cardsHtml;
    emptyMessage.style.display = 'none';
}


/* FUNÇÕES DO MODAL/POPUP DE DETALHES - PADRONIZADA COM RETIRADAS */
function openModal(clientName, clientDestino, clientDataJson) {
    const clientData = JSON.parse(clientDataJson);
    
    document.getElementById('modalTitle').textContent = clientName;
    
    let modalBodyHtml = `
        <div class="contrato-item">
            <h4 style="margin:5px 0;font-size:14px;color:var(--accent);">Informações Principais</h4>
            <p><span class="info-label">📍 Cidade / Destino:</span> <span class="info-value">${escapeHtml(clientDestino)}</span></p>
            <p><span class="info-label">⚖️ Peso Total:</span> <span class="info-value">${formatNumber(clientData.reduce((sum, item) => sum + parseFloat(item.peso || 0), 0))} KG</span></p>
            <p><span class="info-label">🚚 Caminhões:</span> <span class="info-value">${clientData.reduce((sum, item) => sum + parseInt(item.caminhoes || 0), 0)}</span></p>
        </div>
    `;

    // Loop para exibir cada contrato como item de lista (PADRONIZAÇÃO)
    clientData.forEach((item, index) => {
        const statusClass = `status-${normalizeHeader(item.status)}`;
        modalBodyHtml += `
            <div class="contrato-item">
                <h4 style="margin:10px 0 5px 0;font-size:14px;color:var(--primary);">Contrato ${item.contrato}</h4>
                <p><span class="info-label">📦 Produto:</span> <span class="info-value">${escapeHtml(item.produto)}</span></p>
                <p><span class="info-label">⚖️ Peso do Contrato:</span> <span class="info-value">${formatNumber(item.peso)} KG</span></p>
                <p><span class="info-label">🚚 Caminhões:</span> <span class="info-value">${item.caminhoes}</span></p>
                <p><span class="info-label">🟢 Status:</span> <span class="info-value"><span class="status-programacao ${statusClass}">${escapeHtml(item.status)}</span></span></p>
                
                <h5 style="margin:10px 0 5px 0;font-size:13px;color:var(--muted);border-top:1px dashed #eee;padding-top:5px;">Detalhes Adicionais</h5>
                ${item.datadecarga ? `<p><span class="info-label">🗓 Data Carga:</span> <span class="info-value">${item.datadecarga}</span></p>` : ''}
                ${item.datanf ? `<p><span class="info-label">📅 Data NF:</span> <span class="info-value">${item.datanf}</span></p>` : ''}
                ${item.dacte ? `<p><span class="info-label">📄 DACTE:</span> <span class="info-value">${escapeHtml(item.dacte)}</span></p>` : ''}
                ${item.notafiscal ? `<p><span class="info-label"># Nota Fiscal:</span> <span class="info-value">${escapeHtml(item.notafiscal)}</span></p>` : ''}
                ${item.observacoes ? `<p><span class="info-label">💬 Observações:</span> <span class="info-value">${escapeHtml(item.observacoes)}</span></p>` : ''}
            </div>
        `;
    });
    
    document.getElementById('modalBody').innerHTML = modalBodyHtml;
    document.getElementById('resumoModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('resumoModal').style.display = 'none';
    document.getElementById('modalBody').innerHTML = ''; // Limpa o conteúdo
}

function openCityModal(cityName, cityDataJson) {
    const cityData = JSON.parse(cityDataJson);
    document.getElementById('cityModalTitle').textContent = `Lotes em ${cityName}`;
    
    // ... (city modal content generation logic, maintained from original)
    let bodyHtml = '';
    
    // Agrupar os lotes por cliente dentro da cidade
    const clientsInCity = cityData.reduce((acc, item) => {
        const clientName = item.nome;
        if (!acc[clientName]) {
            acc[clientName] = { 
                nome: clientName, 
                pesoTotal: 0,
                caminhoesTotal: 0,
                lotes: [] 
            };
        }
        acc[clientName].pesoTotal += parseFloat(item.peso || 0);
        acc[clientName].caminhoesTotal += parseInt(item.caminhoes || 0);
        acc[clientName].lotes.push(item);
        return acc;
    }, {});
    
    const sortedClients = Object.values(clientsInCity).sort((a, b) => a.nome.localeCompare(b.nome));

    sortedClients.forEach(client => {
        const lotesHtml = client.lotes.map(lote => {
             const statusClass = `status-${normalizeHeader(lote.status)}`;
             return `<div style="padding:4px 0;border-bottom:1px dashed #f0f0f0;">
                        <div class="city-client-info">
                            <span class="city-client-info-label">${escapeHtml(lote.produto)} (${lote.contrato})</span>
                            <span class="city-client-info-value">${formatNumber(lote.peso)} KG</span>
                        </div>
                        <div class="city-client-info">
                            <span class="city-client-info-label">Status:</span>
                            <span class="city-client-info-value"><span class="status-programacao ${statusClass}">${escapeHtml(lote.status)}</span></span>
                        </div>
                     </div>`;
        }).join('');
        
        bodyHtml += `
            <div class="city-client-card" onclick="openModal('${escapeHtml(client.nome)}', '${escapeHtml(cityName)}', ${escapeHtml(JSON.stringify(client.lotes))})">
                <h4 class="city-client-name">${escapeHtml(client.nome)}</h4>
                <div class="city-client-info" style="font-weight:700;">
                    <span class="city-client-info-label">Total Lotes: ${client.lotes.length}</span>
                    <span class="city-client-info-value">Total Peso: ${formatNumber(client.pesoTotal)} KG</span>
                </div>
                <div style="margin-top:10px;padding-top:10px;border-top:1px solid #ddd;">
                    ${lotesHtml}
                </div>
            </div>
        `;
    });
    
    document.getElementById('cityModalBody').innerHTML = bodyHtml;
    document.getElementById('cityModal').style.display = 'flex';
}

function closeCityModal() {
    document.getElementById('cityModal').style.display = 'none';
    document.getElementById('cityModalBody').innerHTML = '';
}
/* FUNÇÕES FINAIS */

function renderCurrentView() {
  const filter = document.getElementById('filterInput').value;
  document.getElementById('viewClienteBtn').style.background = currentView === 'cliente' ? 'var(--primary)' : '#eee';
  document.getElementById('viewClienteBtn').style.color = currentView === 'cliente' ? 'white' : 'var(--text)';
  document.getElementById('viewCityBtn').style.background = currentView === 'city' ? 'var(--primary)' : '#eee';
  document.getElementById('viewCityBtn').style.color = currentView === 'city' ? 'white' : 'var(--text)';
  
  if (globalData.length === 0) {
      clientContainer.innerHTML = '';
      emptyMessage.style.display = 'block';
      return;
  }
  
  if (currentView === 'cliente') {
    const clients = processData(globalData);
    renderClientCards(clients, filter);
  } else {
    const cities = processDataByCity(globalData);
    renderCityCards(cities, filter);
  }
}

function updateView(view) {
    if (view !== currentView) {
        currentView = view;
        renderCurrentView();
    }
}


/* ---------- FETCH / AUTO-UPDATE ---------- */
async function fetchSheetByGid(gid) {
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${gid}`;
    const response = await fetch(url);
    if (!response.ok) {
        throw new Error(`Erro de rede: ${response.statusText}`);
    }
    const text = await response.text();
    // Extrai o JSON da resposta do Google Sheets
    const jsonString = text.match(/google.visualization.Query.setResponse\(([\s\S]*)\);/)[1];
    const json = JSON.parse(jsonString);
    
    if (json.errors) {
        throw new Error(`Erro na query: ${json.errors[0].message}`);
    }

    const table = json.table;
    const headers = table.cols.map(col => col.label);
    const arrays = [headers];
    
    table.rows.forEach(row => {
        const rowData = row.c.map(cell => cell ? (cell.v !== undefined ? cell.v : cell.f) : '');
        arrays.push(rowData);
    });

    return { arrays: arrays };
}

async function loadDataAndRender() {
  try {
    document.getElementById('lastUpdateTop').querySelector('span').innerText = 'Atualizando...';
    const parsed = await fetchSheetByGid(GID_ENTREGA);
    // parsed.arrays contains raw arrays
    globalData = parsed.arrays || [];
    renderCurrentView();
    document.getElementById('lastUpdateTop').querySelector('span').innerText = `Última atualização: ${new Date().toLocaleString('pt-BR')}`;
  } catch (err) {
    console.error(err);
    document.getElementById('clientesContainer').innerHTML = `<div class="empty">Erro ao carregar dados: ${escapeHtml(err.message)}</div>`;
    document.getElementById('lastUpdateTop').querySelector('span').innerText = 'Erro na atualização';
  }
}

/* LISTENERS */
document.getElementById('filterInput').addEventListener('input', (e) => {
  renderCurrentView();
});

document.getElementById('viewClienteBtn').addEventListener('click', () => updateView('cliente'));
document.getElementById('viewCityBtn').addEventListener('click', () => updateView('city'));

// modal fechar ao clicar no overlay
document.getElementById('resumoModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('resumoModal')) closeModal();
});
document.getElementById('cityModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('cityModal')) closeCityModal();
});

// inicial
document.addEventListener('DOMContentLoaded', function() {
  loadDataAndRender();
  setInterval(loadDataAndRender, AUTO_UPDATE_INTERVAL);
});

</script>
</body>
</html>
