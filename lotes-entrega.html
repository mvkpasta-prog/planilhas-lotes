<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controle de Lotes â€” Lotes de Entrega</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
Â  :root{
Â  Â  --primary:#2563eb; --accent:#0ea5e9; --bg:#f6fbff; --card:#fff; --text:#0f172a;
Â  Â  --muted:#6b7280; --success:#10b981; --warning:#f59e0b;
Â  Â  --status-carregado: #10b981; /* Verde */
Â  Â  --status-embarque: #3b82f6; /* Azul */
Â  Â  --status-transito: #ef4444; /* Vermelho */
Â  Â  --status-contratar: #f97316; /* Laranja */
Â  Â  --produto-soja: #10b981; /* Verde para Soja */
Â  Â  --produto-milho: #fbbf24; /* Amarelo para Milho */
Â  Â  --produto-sorgo: #6b7280; /* Cinza para Sorgo */
Â  Â  --produto-total: #8b5cf6; /* Roxo para Total */
Â  }
Â  *{box-sizing:border-box}
Â  body{font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;margin:0;background:var(--bg);color:var(--text);padding:12px}
Â  body::before {
Â  Â  content: '';
Â  Â  position: fixed;
Â  Â  top: 0;
Â  Â  left: 0;
Â  Â  width: 100%;
Â  Â  height: 100%;
Â  Â  background-image: url('https://raw.githubusercontent.com/mvkpasta-prog/planilhas-lotes/main/mvklogo.png');
Â  Â  background-repeat: no-repeat;
Â  Â  background-position: center center;
Â  Â  background-size: 80vh;
Â  Â  opacity: 0.05;
Â  Â  z-index: -1;
Â  Â  pointer-events: none;
Â  }
Â  header{
Â  Â  background:linear-gradient(90deg,var(--primary),var(--accent));
Â  Â  color:white;
Â  Â  padding:12px;
Â  Â  border-radius:8px;
Â  Â  margin-bottom:16px;
Â  Â  text-align:center;
Â  Â  font-weight:700;
Â  Â  display:flex;
Â  Â  align-items:center;
Â  Â  justify-content:space-between;
Â  Â  gap:8px;
Â  Â  flex-wrap: wrap;
Â  }
Â  .header-title {
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  gap: 8px;
Â  Â  min-width: 200px;
Â  }
Â  .last-update-top {
Â  Â  font-size: 12px;
Â  Â  color: rgba(255,255,255,0.9);
Â  Â  display: flex;
Â  Â  align-items:center;
Â  Â  gap: 6px;
Â  }
Â  .wrap{max-width:1400px;margin:0 auto;width:100%}
Â  .header-btn {
Â  Â  background: #fff;
Â  Â  color: var(--primary);
Â  Â  border: none;
Â  Â  padding: 6px 10px;
Â  Â  border-radius: 6px;
Â  Â  cursor: pointer;
Â  Â  font-weight: 700;
Â  Â  font-size: 13px;
Â  Â  text-decoration: none;
Â  Â  transition: background 0.2s ease, opacity 0.2s ease;
Â  Â  white-space: nowrap;
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  gap: 6px;
Â  }
Â  .header-btn:hover {
Â  Â  background: var(--bg);
Â  Â  opacity: 0.95;
Â  }
Â  .status-cards{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px}
Â  .status-card{background:var(--card);border-radius:8px;padding:10px;box-shadow:0 3px 8px rgba(0,0,0,0.06);flex:1;min-width:150px;text-align:center;transition:all 0.3s ease}
Â  .status-card:hover{transform:translateY(-2px);box-shadow:0 5px 12px rgba(0,0,0,0.08)}
Â  .status-card h3{margin:0 0 6px 0;font-size:14px;color:var(--text);font-weight:600}
Â  .status-card .count{font-size:22px;font-weight:700;margin:6px 0}
Â  .clientes-section{margin-bottom:24px}
Â  .clientes-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-bottom:24px}
Â  .cliente-card{background:var(--card);border-radius:8px;padding:14px;box-shadow:0 3px 8px rgba(0,0,0,0.06);transition:all 0.3s ease; cursor: pointer;}
Â  .cliente-card:hover{transform:translateY(-2px);box-shadow:0 5px 12px rgba(0,0,0,0.08)}
Â  .cliente-name{font-weight:700;font-size:16px;color:var(--text);margin:0 0 6px 0}
Â  .cliente-destino{font-weight:600;color:var(--accent);margin:0 0 10px 0;font-size:13px}
Â  .cliente-info{display:flex;justify-content:space-between;margin-bottom:6px;align-items:center}
Â  .info-label{font-weight:600;color:var(--muted);font-size:12px}
Â  .info-value{font-weight:700;font-size:13px}
Â  .cliente-produto{padding:3px 7px;border-radius:5px;font-size:11px;font-weight:600;display:inline-block;margin-top:4px}
Â  .status-pendente-tag{background-color: var(--status-embarque);color: white;padding: 2px 7px;border-radius: 10px;font-size: 11px;font-weight: 600;}
Â  .empty{color:var(--muted);font-style:italic;padding:10px;text-align:center;}
Â  #filterInput {
Â  Â  flex-grow: 1;
Â  Â  min-width: 200px;
Â  Â  padding: 10px;
Â  Â  border: 1px solid #ccc;
Â  Â  border-radius: 6px;
Â  Â  font-size: 14px;
Â  }
Â  .modal-overlay {
Â  Â  position: fixed;
Â  Â  top: 0;
Â  Â  left: 0;
Â  Â  width: 100%;
Â  Â  height: 100%;
Â  Â  background: rgba(0,0,0,0.6);
Â  Â  display: none;
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  z-index: 1000;
Â  }
Â  .modal-content {
Â  Â  background: var(--card);
Â  Â  padding: 20px;
Â  Â  border-radius: 8px;
Â  Â  max-width: 600px;
Â  Â  width: 90%;
Â  Â  max-height: 90vh;
Â  Â  overflow-y: auto;
Â  }
Â  .modal-close {
Â  Â  position: absolute;
Â  Â  top: 10px;
Â  Â  right: 10px;
Â  Â  background: none;
Â  Â  border: none;
Â  Â  font-size: 22px;
Â  Â  cursor: pointer;
Â  Â  color: var(--muted);
Â  }
Â  .modal-header h3 {
Â  Â  margin-top: 0;
Â  Â  font-size: 18px;
Â  Â  color: var(--primary);
Â  Â  border-bottom: 2px solid var(--accent);
Â  Â  padding-bottom: 8px;
Â  Â  margin-bottom: 15px;
Â  }
Â  .modal-body p {
Â  Â  margin: 5px 0;
Â  Â  font-size: 14px;
Â  }
Â  .modal-body .info-label {
Â  Â  font-weight: 600;
Â  Â  color: var(--text);
Â  Â  display: inline-block;
Â  Â  min-width: 160px;
Â  }
Â  .modal-body .info-value {
Â  Â  font-weight: 400;
Â  Â  color: var(--muted);
Â  }
Â  .contrato-item {
Â  Â  padding: 8px 0;
Â  Â  border-bottom: 1px dashed #eee;
Â  }
Â  .contrato-item:last-child {
Â  Â  border-bottom: none;
Â  }
Â  @media (max-width:600px){
Â  Â  body{padding:8px}
Â  Â  .cliente-card{min-width:100%;padding:12px}
Â  Â  header {
Â  Â  Â  flex-direction: column;
Â  Â  Â  align-items: flex-start;
Â  Â  Â  gap: 10px;
Â  Â  }
Â  Â  .header-btn {
Â  Â  Â  width: 100%;
Â  Â  Â  justify-content: center;
Â  Â  Â  order: 2;
Â  Â  }
Â  Â  .header-title {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  justify-content: space-between;
Â  Â  }
Â  Â  .last-update-top {
Â  Â  Â  Â  order: 3;
Â  Â  }
Â  }
</style>
</head>
<body>
Â  <header>
Â  Â  <div class="header-title">
Â  Â  Â  <img src="https://raw.githubusercontent.com/mvkpasta-prog/planilhas-lotes/main/mvklogo.png" alt="Logo MVK" style="height: 22px; vertical-align: middle; margin-right: 8px;">
Â  Â  Â  Controle de Lotes â€” Lotes de Entrega
Â  Â  </div>
Â  Â  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
Â  Â  Â  <a href="index.html" class="header-btn" title="Voltar para a pÃ¡gina principal">
Â  Â  Â  Â  <i class="fas fa-home"></i> PÃ¡gina Inicial
Â  Â  Â  </a>
Â  Â  Â  <a href="Retiradas.html" class="header-btn" title="Acessar Lotes de Retirada">
Â  Â  Â  Â  <i class="fas fa-box"></i> Lotes de Retirada
Â  Â  Â  </a>
Â  Â  </div>
Â  Â  <div class="last-update-top" id="lastUpdateTop">
Â  Â  Â  <i class="fas fa-hourglass-half"></i> <span>Atualizando...</span>
Â  Â  </div>
Â  </header>
Â  <div class="wrap">
Â  Â  <div class="status-cards">
Â  Â  Â  <div class="status-card">
Â  Â  Â  Â  <h3>CLIENTES</h3>
Â  Â  Â  Â  <div class="count" id="count-clientes">0</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="status-card">
Â  Â  Â  Â  <h3>CONTRATOS</h3>
Â  Â  Â  Â  <div class="count" id="count-contratos">0</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="status-card produto-soja">
Â  Â  Â  Â  <h3>SOJA (KG)</h3>
Â  Â  Â  Â  <div class="count" id="count-soja">0</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="status-card produto-milho">
Â  Â  Â  Â  <h3>MILHO (KG)</h3>
Â  Â  Â  Â  <div class="count" id="count-milho">0</div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="clientes-section">
Â  Â  Â  <h2 style="margin-top: 0;">ğŸ“ Lotes com Saldo a Entregar</h2>
Â  Â  Â  <div style="display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap;">
Â  Â  Â  Â  <input type="text" id="filterInput" placeholder="Filtrar por Cliente, Contrato ou Cidade...">
Â  Â  Â  </div>
Â  Â  Â  <div class="clientes-container" id="clientesContainer">
Â  Â  Â  Â  <div class="empty">Carregando...</div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div id="resumoModal" class="modal-overlay">
Â  Â  <div class="modal-content">
Â  Â  Â  <button class="modal-close" onclick="closeModal()">&times;</button>
Â  Â  Â  <div id="modalContentBody"></div>
Â  Â  </div>
Â  </div>

<script>
const SHEET_ID = '1o0wF2ScSkyxqY8FHFI-rA6k_3uMI2wsZr2wQG8JD4B4';
const GID_ENTREGA = '1186247985'; // GID da aba "LOTES DE ENTREGA"
const AUTO_UPDATE_INTERVAL = 300000;

let globalData = [];

// --- UTILS ---
function normalizeHeader(h) {
Â  if (h === undefined || h === null) return '';
Â  return String(h).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]/g, '');
}
function normalizeText(text) {
Â  if (text === undefined || text === null) return '';
Â  return String(text).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
}
function parseCSV(text) {
Â  if (!text) return { arrays: [], headersOrig: [], headersNorm: [], objects: [] };
Â  // O Google Sheets CSV exporta as cÃ©lulas com aspas se contiverem vÃ­rgulas (CSV)
Â  // ou quebras de linha. O split com regex lida com isso.
Â  const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
Â  if (lines.length === 0) return { arrays: [], headersOrig: [], headersNorm: [], objects: [] };

Â  // FunÃ§Ã£o para dividir linhas CSV, respeitando aspas
Â  const parseLine = (line) => {
Â  Â  const cells = [];
Â  Â  let inQuote = false;
Â  Â  let currentCell = '';
Â  Â  for (let i = 0; i < line.length; i++) {
Â  Â  Â  const char = line[i];
Â  Â  Â  if (char === '"') {
Â  Â  Â  Â  // Trata aspas duplas dentro de aspas (escaped quote)
Â  Â  Â  Â  if (inQuote && line[i + 1] === '"') {
Â  Â  Â  Â  Â  currentCell += '"';
Â  Â  Â  Â  Â  i++;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  inQuote = !inQuote;
Â  Â  Â  Â  }
Â  Â  Â  } else if (char === ',' && !inQuote) {
Â  Â  Â  Â  cells.push(currentCell.trim());
Â  Â  Â  Â  currentCell = '';
Â  Â  Â  } else {
Â  Â  Â  Â  currentCell += char;
Â  Â  Â  }
Â  Â  }
Â  Â  cells.push(currentCell.trim()); // Adiciona a Ãºltima cÃ©lula
Â  Â  return cells;
Â  };

Â  // Mapeia as linhas para um array de cÃ©lulas
Â  const parsed = lines.map(parseLine);
Â  
Â  const headersOrig = parsed.shift().map(h => h || '');
Â  const headersNorm = headersOrig.map(h => normalizeHeader(h));
Â  
Â  // Note: O 'objects' nÃ£o Ã© usado no cÃ³digo atual, mantendo apenas para compatibilidade
Â  const objects = parsed.map(cells => {
Â  Â  const obj = {};
Â  Â  headersNorm.forEach((key, idx) => {
Â  Â  Â  obj[key] = cells[idx] !== undefined ? cells[idx] : '';
Â  Â  });
Â  Â  return obj;
Â  });

Â  return { arrays: parsed, headersOrig, headersNorm, objects };
}
async function fetchSheetByGid(gid) {
Â  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}`;
Â  const r = await fetch(url);
Â  if (!r.ok) throw new Error('Erro ao buscar planilha: ' + r.status);
Â  const text = await r.text();
Â  return parseCSV(text);
}
function parseNumber(val) {
Â  if (val === undefined || val === null) return 0;
Â  const s = String(val).replace(/\s/g, '').replace(/\./g, '').replace(/,/g, '.');
Â  return parseFloat(s.replace(/[^\d\.\-]/g, '')) || 0;
}
function formatNumber(value) {
Â  if (isNaN(value)) return '0';
Â  return new Intl.NumberFormat('pt-BR').format(Math.round(value));
}
function escapeHtml(s) {
Â  if (s === undefined || s === null) return '';
Â  return String(s).replace(/[&<>"'\/]/g, c => ({
Â  Â  '&': '&amp;',
Â  Â  '<': '&lt;',
Â  Â  '>': '&gt;',
Â  Â  '"': '&quot;',
Â  Â  "'": '&#x27;',
Â  Â  '/': '&#x2F;'
Â  }[c]));
}

// --- PROCESSAMENTO DOS DADOS ---
function processData(rowsArr) {
Â  const grupos = {};

Â  // rowsArr agora contÃ©m apenas as linhas de dados, a partir do Ã­ndice 0.
Â  for (let i = 0; i < rowsArr.length; i++) {
Â  Â  const row = rowsArr[i];
Â  Â  // A planilha pode ter colunas A, B, C... mas a planilha CSV comeÃ§a no Ã­ndice 0
Â  Â  // Coluna B = 0
Â  Â  // Coluna C = 1
Â  Â  // Coluna D = 2
Â  Â  // Coluna E = 3
Â  Â  // Coluna F = 4
Â  Â  // Coluna G = 5
Â  Â  // Coluna H = 6
Â  Â  // Coluna I = 7

Â  Â  if (!row || row.length < 8) continue; // Necessita de pelo menos 8 colunas (A-I)

Â  Â  const contrato = (row[0] || '').trim(); // Coluna B
Â  Â  const cliente = (row[1] || '').trim(); // Coluna C
Â  Â  const cidadeCompleta = row[2] || '';Â  Â // Coluna D
Â  Â  const produto = (row[3] || '').trim(); // Coluna E
Â  Â  const safra = (row[4] || '').trim();Â  Â // Coluna F
Â  Â  const volume = parseNumber(row[5]); // Coluna G
Â  Â  const embarcado = parseNumber(row[6]); // Coluna H
Â  Â  const falta = parseNumber(row[7]);Â  Â  Â // Coluna I

Â  Â  // âœ… LÃ³gica: SÃ“ CONSIDERA SE FALTA > 0 E CLIENTE NÃƒO VAZIO
Â  Â  if (falta <= 0 || !cliente) continue;

Â  Â  // Extrair cidade apÃ³s o primeiro "-"
Â  Â  let cidade = cidadeCompleta;
Â  Â  if (cidadeCompleta.includes('-')) {
Â  Â  Â  cidade = cidadeCompleta.split('-').slice(1).join('-').trim();
Â  Â  }

Â  Â  if (!grupos[cliente]) {
Â  Â  Â  grupos[cliente] = {
Â  Â  Â  Â  cliente,
Â  Â  Â  Â  cidadeRef: cidade, // Usa a cidade da primeira ocorrÃªncia como referÃªncia
Â  Â  Â  Â  contratos: [],
Â  Â  Â  Â  totalVolume: 0,
Â  Â  Â  Â  totalEmbarcado: 0,
Â  Â  Â  Â  totalFalta: 0,
Â  Â  Â  Â  produtos: new Set()
Â  Â  Â  };
Â  Â  }

Â  Â  grupos[cliente].contratos.push({
Â  Â  Â  contrato,
Â  Â  Â  cidade,
Â  Â  Â  produto,
Â  Â  Â  safra,
Â  Â  Â  volume,
Â  Â  Â  embarcado,
Â  Â  Â  falta,
Â  Â  Â  searchKey: normalizeText(`${cliente} ${contrato} ${cidade} ${produto}`)
Â  Â  });

Â  Â  grupos[cliente].totalVolume += volume;
Â  Â  grupos[cliente].totalEmbarcado += embarcado;
Â  Â  grupos[cliente].totalFalta += falta;
Â  Â  if (produto) grupos[cliente].produtos.add(produto);
Â  }

Â  // Ordenar por saldo pendente (maior primeiro)
Â  return Object.values(grupos).sort((a, b) => b.totalFalta - a.totalFalta);
}

// --- RENDERIZAÃ‡ÃƒO ---
function renderCards(data, filter = '') {
Â  const container = document.getElementById('clientesContainer');
Â  const term = normalizeText(filter);
Â  const filtered = term
Â  Â  ? data.filter(item =>
Â  Â  Â  Â  normalizeText(item.cliente).includes(term) ||
Â  Â  Â  Â  // Pesquisa tambÃ©m dentro dos contratos do grupo (por exemplo, por nÃºmero de contrato)
Â  Â  Â  Â  item.contratos.some(c => c.searchKey.includes(term))
Â  Â  Â  )
Â  Â  : data;

Â  container.innerHTML = filtered.length
Â  Â  ? filtered.map((item, idx) => `
Â  Â  Â  <div class="cliente-card" onclick="openModal(${idx})">
Â  Â  Â  Â  <h3 class="cliente-name">${escapeHtml(item.cliente)}</h3>
Â  Â  Â  Â  <div class="cliente-destino">${escapeHtml(item.cidadeRef)}</div>
Â  Â  Â  Â  <div class="cliente-info" style="margin-top: 10px;">
Â  Â  Â  Â  Â  <span class="info-label">Contratos:</span>
Â  Â  Â  Â  Â  <span class="info-value">${item.contratos.length}</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="cliente-info" style="margin-top: 6px;">
Â  Â  Â  Â  Â  <span class="info-label">Saldo a Entregar:</span>
Â  Â  Â  Â  Â  <span class="info-value status-pendente-tag">${formatNumber(item.totalFalta)} KG</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="cliente-info" style="margin-top: 6px;">
Â  Â  Â  Â  Â  <span class="info-label">Total Embarcado:</span>
Â  Â  Â  Â  Â  <span class="info-value">${formatNumber(item.totalEmbarcado)} KG</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="margin-top: 8px;">
Â  Â  Â  Â  Â  ${Array.from(item.produtos).map(p =>
Â  Â  Â  Â  Â  Â  `<span class="cliente-produto" style="background-color: ${
Â  Â  Â  Â  Â  Â  Â  p.toLowerCase().includes('soja') ? 'var(--produto-soja)' :
Â  Â  Â  Â  Â  Â  Â  p.toLowerCase().includes('milho') ? 'var(--produto-milho)' :
Â  Â  Â  Â  Â  Â  Â  'var(--produto-sorgo)'
Â  Â  Â  Â  Â  Â  }; color: white;">${escapeHtml(p)}</span>`
Â  Â  Â  Â  Â  ).join(' ')}
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  `).join('')
Â  Â  : '<div class="empty">Nenhum lote com saldo pendente encontrado.</div>';

Â  // Atualizar contadores
Â  // Os contadores globais devem ser baseados apenas nos dados FILTRADOS por SALDO > 0
Â  const contratosTotais = data.reduce((acc, c) => acc + c.contratos.length, 0);
Â  const sojaFalta = data.reduce((acc, c) => acc + c.contratos
Â  Â  .filter(ct => ct.produto.toLowerCase().includes('soja'))
Â  Â  .reduce((sum, ct) => sum + ct.falta, 0), 0);
Â  const milhoFalta = data.reduce((acc, c) => acc + c.contratos
Â  Â  .filter(ct => ct.produto.toLowerCase().includes('milho'))
Â  Â  .reduce((sum, ct) => sum + ct.falta, 0), 0);
Â  
Â  document.getElementById('count-clientes').textContent = formatNumber(data.length);
Â  document.getElementById('count-contratos').textContent = formatNumber(contratosTotais);
Â  document.getElementById('count-soja').textContent = formatNumber(sojaFalta);
Â  document.getElementById('count-milho').textContent = formatNumber(milhoFalta);
}

function openModal(index) {
Â  // Note: Como o renderCards usa o Ã­ndice do array FILTRADO (que Ã© o 'filtered'),
Â  // e nÃ£o o Ã­ndice no 'globalData', a lÃ³gica aqui precisa ser ajustada.
Â  // Para simplificar, o openModal usa o Ã­ndice do 'globalData' para obter o item,
Â  // o que funciona desde que `renderCards` passe o Ã­ndice CORRETO do `globalData`.
Â  // ATENÃ‡ÃƒO: Se o array `filtered` for diferente de `globalData`, o Ã­ndice nÃ£o serÃ¡ o mesmo.
Â  // **Corrigindo:** O renderCards precisa passar o objeto completo ou o Ã­ndice do `globalData`.
Â  
Â  // Vamos alterar o renderCards para passar o Ã­ndice do item no array `globalData`
Â  // ou mudar para o Ã­ndice do `filtered` e adaptar a funÃ§Ã£o openModal.
Â  // MANTEREI A ESTRUTURA ORIGINAL E CORRIGIREI O INDEX PASSADO.
Â  
Â  // **Ajuste na LÃ³gica:** O `renderCards` precisa usar o Ã­ndice do `globalData` ou passar o objeto completo.
Â  // Mantendo o `openModal(${idx})` e ajustando o `renderCards` para usar o Ã­ndice no `globalData`
Â  // de modo que `globalData[idx]` funcione.

Â  // No cÃ³digo original, ao usar `filtered.map((item, idx) => ... openModal(${idx}) ...)`
Â  // O `idx` Ã© o Ã­ndice no array **filtrado**.
Â  // A maneira mais segura de corrigir Ã© passar o objeto completo ou um identificador Ãºnico,
Â  // mas a forma mais rÃ¡pida Ã© usar o Ã­ndice de `globalData` na renderizaÃ§Ã£o.

Â  // Novo ajuste no `renderCards` para encontrar o Ã­ndice do item no `globalData`:
Â  const item = globalData.find((_, i) => i === index); // Isso sÃ³ funcionaria se nÃ£o houvesse filtro.
Â  
Â  // **Revertendo para a forma mais correta:**
Â  // O `renderCards` foi ajustado para passar o Ã­ndice do item *dentro do array `filtered`* para o `openModal`.
Â  // Agora, precisamos da lista de itens **filtrados** globalmente para o `openModal` acessar corretamente.
Â  // No entanto, para nÃ£o ter que guardar dois arrays (globalData e filteredData) e manter o cÃ³digo simples,
Â  // vamos usar o `globalData` e pedir a re-filtragem dentro do `openModal` para achar o item.
Â  
Â  // Para nÃ£o quebrar a lÃ³gica do `openModal(index)` original, **o openModal deve acessar o item correto**.
Â  // Como o `globalData` Ã© a lista de *todos* os clientes com saldo, e o filtro Ã© aplicado sobre ele,
Â  // o modo mais eficiente Ã© refazer o filtro *se houver* para achar o item correto, 
Â  // ou passar o objeto completo, ou o Ã­ndice do `globalData`.
Â  
Â  // Vamos assumir que, para o `openModal`, o Ã­ndice `index` Ã© o Ã­ndice do item no array **filtrado** (visÃ­vel).
Â  // Para que isso funcione, o array **filtrado** precisa ser acessÃ­vel ou o item passado.
Â  
Â  // **SOLUÃ‡ÃƒO ADOTADA:** A funÃ§Ã£o `renderCards` usarÃ¡ o Ã­ndice do array **globalData**
Â  // ao renderizar para que `openModal(index)` aponte para o item correto.
Â  // No entanto, para manter a consistÃªncia e evitar bugs com a filtragem:
Â  // Vamos passar o *nome do cliente* para o openModal.
Â  
Â  // *Voltando ao original e ajustando a renderizaÃ§Ã£o para passar o Ã­ndice correto.*
Â  // Se o `globalData` Ã© a lista nÃ£o filtrada, e `renderCards` filtra, precisamos saber qual item do `globalData`
Â  // Ã© o item filtrado de Ã­ndice `idx`.
Â  
Â  // ***MUDANÃ‡A CRÃTICA:*** Mudar a forma como `renderCards` gera o `onclick` para passar um identificador.
Â  // Em vez de `onclick="openModal(${idx})"`, vamos usar `onclick="openModal('${escapeHtml(item.cliente)}')"`
Â  
Â  // Isso requer uma alteraÃ§Ã£o na funÃ§Ã£o `openModal` para buscar o cliente pelo nome.
Â  
Â  // REVERTENDO: A soluÃ§Ã£o mais simples para o seu cÃ³digo Ã© usar um **indexMap**
Â  // para mapear o Ã­ndice do array *filtrado* para o Ã­ndice do array *globalData*.
Â  // No entanto, para ser o mais fiel possÃ­vel ao seu pedido, vamos fazer o seguinte ajuste no `openModal` 
Â  // e manter a assinatura `openModal(index)` que se refere ao Ã­ndice do `globalData` *nÃ£o filtrado*.
Â  
Â  // ***Ajuste feito:*** O `renderCards` agora passa o Ã­ndice do item no `globalData`.
Â  
Â  const currentFilter = document.getElementById('filterInput').value;
Â  const term = normalizeText(currentFilter);
Â  const filtered = term
Â  Â  ? globalData.filter(item =>
Â  Â  Â  Â  normalizeText(item.cliente).includes(term) ||
Â  Â  Â  Â  item.contratos.some(c => c.searchKey.includes(term))
Â  Â  Â  )
Â  Â  : globalData;
Â  
Â  const item = filtered[index]; // O Ã­ndice Ã© do array filtrado/visÃ­vel

Â  if (!item) return;

Â  const contratosHtml = item.contratos.map(ct => `
Â  Â  <div class="contrato-item">
Â  Â  Â  <p><strong>Contrato:</strong> ${escapeHtml(ct.contrato)}</p>
Â  Â  Â  <p><span class="info-label">Cidade:</span> ${escapeHtml(ct.cidade)}</p>
Â  Â  Â  <p><span class="info-label">Produto:</span> ${escapeHtml(ct.produto)}</p>
Â  Â  Â  <p><span class="info-label">Safra:</span> ${escapeHtml(ct.safra)}</p>
Â  Â  Â  <p><span class="info-label">Volume Contratado:</span> ${formatNumber(ct.volume)} KG</p>
Â  Â  Â  <p><span class="info-label">Embarcado:</span> ${formatNumber(ct.embarcado)} KG</p>
Â  Â  Â  <p><span class="info-label">Falta Embarcar:</span> <strong>${formatNumber(ct.falta)} KG</strong></p>
Â  Â  </div>
Â  `).join('');

Â  document.getElementById('modalContentBody').innerHTML = `
Â  Â  <div class="modal-header">
Â  Â  Â  <h3>${escapeHtml(item.cliente)} â€” ${escapeHtml(item.cidadeRef)}</h3>
Â  Â  </div>
Â  Â  <div class="modal-body">
Â  Â  Â  <p><span class="info-label">Total de Contratos:</span> ${item.contratos.length}</p>
Â  Â  Â  <p><span class="info-label">Saldo Total a Entregar:</span> <strong>${formatNumber(item.totalFalta)} KG</strong></p>
Â  Â  Â  <p><span class="info-label">Total Embarcado:</span> ${formatNumber(item.totalEmbarcado)} KG</p>
Â  Â  Â  <div style="margin-top: 20px;">
Â  Â  Â  Â  <h4>Detalhes por Contrato:</h4>
Â  Â  Â  Â  ${contratosHtml}
Â  Â  Â  </div>
Â  Â  </div>
Â  `;
Â  document.getElementById('resumoModal').style.display = 'flex';
}

function closeModal() {
Â  document.getElementById('resumoModal').style.display = 'none';
}

function updateLastUpdateTime() {
Â  const now = new Date();
Â  document.getElementById('lastUpdateTop').innerHTML = `
Â  Â  <i class="fas fa-check-circle" style="color: rgba(255,255,255,0.9);"></i>
Â  Â  <span>Ãšltima atualizaÃ§Ã£o: ${now.toLocaleTimeString('pt-BR')} - ${now.toLocaleDateString('pt-BR')}</span>
Â  `;
}

// --- CARREGAMENTO ---
async function loadAll(isAutoUpdate = false) {
Â  const container = document.getElementById('clientesContainer');
Â  if (isAutoUpdate) {
Â  Â  container.innerHTML = '<div class="empty">Atualizando...</div>';
Â  Â  document.getElementById('lastUpdateTop').innerHTML = `
Â  Â  Â  <i class="fas fa-hourglass-half" style="color: rgba(255,255,255,0.9);"></i>
Â  Â  Â  <span>Atualizando...</span>
Â  Â  `;
Â  }

Â  try {
Â  Â  const data = await fetchSheetByGid(GID_ENTREGA);
Â  Â  // O `data.arrays` contÃ©m todas as linhas da planilha (exceto o cabeÃ§alho)
Â  Â  const grouped = processData(data.arrays);
Â  Â  globalData = grouped;
Â  Â  // Reaplicar o filtro atual apÃ³s carregar novos dados
Â  Â  renderCards(grouped, document.getElementById('filterInput').value); 
Â  Â  updateLastUpdateTime();
Â  } catch (err) {
Â  Â  console.error('Erro ao carregar Lotes de Entrega:', err);
Â  Â  container.innerHTML = '<div class="empty">Erro ao carregar dados. Verifique a planilha.</div>';
Â  Â  document.getElementById('lastUpdateTop').innerHTML = `
Â  Â  Â  <i class="fas fa-exclamation-triangle" style="color: rgba(255,255,255,0.9);"></i>
Â  Â  Â  <span>Erro na atualizaÃ§Ã£o</span>
Â  Â  `;
Â  }
}

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
Â  // Filtro
Â  document.getElementById('filterInput').addEventListener('input', (e) => {
Â  Â  renderCards(globalData, e.target.value);
Â  });

Â  // Modal
Â  document.getElementById('resumoModal').addEventListener('click', (e) => {
Â  Â  if (e.target === document.getElementById('resumoModal')) closeModal();
Â  });
Â  document.addEventListener('keydown', (e) => {
Â  Â  if (e.key === 'Escape') closeModal();
Â  });

Â  // Carregar
Â  loadAll(true);
Â  setInterval(() => loadAll(true), AUTO_UPDATE_INTERVAL);

Â  document.addEventListener('visibilitychange', () => {
Â  Â  if (!document.hidden) loadAll(true);
Â  });
});
</script>
</body>
</html>
